<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>SISKA-E (Sistem Keamanan - Elektronik)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{ 
      --muted:#6b7280; --accent:#ef4444; --safe:#16a34a; --caution:#f59e0b; --danger:#ef4444; --card-radius:12px;
      --primary: #2563eb; --secondary: #64748b; --success: #16a34a; --warning: #f59e0b; --danger: #ef4444;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body{
      background:#f4f7ff;
      font-family: 'Inter', Segoe UI, Arial, sans-serif;
      padding:16px;
      padding-bottom:80px;
      -webkit-text-size-adjust:100%;
      font-weight: 400;
      line-height: 1.6;
    }
    
    .card{
      border-radius:var(--card-radius);
      box-shadow:0 8px 30px rgba(14,30,60,0.06);
      margin-bottom:16px;
      border: none;
    }
    
    .form-control,.btn{
      border-radius:8px;
      font-family: 'Inter', sans-serif;
    }
    
    .muted{color:var(--muted);font-size:0.95rem;}
    #map, #posFormMap, #posViewMap { width:100%; height:360px; border-radius:8px; background:#eef; }
    .hidden{display:none!important;}
    
    .sos-btn{
      width:110px;height:110px;border-radius:999px;
      background:var(--accent);color:#fff;font-weight:800;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;border:none;cursor:pointer;
      box-shadow:0 12px 32px rgba(239,68,68,0.25);margin:0 auto;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .sos-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 16px 40px rgba(239,68,68,0.4);
    }
    
    @media(max-width:767px){ 
      .sos-btn{width:96px;height:96px;} 
      body{padding-bottom:160px;} 
    }
    
    .pos-photo{max-width:100%;max-height:160px;border-radius:8px;margin-top:6px;display:block;}
    .small{font-size:0.85rem;color:#555;}
    
    .kejadian-option{
      display:inline-block;margin:6px;text-align:center;cursor:pointer;
      padding:12px 8px;border-radius:12px;border:2px solid #eee;background:#fff;
      width:110px;transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .kejadian-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .kejadian-option span{display:block;margin-top:6px;font-size:0.9rem;font-weight:500;}
    .status-aman{color:var(--safe);font-weight:700}
    .status-waspada{color:var(--caution);font-weight:700}
    .status-rawan{color:var(--danger);font-weight:700}
    
    .table-sm td,.table-sm th{padding:.35rem .5rem;}
    .modal-overlay{
      position:fixed;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,.5);display:flex;align-items:center;
      justify-content:center;z-index:1200;
    }
    
    .modal-box{
      width:92%;max-width:820px;background:#fff;padding:20px;
      border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);
      overflow:auto;max-height:90vh;
    }
    
    .file-label{
      display:inline-block;padding:.45rem .6rem;border-radius:8px;
      background:#f8fafc;border:1px dashed #e5e7eb;cursor:pointer;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      max-width: 80px;
    }
    
    .nav-item.active {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
    }
    
    .nav-item i {
      font-size: 22px;
      margin-bottom: 6px;
      transition: all 0.3s ease;
    }
    
    .nav-item.sos {
      background: linear-gradient(135deg, #ef4444, #f87171);
      color: white;
    }
    
    .nav-item.sos.active {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    
    .nav-label {
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    /* Typography Improvements */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      color: #1e293b;
    }
    
    h2 {
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h5, h6 {
      font-weight: 600;
      color: #334155;
    }
    
    .subtitle {
      font-size: 0.9rem;
      color: #64748b;
      font-weight: 500;
    }
    
    /* Table Improvements */
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .table {
      margin-bottom: 0;
      font-family: 'Inter', sans-serif;
    }
    
    .table thead th {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #475569;
      padding: 12px 16px;
    }
    
    .table tbody td {
      padding: 12px 16px;
      border-color: #f1f5f9;
    }
    
    .table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    /* Pagination */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding: 12px 0;
    }
    
    .page-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background: white;
      color: #475569;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .page-btn:hover:not(:disabled) {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .page-info {
      font-weight: 600;
      color: #475569;
      font-family: 'Inter', sans-serif;
    }
    
    /* Statistik Table Fix */
    .statistik-table {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .statistik-table .table {
      font-size: 0.9rem;
    }
    
    .statistik-table .progress {
      height: 8px;
      border-radius: 4px;
    }
    
    .statistik-table .progress-bar {
      border-radius: 4px;
    }
    
    /* Report Limits */
    .report-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 8px;
    }
    
    .report-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .report-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    
    .report-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .report-container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Button Improvements */
    .btn {
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Alert Improvements */
    .alert {
      border: none;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
    }
    
    /* Semua input pendaftaran otomatis huruf besar */
    #authCard input,
    #authCard select,
    #authCard textarea {
      text-transform: uppercase;
    }

    /* Photo preview grid */
    .photo-preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .photo-preview-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }

    .photo-preview-item img {
      width: 100%;
      height: 80px;
      object-fit: cover;
    }

    .remove-photo {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(239, 68, 68, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- Extras -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="text-center mb-3">
  <h2 class="mb-1">SISKA-E</h2>
  <div class="subtitle">(Sistem Keamanan Elektronik)</div>
</div>

<!-- AUTH -->
<div id="authCard" class="card p-3">
  <!-- FORM LOGIN -->
  <div id="loginCard">
    <h5>Login</h5>
    <input id="login_hp" class="form-control mb-2" placeholder="Nomor HP (contoh: 0812...)" oninput="formatPhoneTyping(this)">
    <input id="login_pass" type="password" class="form-control mb-2" placeholder="Password">
    <div class="d-grid gap-2 mb-2">
      <button class="btn btn-primary" onclick="onLogin()">Login</button>
    </div>
    <p class="small">Belum punya akun? 
      <a href="javascript:void(0)" onclick="showRegisterForm()">Daftar di sini</a>
    </p>
  </div>

  <!-- FORM DAFTAR (disembunyikan awal) -->
  <div id="registerCard" style="display:none;">
    <h5>Pendaftaran Warga</h5>
    <input id="reg_nama" class="form-control mb-2" placeholder="Nama lengkap">
    <input id="reg_hp" class="form-control mb-2" placeholder="Nomor HP (0812...)" oninput="formatPhoneTyping(this)">
    <input id="reg_password" type="password" class="form-control mb-2" placeholder="Password ">
    <label class="form-label small">Pilih Status / Subrole</label>
    <select id="reg_status" class="form-control mb-2">
      <optgroup label="A. Kepala">
        <option value="kepala_desa">Kepala Desa</option>
        <option value="kepala_dusun">Kepala Dusun</option>
        <option value="ketua_rt_rw">Ketua RT</option>
        <option value="ketua_rt_rw">Ketua RW</option>
        <option value="kepala_keluarga">Kepala Keluarga</option>
      </optgroup>
      <optgroup label="B. Istri">
        <option value="istri">Istri</option>            
      </optgroup>
      <optgroup label="C. Anak">
        <option value="anak">Anak</option>
      </optgroup>
    </select>

    <!-- Region dropdowns -->
    <label class="form-label small">Provinsi / Kabupaten / Kecamatan / Desa / Dusun</label>
    <select id="reg_prov" class="form-control mb-1"><option value="">Pilih Provinsi</option></select>
    <select id="reg_kab" class="form-control mb-1"><option value="">Pilih Kabupaten/Kota</option></select>
    <select id="reg_kec" class="form-control mb-1"><option value="">Pilih Kecamatan</option></select>
    <select id="reg_des" class="form-control mb-1"><option value="">Pilih Desa/Kelurahan</option></select>

    <div class="row g-2 mb-2">
      <div class="col"><input id="reg_blok" class="form-control" placeholder="Blok (opsional)"></div>
      <div class="col"><input id="reg_no" class="form-control" placeholder="No Rumah (opsional)"></div>
    </div>
    <div class="row g-2 mb-2">
      <div class="col"><input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)"></div>
      <div class="col"><input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)"></div>
    </div>

    <textarea id="reg_alamat" class="form-control mb-2" placeholder="Alamat lengkap" readonly></textarea>

    <div class="d-grid gap-2">
      <button id="btnRegister" class="btn btn-success" onclick="onRegister()">Daftar</button>
    </div>
    <p class="small">Sudah punya akun? <a href="javascript:void(0)" onclick="showLoginForm()">Login di sini</a></p>
  </div>
</div>

<!-- Dashboard Content -->
<div id="dashboardCard" class="hidden">
  <!-- Home/Dashboard -->
  <div id="homePage" class="page">
    <div class="topbar d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center">
        <div>
          Selamat datang, <b id="display_name"></b> ¬∑ 
          <span id="display_role"></span> ¬∑ 
          <span id="display_status"></span>
        </div>
      </div>
      <div class="muted small">Waktu: <span id="clock"></span></div>
    </div>

    <div class="row g-3">
      <div class="col-lg-4">
        <!-- Kepala Dusun Info -->
        <div class="card p-3 mb-3">
          <h6>Informasi Dusun</h6>
          <div id="dusunInfo" class="muted">Memuat...</div>
        </div>

        <!-- Buat Dusun (hanya kepala) -->
        <div id="createDusunCard" class="card p-3 mb-3 hidden">
          <h6>Buat Dusun (Kepala)</h6>
          <input id="dusun_nama" class="form-control mb-2" placeholder="Nama Dusun">
          <div class="d-grid gap-2"><button class="btn btn-primary" onclick="createDusun()">Buat Dusun</button></div>
          <div class="muted small mt-2">Kode dusun hanya terlihat oleh Kepala Dusun yang membuatnya.</div>
          <div id="myDusunCode" class="muted small mt-2"></div>
          <div id="kodeCountdown" class="muted small mt-1"></div>
          <div class="d-flex gap-2 mt-2">
            <button id="regenKodeBtn" class="btn btn-outline-primary btn-sm hidden" onclick="regenerateKodeDusun()">Regenerate Kode</button>
            <button id="expireKodeBtn" class="btn btn-outline-danger btn-sm hidden" onclick="expireKodeNow()">Expire Kode</button>
          </div>
        </div>

        <!-- Gabung Dusun -->
        <div id="joinDusunCard" class="card p-3 mb-3 hidden">
          <h6>Gabung Dusun</h6>
          <input id="join_kode" class="form-control upper mb-2" placeholder="Masukkan Kode Dusun">
          <div class="d-grid gap-2"><button class="btn btn-success" onclick="joinDusun()">Gabung</button></div>
        </div>

        <!-- Pending (only for kepala) -->
        <div id="pendingCard" class="card p-3 mb-3 hidden">
          <h6>Pending Pendaftar</h6>
          <div id="pendingList" class="muted">Memuat...</div>
        </div>
        <div id="verificationCard" class="card p-3 mb-3 hidden">
          <h6>Verifikasi Hierarki</h6>
          <div id="pendingVerifications" class="muted">Memuat...</div>
        </div>
      </div>

      <div class="col-lg-8">
        <!-- Map -->
        <div class="card p-3 mb-3">
          <h6>Peta Pos & Dusun</h6>
          <div id="map">Memuat peta...</div>
          <div class="d-flex gap-2 mt-3">
            <button id="btnOpenPosForm" class="btn btn-outline-primary hidden" onclick="openPosForm()">Tambah Pos</button>
            <button class="btn btn-outline-secondary" onclick="loadPosList()">Muat Ulang Pos</button>
          </div>
          <div id="posList" class="mt-3"></div>
          <div class="pagination-container">
            <button id="prevPosBtn" class="page-btn" onclick="changePosPage(-1)">‚Üê Sebelumnya</button>
            <span id="pagePosInfo" class="page-info">Halaman 1</span>
            <button id="nextPosBtn" class="page-btn" onclick="changePosPage(1)">Selanjutnya ‚Üí</button>
          </div>
        </div>

        <!-- Statistik 30 hari -->
        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian (30 hari)</h6>
          <canvas id="chartKejadian" style="height:180px"></canvas>
          <div id="statSummary" class="mt-2"></div>
        </div>

        <!-- Anggota Keluarga -->
        <div class="card p-3 mb-3">
          <h6>Anggota Keluarga (Alamat Sama)</h6>
          <div id="familyList">Memuat...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistik Page -->
  <div id="statistikPage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5>Statistik Laporan Per Bulan</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <select id="filterBulanStatistik" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
        <div class="col-md-6">
          <select id="filterTahunStatistik" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
      </div>
      <canvas id="chartStatistik" style="height:300px"></canvas>
      <div id="statistikSummary" class="mt-3"></div>
    </div>
  </div>

  <!-- SOS Page -->
  <div id="sosPage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5 class="text-center">Darurat / Lapor Cepat</h5>
      <div id="kejadianGridSOS" class="mb-3 text-center"></div>
      <label class="form-label small">Lokasi Laporan</label>
      <select id="lap_loc_opt_sos" class="form-control mb-2">
        <option value="rumah">Di Rumah (alamat terdaftar)</option>
        <option value="lainnya">Di Tempat Lain</option>
      </select>
      <textarea id="lap_lokasi_sos" class="form-control mb-3 hidden" placeholder="Deskripsi alamat (jika di tempat lain)"></textarea>
      <div class="text-center">
        <button id="sosButtonBig" class="sos-btn" onclick="openSOSFromPage()">SOS</button>
      </div>
    </div>
  </div>

  <!-- Laporan Page -->
  <div id="laporanPage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5>Riwayat Laporan</h5>
      <div class="row mb-3">
        <div class="col-md-4">
          <select id="filterBulanLaporan" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
        <div class="col-md-4">
          <select id="filterTahunLaporan" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
        <div class="col-md-4">
          <select id="filterJenisLaporan" class="form-control">
            <option value="semua">Semua Laporan</option>
            <option value="saya">Laporan Saya</option>
            <option value="warga">Laporan Warga Lain</option>
          </select>
        </div>
      </div>
      
      <div id="laporanListContainer">
        <div id="laporanList" class="mb-3"></div>
        <div class="pagination-container">
          <button id="prevPageBtn" class="page-btn" onclick="changeLaporanPage(-1)">‚Üê Sebelumnya</button>
          <span id="pageInfo" class="page-info">Halaman 1</span>
          <button id="nextPageBtn" class="page-btn" onclick="changeLaporanPage(1)">Selanjutnya ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Page -->
  <div id="profilePage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5>Profile User</h5>
      <div id="profileContentPage">
        <!-- Data akan diisi oleh JavaScript -->
      </div>
      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-warning" onclick="showChangeRoleModal()">Ubah Role</button>
        <button class="btn btn-info" onclick="showChangePasswordModal()">Ubah Password</button>
        <button class="btn btn-danger" onclick="showDeleteAccountModal()">Hapus Akun</button>
        <button class="btn btn-secondary" onclick="onLogout()">Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- Pos Form Modal (inline) -->
<div id="posModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5 id="posModalTitle">Tambah Pos</h5>
    <div id="posFormArea">
      <input id="pos_name" class="form-control mb-2" placeholder="Nama Pos (mis. Pos RT01)">
      <div class="row g-2">
        <div class="col"><input id="pos_rt" class="form-control" placeholder="RT (001)"></div>
        <div class="col"><input id="pos_rw" class="form-control" placeholder="RW (001)"></div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col">
          <select id="pos_status" class="form-control">
            <option value="active">Active</option>
            <option value="pasif">Pasif</option>
          </select>
        </div>
        <div class="col">
          <select id="pos_jenis" class="form-control">
            <option value="pos_dusun">Pos Dusun</option>
            <option value="pos_rt">Pos RT</option>
          </select>
        </div>
      </div>
      <div class="mt-2">
        <label class="file-label">Pilih Foto (Maksimal 5 foto)
          <input id="pos_photo" type="file" accept="image/*" multiple style="display:none">
        </label>
        <div id="posPhotoPreview" class="photo-preview-grid mt-2"></div>
      </div>
      <div class="mt-2">
        <small class="muted">Tandai lokasi di map (tetap di halaman ini). Klik titik pada peta untuk memilih lokasi.</small>
        <div id="posFormMap" class="mt-2"></div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-success" onclick="setPosLocationFromMap()">Set Lokasi</button>
          <button class="btn btn-primary" onclick="savePosFromModal()">Simpan Pos</button>
          <button class="btn btn-outline-secondary" onclick="closePosForm()">Batal</button>
        </div>
        <div id="chosenPosCoord" class="muted small mt-2">Lokasi belum ditetapkan.</div>
      </div>
    </div>
  </div>
</div>

<!-- Pos View Modal -->
<div id="posViewModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Detail Pos</h5>
    <div id="posViewContent"></div>
    <div id="posViewMap" class="mt-2"></div>
    <div class="d-flex gap-2 mt-3 justify-content-end">
      <button class="btn btn-secondary" onclick="closePosView()">Tutup</button>
    </div>
  </div>
</div>

<!-- Modal untuk Ubah Role -->
<div id="changeRoleModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Ubah Role</h5>
    <div class="mb-3">
      <label class="form-label">Pilih Role Baru</label>
      <select id="newRole" class="form-control">
        <optgroup label="A. Kepala">
          <option value="kepala_desa">Kepala Desa</option>
          <option value="kepala_dusun">Kepala Dusun</option>
          <option value="ketua_rt_rw">Ketua RT</option>
          <option value="ketua_rt_rw">Ketua RW</option>
          <option value="kepala_keluarga">Kepala Keluarga</option>
        </optgroup>
        <optgroup label="B. Istri">
          <option value="istri">Istri</option>            
        </optgroup>
        <optgroup label="C. Anak">
          <option value="anak">Anak</option>
        </optgroup>
      </select>
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button class="btn btn-secondary" onclick="hideChangeRoleModal()">Batal</button>
      <button class="btn btn-primary" onclick="updateRole()">Simpan</button>
    </div>
  </div>
</div>

<!-- Modal untuk Ubah Password -->
<div id="changePasswordModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Ubah Password</h5>
    <div class="mb-3">
      <label class="form-label">Password Baru</label>
      <input id="newPassword" type="password" class="form-control" placeholder="Masukkan password baru">
    </div>
    <div class="mb-3">
      <label class="form-label">Konfirmasi Password</label>
      <input id="confirmPassword" type="password" class="form-control" placeholder="Konfirmasi password baru">
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button class="btn btn-secondary" onclick="hideChangePasswordModal()">Batal</button>
      <button class="btn btn-primary" onclick="updatePassword()">Simpan</button>
    </div>
  </div>
</div>

<!-- Modal untuk Hapus Akun -->
<div id="deleteAccountModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Hapus Akun</h5>
    <div class="mb-3">
      <p>Apakah Anda yakin ingin menghapus akun? Tindakan ini tidak dapat dibatalkan.</p>
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button class="btn btn-secondary" onclick="hideDeleteAccountModal()">Batal</button>
      <button class="btn btn-danger" onclick="deleteAccount()">Hapus Akun</button>
    </div>
  </div>
</div>

<!-- ================== BOTTOM NAVIGATION ================== -->
<div id="bottomNav" class="bottom-nav hidden">
  <div class="nav-item active" onclick="showPage('homePage')">
    <i class="fas fa-home"></i>
    <span class="nav-label">Home</span>
  </div>
  <div class="nav-item" onclick="showPage('statistikPage')">
    <i class="fas fa-chart-bar"></i>
    <span class="nav-label">Statistik</span>
  </div>
  <div class="nav-item sos" onclick="showPage('sosPage')">
    <i class="fas fa-exclamation-triangle"></i>
    <span class="nav-label">SOS</span>
  </div>
  <div class="nav-item" onclick="showPage('laporanPage')">
    <i class="fas fa-list"></i>
    <span class="nav-label">Laporan</span>
  </div>
  <div class="nav-item" onclick="showPage('profilePage')">
    <i class="fas fa-user"></i>
    <span class="nav-label">Profil</span>
  </div>
</div>

<script>
/* ================== CONFIG FIREBASE ================== */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.appspot.com",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.warn(e));

/* ================== GLOBAL STATE ================== */
let currentUser = null;
let currentWarga = null;
let currentDusun = null;
let mainMap = null;
let mainMarkers = null;
let posFormMap = null, posFormMarker = null;
let posViewMap = null;
let chartKej = null;
let reportsUnsub = null;
let posModalEditingId = null;
let kodeCountdownTimer = null;
let tempChosenPos = { lat:null, lng:null };

// ================== VARIABEL BARU UNTUK FITUR BARU ==================
let chartStatistik = null;
let currentMonthStatistik = new Date().getMonth() + 1;
let currentYearStatistik = new Date().getFullYear();
let currentLaporanPage = 1;
const laporanPerPage = 5;
let currentMonthLaporan = new Date().getMonth() + 1;
let currentYearLaporan = new Date().getFullYear();
let currentJenisLaporan = 'semua';

// ================== VARIABEL BARU UNTUK PAGINATION LAPORAN ==================
let currentMyReportsPage = 1;
let currentOtherReportsPage = 1;
const reportsPerPage = 3;

// ================== VARIABEL BARU UNTUK PAGINATION POS ==================
let currentPosPage = 1;
const posPerPage = 3;
let allPosData = [];

// ================== VARIABEL BARU UNTUK MULTIPLE FOTO ==================
let selectedPhotos = [];

/* ================== HELPERS ================== */
const $ = id => document.getElementById(id);
const show = id => { const e=$(id); if(e) e.classList.remove('hidden'); };
const hide = id => { const e=$(id); if(e) e.classList.add('hidden'); };
const toast = (t) => Swal.fire({title:t,icon:'success',toast:true,position:'top-end',showConfirmButton:false,timer:1400});
const err = (m) => Swal.fire('Error', m, 'error');
function formatPhoneTyping(el){ el.value = el.value.replace(/[^\d\+]/g,''); }
function normalizePhoneForKey(v){ let s=(v||"").replace(/\D/g,""); if(s.startsWith("0")) s="62"+s.substring(1); if(!s.startsWith("62")) s="62"+s; return s; }
function padRT(el){ let v=(el.value||'').replace(/\D/g,''); v=v.padStart(3,'0'); el.value=v; autofillAlamat(); }
function padRW(el){ let v=(el.value||'').replace(/\D/g,''); v=v.padStart(3,'0'); el.value=v; autofillAlamat(); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function showDashboard() {
    hide('authCard');
    show('dashboardCard');
    show('bottomNav');
}

function showAuth() {
    show('authCard');
    hide('dashboardCard');
    hide('bottomNav');
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.7) {
    return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
            resolve(file);
            return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth || height > maxHeight) {
                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(blob => {
                resolve(new File([blob], file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                }));
            }, 'image/jpeg', quality);
        };
        
        img.onerror = () => resolve(file);
        img.src = URL.createObjectURL(file);
    });
}

/* ================== AUTOFILL ALAMAT ================== */
function autofillAlamat(){
  const prov = $('reg_prov').selectedOptions[0]?.text || '';
  const kab = $('reg_kab').selectedOptions[0]?.text || '';
  const kec = $('reg_kec').selectedOptions[0]?.text || '';
  const des = $('reg_des').selectedOptions[0]?.text || '';
  const blok = $('reg_blok').value || '';
  const no = $('reg_no').value || '';
  const rt = $('reg_rt').value || '';
  const rw = $('reg_rw').value || '';
  
  // Format alamat otomatis
  let alamat = '';
  
  if (blok) alamat += 'Blok ' + blok;
  if (no) alamat += (alamat ? ' - ' : '') + 'No. ' + no;
  if (rt || rw) alamat += (alamat ? ', ' : '') + 'RT ' + (rt || '000') + ' / RW ' + (rw || '000');
  if (des) alamat += (alamat ? ', ' : '') + 'Desa ' + des;
  if (kec) alamat += (alamat ? ', ' : '') + 'Kec. ' + kec;
  if (kab) alamat += (alamat ? ', ' : '') + (kab.includes('Kota') ? kab : 'Kab. ' + kab);
  if (prov) alamat += (alamat ? ', ' : '') + 'Prov. ' + prov;
  
  $('reg_alamat').value = alamat;
}

/* ================== BOTTOM NAVIGATION & PAGES ================== */
function showPage(pageId) {
  // Sembunyikan semua pages
  document.querySelectorAll('.page').forEach(page => {
    page.classList.add('hidden');
  });
  
  // Tampilkan page yang dipilih
  document.getElementById(pageId).classList.remove('hidden');
  
  // Update active state di bottom nav
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Set active pada nav item yang sesuai
  const navMap = {
    'homePage': 0,
    'statistikPage': 1,
    'sosPage': 2,
    'laporanPage': 3,
    'profilePage': 4
  };
  
  if (navMap[pageId] !== undefined) {
    document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');
  }
  
  // Load data spesifik untuk page
  switch(pageId) {
    case 'statistikPage':
      loadStatistikData();
      break;
    case 'sosPage':
      loadKejadianOptionsSOS();
      break;
    case 'laporanPage':
      loadLaporanData();
      break;
    case 'profilePage':
      loadProfileData();
      break;
  }
}

/* ================== LOAD PROFILE DATA ================== */
function loadProfileData() {
  if (!currentWarga) return;
  
  const profileContent = document.getElementById('profileContentPage');
  if (!profileContent) return;
  
  // Ambil nama dusun dari currentDusun jika ada
  let dusunInfo = 'Belum bergabung';
  if (currentDusun && currentDusun.data) {
    dusunInfo = currentDusun.data.nama || currentWarga.data.kodeDusun || 'Belum bergabung';
  } else if (currentWarga.data.kodeDusun) {
    dusunInfo = currentWarga.data.kodeDusun;
  }
  
  profileContent.innerHTML = `
    <div class="mb-3">
      <strong>Nama:</strong> ${escapeHtml(currentWarga.data.nama || '-')}
    </div>
    <div class="mb-3">
      <strong>Nomor HP:</strong> ${escapeHtml(currentWarga.data.phone || '-')}
    </div>
    <div class="mb-3">
      <strong>Role:</strong> ${escapeHtml(currentWarga.data.role || '-')}
    </div>
    <div class="mb-3">
      <strong>Status:</strong> ${escapeHtml(currentWarga.data.status || '-')}
    </div>
    <div class="mb-3">
      <strong>Alamat:</strong> ${escapeHtml(currentWarga.data.alamat || '-')}
    </div>
    <div class="mb-3">
      <strong>RT/RW:</strong> ${escapeHtml(currentWarga.data.rt || '-')}/${escapeHtml(currentWarga.data.rw || '-')}
    </div>
    <div class="mb-3">
      <strong>Dusun:</strong> ${escapeHtml(dusunInfo)}
    </div>
  `;
}
/* ================== LOAD KEJADIAN OPTIONS SOS ================== */
function loadKejadianOptionsSOS() {
  const types = [
    { key:'Kebakaran', icon:'üî•' },
    { key:'Kemalingan', icon:'üõë' },
    { key:'Medis', icon:'üè•' },
    { key:'Ambulance', icon:'üöë' },
    { key:'Mencurigakan', icon:'üëÄ' }
  ];
  
  const container = document.getElementById('kejadianGridSOS'); 
  if (!container) return;
  
  container.innerHTML = '';
  types.forEach(t=>{
    const el = document.createElement('div'); 
    el.className='kejadian-option';
    el.innerHTML = `<div style="font-size:28px">${t.icon}</div><span>${t.key}</span>`;
    el.onclick = ()=> { 
      selectKejadianSOS(t.key, t.icon); 
    };
    container.appendChild(el);
  });
  
  window._selectedKejadian = null;
}

function selectKejadianSOS(key, icon) {
  window._selectedKejadian = key;
  const sosContainer = document.getElementById('kejadianGridSOS');
  if (!sosContainer) return;
  
  Array.from(sosContainer.querySelectorAll('.kejadian-option')).forEach(el => {
    el.style.borderColor = '#eee';
  });
  
  const found = Array.from(sosContainer.querySelectorAll('.kejadian-option')).find(el => el.innerText.includes(key));
  if (found) found.style.borderColor = '#3b82f6';
}

/* ================== LOAD STATISTIK DATA ================== */
function loadStatistikData() {
  // Implementasi load data statistik
  console.log('Loading statistik data...');
  
  // Contoh chart sederhana
  const ctx = document.getElementById('chartStatistik');
  if (!ctx) return;
  
  // Hapus chart lama jika ada
  if (window.statistikChart) {
    window.statistikChart.destroy();
  }
  
  // Buat chart baru
  window.statistikChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Kebakaran', 'Kemalingan', 'Medis', 'Ambulance', 'Mencurigakan'],
      datasets: [{
        label: 'Jumlah Laporan',
        data: [5, 3, 8, 2, 4],
        backgroundColor: ['#ef4444', '#f59e0b', '#16a34a', '#3b82f6', '#9b59b6']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}

/* ================== LOAD LAPORAN DATA ================== */
function loadLaporanData() {
  if (!currentWarga || !currentWarga.data.kodeDusun) {
    document.getElementById('laporanList').innerHTML = '<div class="muted">Anda belum bergabung dengan dusun untuk melihat laporan.</div>';
    return;
  }
  
  // Implementasi load data laporan
  console.log('Loading laporan data...');
  
  const container = document.getElementById('laporanList');
  if (!container) return;
  
  // Contoh data laporan
  container.innerHTML = `
    <div class="p-3 border rounded mb-2">
      <strong>Kebakaran</strong>
      <div class="muted small">Di Rumah - ${new Date().toLocaleDateString('id-ID')}</div>
    </div>
    <div class="p-3 border rounded mb-2">
      <strong>Medis</strong>
      <div class="muted small">Di Tempat Lain - ${new Date().toLocaleDateString('id-ID')}</div>
    </div>
    <div class="p-3 border rounded mb-2">
      <strong>Mencurigakan</strong>
      <div class="muted small">Di Rumah - ${new Date().toLocaleDateString('id-ID')}</div>
    </div>
  `;
}

/* ================== TOGGLE LOGIN/REGISTER FORM ================== */
function showLoginForm(){
  $('loginCard').style.display = 'block';
  $('registerCard').style.display = 'none';
}

function showRegisterForm(){
  $('loginCard').style.display = 'none';
  $('registerCard').style.display = 'block';
}

/* ================== CLOCK ================== */
function updateClock(){ if($('clock')) $('clock').innerText = new Date().toLocaleString(); setTimeout(updateClock,1000); }
updateClock();

/* ================== LOAD REGION DROPDOWNS ================== */
const API_REG = "https://www.emsifa.com/api-wilayah-indonesia/api/";
async function loadRegionDropdowns(){
  try{
    const res = await fetch(API_REG + 'provinces.json'); 
    const provs = await res.json();
    const provSel = $('reg_prov');
    provSel.innerHTML = '<option value="">Pilih Provinsi</option>';
    provs.forEach(p=>provSel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    
    $('reg_prov').addEventListener('change', async function(){
      $('reg_kab').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>'; 
      $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>';
      if(!this.value) { autofillAlamat(); return; }
      const r = await fetch(API_REG + 'regencies/' + this.value + '.json'); 
      const data = await r.json();
      data.forEach(k => $('reg_kab').innerHTML += `<option value="${k.id}">${k.name}</option>`);
      autofillAlamat();
    });
    
    $('reg_kab').addEventListener('change', async function(){ 
      $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; 
      if(!this.value) { autofillAlamat(); return; } 
      const r = await fetch(API_REG + 'districts/' + this.value + '.json'); 
      const data = await r.json(); 
      data.forEach(k => $('reg_kec').innerHTML += `<option value="${k.id}">${k.name}</option>`); 
      autofillAlamat(); 
    });
    
    $('reg_kec').addEventListener('change', async function(){ 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; 
      if(!this.value) { autofillAlamat(); return; } 
      const r = await fetch(API_REG + 'villages/' + this.value + '.json'); 
      const data = await r.json(); 
      data.forEach(d => $('reg_des').innerHTML += `<option value="${d.id}">${d.name}</option>`); 
      autofillAlamat(); 
    });
    
    $('reg_des').addEventListener('change', autofillAlamat);
    
    // EVENT LISTENER UNTUK INPUT MANUAL (RT, RW, BLOK, NO)
    ['reg_blok','reg_no','reg_rt','reg_rw'].forEach(id=>{ 
      const el = $(id); 
      if(el) el.addEventListener('input', autofillAlamat); 
    });
    
  }catch(e){ console.warn('Gagal load region', e); }
}

/* ================== REGISTER ================== */
async function onRegister(){
  const nama = $('reg_nama').value.trim();
  const hp = $('reg_hp').value.trim();
  const password = $('reg_password').value;
  const role = $('reg_status').value || 'warga';
  const prov = $('reg_prov').value;
  const kab = $('reg_kab').value;
  const kec = $('reg_kec').value;
  const des = $('reg_des').value;
  const provText = $('reg_prov').selectedOptions[0]?.text || '';
  const kabText = $('reg_kab').selectedOptions[0]?.text || '';
  const kecText = $('reg_kec').selectedOptions[0]?.text || '';
  const desText = $('reg_des').selectedOptions[0]?.text || '';
  const alamat = $('reg_alamat').value.trim();
  const blok = $('reg_blok').value.trim();
  const no = $('reg_no').value.trim();
  const rt = $('reg_rt').value.trim();
  const rw = $('reg_rw').value.trim();

  if(!nama || !hp || !password) return err("Lengkapi Nama, HP, Password");
  if(password.length < 6) return err("Password minimal 6 karakter");

  try{
    const norm = normalizePhoneForKey(hp);
    
    // Cek duplikasi nomor HP
    const dup = await db.collection('Warga').where('phone','==',norm).limit(1).get();
    if(!dup.empty) return err("Nomor HP sudah terdaftar");

    const email = norm + "@dusun.fake";
    const uc = await auth.createUserWithEmailAndPassword(email, password);
    const uid = uc.user.uid;

    // Generate kode referral hanya untuk kepala keluarga
    const kodeReferral = (role === 'kepala_keluarga') ? generateCode(6) : null;
    
    // Tentukan status berdasarkan role
    const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
    const status = kepalaRoles.includes(role) ? 'pending' : 'pending_referral';

    // Data untuk disimpan
    const userData = {
      nama: nama.toUpperCase(),
      phone: norm,
      role: role,
      status: status,
      provinsi: provText,
      kabupaten: kabText,
      kecamatan: kecText,
      desa: desText,
      alamat: alamat.toUpperCase(),
      blok: blok.toUpperCase(),
      no: no.toUpperCase(),
      rt: rt,
      rw: rw,
      kodeReferral: kodeReferral,
      kodeDusun: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Simpan ke Firestore
    await db.collection('Warga').doc(uid).set(userData);

    // Reset form dan logout
    $('reg_password').value = '';
    await auth.signOut();
    
    // Tampilkan sukses
    await Swal.fire({
      icon: 'success',
      title: 'Pendaftaran Berhasil',
      text: 'Silakan login menggunakan nomor HP dan password Anda'
    });
    
    // Kembali ke login
    showLoginForm();

  } catch(e){
    console.error('Register Error:', e);
    let errorMessage = 'Terjadi kesalahan saat pendaftaran';
    
    if(e.code === 'auth/email-already-in-use'){
      errorMessage = 'Nomor HP sudah terdaftar';
    } else if(e.code === 'auth/weak-password'){
      errorMessage = 'Password terlalu lemah, minimal 6 karakter';
    } else if(e.code === 'auth/invalid-email'){
      errorMessage = 'Format nomor HP tidak valid';
    } else {
      errorMessage = e.message || errorMessage;
    }
    
    Swal.fire({
      icon: 'error',
      title: 'Gagal Mendaftar',
      text: errorMessage
    });
  }
}

async function onLogin(){
  const hp = document.getElementById('login_hp').value.trim();
  const pass = document.getElementById('login_pass').value;
  
  if(!hp || !pass) return err("Nomor HP & password wajib");
  
  try{
    const norm = normalizePhoneForKey(hp);
    const email = norm + "@dusun.fake";
    
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    
    currentUser = cred.user;
    document.getElementById('login_pass').value = '';
    
    await loadProfileAndShow();
    toast("Login berhasil");
    
  }catch(e){ 
    console.error('Login Error:', e);
    
    let errorMessage = 'Login gagal';
    if(e.code === 'auth/user-not-found') {
      errorMessage = 'Nomor HP belum terdaftar';
    } else if(e.code === 'auth/wrong-password') {
      errorMessage = 'Password salah';
    } else if(e.code === 'auth/invalid-email') {
      errorMessage = 'Format nomor HP tidak valid';
    } else {
      errorMessage = e.message || errorMessage;
    }
    
    err(errorMessage);
  }
}

/* ================== AUTH STATE LISTENER ================== */
auth.onAuthStateChanged(async u => {
  if (u) {
    try {
      currentUser = u;
      // User sudah login ‚Üí langsung buka dashboard
      await loadProfileAndShow();  
    } catch (e) {
      console.warn('Auth state error:', e);
    }
  } else {
    // User belum login / sudah logout
    currentUser = null;
    currentWarga = null;
    currentDusun = null;

    // SEMBUNYIKAN BOTTOM NAV KETIKA LOGOUT
    document.getElementById('bottomNav').classList.add('hidden');
    showAuth();
  }
});

  
/* ================== LOGOUT ================== */
async function onLogout(){
  try{
    await auth.signOut();
  }catch(e){ 
    console.error(e); 
    err(e.message || String(e)); 
  }
}

/* ================== LOAD PROFILE & INIT DASHBOARD ================== */
async function loadProfileAndShow(){
  if(!auth.currentUser) return;
  const uid = auth.currentUser.uid;
  const doc = await db.collection('Warga').doc(uid).get();
  if(!doc.exists){ showAuth(); return; }
  currentWarga = { id: doc.id, data: doc.data() };
  $('display_name').innerText = currentWarga.data.nama || '';
  $('display_role').innerText = (currentWarga.data.role || '').toUpperCase();
  $('display_status').innerText = (currentWarga.data.status || '').toUpperCase();
  showDashboard();

  // Tampilkan bottom nav dan set page default ke home
  document.getElementById('bottomNav').classList.remove('hidden');
  showPage('homePage');

  // Hanya kepala_dusun yang bisa membuat dusun dan mengelola kode
  if(currentWarga.data.role === 'kepala_dusun'){
    show('createDusunCard'); 
    show('btnOpenPosForm'); 
    show('pendingCard'); 
    $('regenKodeBtn').classList.remove('hidden'); 
    $('expireKodeBtn').classList.remove('hidden');
  } else {
    hide('createDusunCard'); 
    
    // Kepala lainnya (kepala_desa, ketua_rt_rw, kepala_keluarga) hanya bisa buat pos
    const kepalaLainnya = ['kepala_desa','ketua_rt_rw','kepala_keluarga'];
    if(kepalaLainnya.includes(currentWarga.data.role)) {
      show('btnOpenPosForm');
    } else {
      hide('btnOpenPosForm');
    }
    
    hide('pendingCard'); 
    $('regenKodeBtn').classList.add('hidden'); 
    $('expireKodeBtn').classList.add('hidden');
  }

  // TAMPILKAN CARD VERIFIKASI UNTUK KEPALA YANG AKTIF
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
  if(kepalaRoles.includes(currentWarga.data.role) && currentWarga.data.status === 'aktif') {
    show('verificationCard');
    loadPendingVerifications();
  } else {
    hide('verificationCard');
  }
 
  if(currentWarga.data.kodeDusun){
    await loadDusunByCode(currentWarga.data.kodeDusun);
    loadPosList();
    loadMarkers();
    subscribeReportsForDusun(currentWarga.data.kodeDusun);
  } else {
    show('joinDusunCard');
    $('dusunInfo').innerHTML = '<div class="muted">Anda belum bergabung dengan dusun manapun.</div>';
    $('posList').innerHTML = '<div class="muted">Gabung dusun untuk melihat pos.</div>';
    renderEmptyReports();
  }

  refreshFamilyList();
  loadRegionDropdowns();
  initMainMap();
  loadPendingList();
}

/* ================== CREATE DUSUN ================== */
async function createDusun(){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') {
    return err("Hanya Kepala Dusun yang boleh membuat dusun");
  }
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
  if(!kepalaRoles.includes(currentWarga.data.role)) return err("Hanya subrole kepala boleh membuat dusun");
  const nama = $('dusun_nama').value.trim();
  if(!nama) return err("Nama dusun wajib");
  try{
    const kode = generateCode(6);
    const expiresMs = Date.now() + (60 * 60 * 1000);
    const payload = {
      nama, 
      kode,
      kepalaId: currentWarga.id,
      kepalaNama: currentWarga.data.nama,
      kepalaHp: currentWarga.data.phone || '',
      // SIMPAN DATA ALAMAT LENGKAP KEPALA DUSUN
      kepalaBlok: currentWarga.data.blok || '',
      kepalaNo: currentWarga.data.no || '',
      kepalaRt: currentWarga.data.rt || '',
      kepalaRw: currentWarga.data.rw || '',
      kepalaAlamat: currentWarga.data.alamat || '',
      kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(expiresMs),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    const docRef = await db.collection('Dusun').add(payload);
    await db.collection('Warga').doc(currentWarga.id).update({ kodeDusun: kode });
    currentWarga.data.kodeDusun = kode;
    $('dusun_nama').value = '';
    await loadDusunByCode(kode);
    loadPosList(); loadMarkers(); subscribeReportsForDusun(kode);
    toast("Dusun dibuat: " + kode);
  }catch(e){ console.error(e); err(e.message || String(e)); }
}

/* ================ REGENERATE / EXPIRE KODE ================ */
async function regenerateKodeDusun(){
  if(!currentDusun || !currentWarga) return;
  
  // Hanya kepala_dusun yang membuat kode bisa regenerate
  if(currentDusun.data.kepalaId !== currentWarga.id || currentWarga.data.role !== 'kepala_dusun') 
    return err("Hanya Kepala Dusun yang bisa regenerate kode");
  
  try{
    const newCode = generateCode(6);
    const expiresMs = Date.now() + (60*60*1000);
    await db.collection('Dusun').doc(currentDusun.id).update({ 
      kode:newCode, 
      kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(expiresMs) 
    });
    await loadDusunByCode(newCode);
    toast("Kode berhasil diganti");
  }catch(e){ console.error(e); err("Gagal regenerate kode"); }
}

async function expireKodeNow(){
  if(!currentDusun || !currentWarga) return;
  
  // Hanya kepala_dusun yang membuat kode bisa expire
  if(currentDusun.data.kepalaId !== currentWarga.id || currentWarga.data.role !== 'kepala_dusun') 
    return err("Hanya Kepala Dusun yang bisa expire kode");
  
  try{
    await db.collection('Dusun').doc(currentDusun.id).update({ 
      kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(Date.now()-1000) 
    });
    await loadDusunByCode(currentDusun.data.kode);
    toast("Kode di-expire sekarang");
  }catch(e){ console.error(e); err("Gagal expire kode"); }
}

/* ================== LOAD DUSUN BY CODE & COUNTDOWN ================== */
async function loadDusunByCode(kode){
   try{
    const snap = await db.collection('Dusun').where('kode','==',kode).limit(1).get();
    if(snap.empty){ 
      $('dusunInfo').innerHTML = '<div class="muted">Dusun tidak ditemukan.</div>'; 
      return; 
    }
    const doc = snap.docs[0]; 
    currentDusun = { id: doc.id, data: doc.data() };
    const d = currentDusun.data;
    
    // Format alamat lengkap kepala dusun
    let alamatKepala = '';
    if(d.kepalaAlamat) {
      alamatKepala = d.kepalaAlamat;
    } else if(d.kepalaBlok || d.kepalaNo) {
      alamatKepala = `${d.kepalaBlok ? 'Blok ' + d.kepalaBlok : ''}${d.kepalaNo ? (d.kepalaBlok ? ' - ' : '') + 'No. ' + d.kepalaNo : ''}`;
    }
    
    // Tampilkan informasi dusun lengkap
    $('dusunInfo').innerHTML = `
      <div class="mb-2">
        <strong>Nama Dusun:</strong><br>
        <span class="text-primary">${escapeHtml(d.nama||'-')}</span>
      </div>
      <div class="mb-2">
        <strong>Kepala Dusun:</strong><br>
        ${escapeHtml(d.kepalaNama||'-')}
      </div>
      <div class="mb-2">
        <strong>HP Kepala Dusun:</strong><br>
        ${escapeHtml(d.kepalaHp||'-')}
      </div>
      <div class="mb-2">
        <strong>Alamat Kepala Dusun:</strong><br>
        ${escapeHtml(alamatKepala||'-')}
        ${d.kepalaRt || d.kepalaRw ? `<br>RT ${d.kepalaRt||'-'} / RW ${d.kepalaRw||'-'}` : ''}
      </div>
    `;
    
    // Show kode only if current user is kepala_dusun that created it
    if(currentWarga && currentWarga.id === d.kepalaId && currentWarga.data.role === 'kepala_dusun'){
      $('myDusunCode').innerText = 'Kode dusun: ' + (d.kode||'');
      $('myDusunCode').classList.remove('hidden');
      show('createDusunCard');
      show('regenKodeBtn'); show('expireKodeBtn');
      
      const expiresTs = d.kodeExpiresAt && d.kodeExpiresAt.toMillis ? d.kodeExpiresAt.toMillis() : null;
      if(expiresTs){
        startKodeCountdown(expiresTs);
      } else {
        $('kodeCountdown').innerText = '';
        if(kodeCountdownTimer){ clearInterval(kodeCountdownTimer); kodeCountdownTimer = null; }
      }
    } else {
      $('myDusunCode').innerText = '';
      $('kodeCountdown').innerText = '';
      hide('regenKodeBtn'); hide('expireKodeBtn');
    }
    hide('joinDusunCard');
  }catch(e){ console.error(e); }
}

function startKodeCountdown(expiresAtMs){
  if(kodeCountdownTimer) clearInterval(kodeCountdownTimer);
  function update(){
    const diff = expiresAtMs - Date.now();
    if(diff <= 0){
      $('kodeCountdown').innerText = 'Kode KADALUARSA';
      clearInterval(kodeCountdownTimer);
      kodeCountdownTimer = null;
    } else {
      const h = Math.floor(diff/3600000);
      const m = Math.floor((diff%3600000)/60000);
      const s = Math.floor((diff%60000)/1000);
      $('kodeCountdown').innerText = `Sisa waktu kode: ${h}h ${m}m ${s}s`;
    }
  }
  update();
  kodeCountdownTimer = setInterval(update,1000);
}

/* ================== JOIN DUSUN ================== */
async function joinDusun(){
  const kode = ($('join_kode').value || '').trim().toUpperCase();
  if(!kode) return err("Masukkan kode dusun");
  try{
    const snap = await db.collection('Dusun').where('kode','==',kode).limit(1).get();
    if(snap.empty) return err("Kode tidak ditemukan");
    await db.collection('Warga').doc(currentWarga.id).update({ kodeDusun: kode });
    currentWarga.data.kodeDusun = kode;
    toast("Berhasil gabung ke dusun " + kode);
    $('join_kode').value = '';
    await loadDusunByCode(kode);
    loadPosList(); loadMarkers(); subscribeReportsForDusun(kode);
  }catch(e){ console.error(e); err(e.message || String(e)); }
}

/* ================== MAIN MAP & MARKERS ================== */
function initMainMap(){
  if(mainMap) return;
  mainMap = L.map('map').setView([-6.2, 106.8166], 13); // Zoom level ditingkatkan untuk load lebih cepat
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution:'¬© OpenStreetMap',
    maxZoom: 19
  }).addTo(mainMap);
  mainMarkers = L.layerGroup().addTo(mainMap);
}

async function loadMarkers(){
  if(!mainMap) initMainMap();
  mainMarkers.clearLayers();
  if(!currentWarga || !currentWarga.data.kodeDusun) return;
  try{
    const snap = await db.collection('PosDusun').where('dusunCode','==', currentWarga.data.kodeDusun).get();
    if(snap.empty) return;
    const bounds = [];
    snap.forEach(doc=>{
      const d = doc.data();
      if(d.lat && d.lng){
        const color = d.status === 'active' ? 'green' : 'red';
        const marker = L.circleMarker([d.lat, d.lng], { 
          radius:8, color, fillColor: color, fillOpacity:0.9 
        }).addTo(mainMarkers);
        let popup = `
          <div><strong>${escapeHtml(d.nama||'-')}</strong></div>
          <div class="muted small">RT/RW: ${escapeHtml(d.rt||'-')}/${escapeHtml(d.rw||'-')}</div>
          <div class="muted small">Jenis: ${escapeHtml(d.jenis||'')}</div>
          <div class="muted small">Status: ${escapeHtml(d.status||'')}</div>
          <div class="muted small">Pembuat: ${escapeHtml(d.pembuatNama||'-')}</div>`;
        if(d.fotoBase64 && d.fotoBase64.length > 0) {
          popup += `<div style="margin-top:6px"><img src="${d.fotoBase64[0]}" style="max-width:200px;border-radius:6px;"></div>`;
        }
        marker.bindPopup(popup);
        bounds.push([d.lat,d.lng]);
      }
    });
    if(bounds.length) mainMap.fitBounds(bounds,{padding:[20,20],maxZoom:16});
  }catch(e){ console.error(e); }
}

/* ================== POS FORM ================== */
function openPosForm(){
  if(!currentWarga) return err("Login dulu");
  
  // Semua kepala bisa menambah pos (kepala_dusun, kepala_desa, ketua_rt_rw, kepala_keluarga)
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
  if(!kepalaRoles.includes(currentWarga.data.role)) 
    return err("Hanya subrole kepala boleh menambah pos");
  
  posModalEditingId = null;
  selectedPhotos = [];
  $('posModalTitle').innerText = 'Tambah Pos';
  show('posModal');
  setTimeout(()=>initPosFormMap(),200);
}

function closePosForm(){
  hide('posModal');
  ['pos_name','pos_rt','pos_rw'].forEach(id=>{ if($(id)) $(id).value=''; });
  $('pos_status').value = 'active';
  $('pos_jenis').value = 'pos_dusun';
  $('posPhotoPreview').innerHTML = '';
  $('pos_photo').value = '';
  $('chosenPosCoord').innerText = 'Lokasi belum ditetapkan.';
  tempChosenPos = { lat:null, lng:null };
  selectedPhotos = [];
  if(posFormMarker){ posFormMap.removeLayer(posFormMarker); posFormMarker=null; }
  if(posFormMap){ posFormMap.setView([-6.2,106.8166], 13); }
  delete $('posModal').dataset.editingId;
}

function initPosFormMap(){
  if(posFormMap) return;
  posFormMap = L.map('posFormMap').setView([-6.2,106.8166], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution:'¬© OpenStreetMap',
    maxZoom: 19
  }).addTo(posFormMap);
  posFormMap.on('click', function(e){
    tempChosenPos.lat = e.latlng.lat; tempChosenPos.lng = e.latlng.lng;
    if(posFormMarker) posFormMap.removeLayer(posFormMarker);
    posFormMarker = L.marker([tempChosenPos.lat, tempChosenPos.lng]).addTo(posFormMap);
    $('chosenPosCoord').innerText = `Terpilih: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}`;
  });

  $('pos_photo').addEventListener('change', function(e){
    const files = Array.from(e.target.files);
    
    // Validasi jumlah file
    if (selectedPhotos.length + files.length > 5) {
      err("Maksimal 5 foto yang dapat diupload");
      this.value = '';
      return;
    }
    
    files.forEach(file => {
      // Validasi ukuran file
      if(file.size > 10 * 1024 * 1024) {
        err("Ukuran foto terlalu besar! Maksimal 10MB");
        return;
      }
      
      // Validasi tipe file
      if(!file.type.startsWith('image/')) {
        err("File harus berupa gambar!");
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        selectedPhotos.push({
          file: file,
          url: e.target.result
        });
        updatePhotoPreview();
      };
      reader.readAsDataURL(file);
    });
    
    this.value = '';
  });
}

function updatePhotoPreview() {
  const preview = document.getElementById('posPhotoPreview');
  preview.innerHTML = '';
  
  selectedPhotos.forEach((photo, index) => {
    const item = document.createElement('div');
    item.className = 'photo-preview-item';
    item.innerHTML = `
      <img src="${photo.url}" alt="Preview">
      <button type="button" class="remove-photo" onclick="removePhoto(${index})">√ó</button>
    `;
    preview.appendChild(item);
  });
}

function removePhoto(index) {
  selectedPhotos.splice(index, 1);
  updatePhotoPreview();
}

function setPosLocationFromMap(){
  if(!tempChosenPos.lat || !tempChosenPos.lng) return err("Pilih titik di peta terlebih dahulu");
  $('chosenPosCoord').innerText = `Lokasi ditetapkan: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}`;
  toast("Lokasi pos telah ditetapkan");
}

async function savePosFromModal(){
  const editingId = $('posModal').dataset.editingId || null;
  if(editingId) { return updatePos(editingId); }
  return savePosNew();
}

async function savePosNew(){
  if(!currentWarga) return err("Login dulu");
  const name = $('pos_name').value.trim();
  const rt = $('pos_rt').value.trim();
  const rw = $('pos_rw').value.trim();
  const status = $('pos_status').value;
  const jenis = $('pos_jenis').value;
  
  if(!name || !rt || !rw) return err("Isi semua field");
  if(selectedPhotos.length === 0) return err("Upload minimal 1 foto pos");
  if(!tempChosenPos.lat || !tempChosenPos.lng) return err("Tentukan lokasi pos pada peta");

  try{
    Swal.fire({ 
      title: 'Mengompresi dan mengupload foto...', 
      didOpen: () => Swal.showLoading(),
      allowOutsideClick: false
    });

    // Kompresi semua foto dan konversi ke Base64
    const compressedPhotos = [];
    for (const photo of selectedPhotos) {
      const compressedFile = await compressImage(photo.file, 400, 300, 0.6);
      const base64String = await fileToBase64(compressedFile);
      compressedPhotos.push(base64String);
    }

    Swal.close();

    // Simpan Base64 langsung ke Firestore
    const payload = {
      nama: name, rt, rw, status, jenis, 
      fotoBase64: compressedPhotos,
      fotoNames: selectedPhotos.map(p => p.file.name),
      pembuatId: currentWarga.id, 
      pembuatNama: currentWarga.data.nama,
      lat: tempChosenPos.lat, 
      lng: tempChosenPos.lng,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      dusunCode: currentWarga.data.kodeDusun || null
    };
    
    await db.collection('PosDusun').add(payload);
    toast("Pos tersimpan!");
    closePosForm();
    loadPosList();
    loadMarkers();
    
  }catch(e){ 
    console.error(e); 
    Swal.close(); 
    err("Gagal simpan pos"); 
  }
}

async function updatePos(id){
  if(!currentWarga) return err("Login dulu");
  try{
    const docRef = db.collection('PosDusun').doc(id);
    const docSnap = await docRef.get();
    if(!docSnap.exists) return err("Pos tidak ditemukan");
    const d = docSnap.data();
    const name = $('pos_name').value.trim();
    const rt = $('pos_rt').value.trim();
    const rw = $('pos_rw').value.trim();
    const status = $('pos_status').value;
    const jenis = $('pos_jenis').value;
    
    let fotoBase64 = d.fotoBase64 || [];
    let fotoNames = d.fotoNames || [];
    
    if(selectedPhotos.length > 0){
      // Kompresi dan konversi ke Base64 untuk foto baru
      const compressedPhotos = [];
      const compressedNames = [];
      for (const photo of selectedPhotos) {
        const compressedFile = await compressImage(photo.file, 400, 300, 0.6);
        const base64String = await fileToBase64(compressedFile);
        compressedPhotos.push(base64String);
        compressedNames.push(photo.file.name);
      }
      fotoBase64 = compressedPhotos;
      fotoNames = compressedNames;
    }
    
    await docRef.update({
      nama: name, rt, rw, status, jenis, 
      fotoBase64: fotoBase64,
      fotoNames: fotoNames,
      lat: tempChosenPos.lat || d.lat || null, 
      lng: tempChosenPos.lng || d.lng || null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    toast("Pos diperbarui");
    delete $('posModal').dataset.editingId;
    closePosForm(); 
    loadPosList(); 
    loadMarkers();
  }catch(e){ console.error(e); err("Gagal update pos"); }
}

/* ================== LOAD POS LIST ================== */
async function loadPosList(){
  if(!currentWarga || !currentWarga.data.kodeDusun){ 
    $('posList').innerHTML = '<div class="muted">Gabung dusun untuk melihat daftar pos.</div>'; 
    return; 
  }
  try{
    const snap = await db.collection('PosDusun').where('dusunCode','==', currentWarga.data.kodeDusun).get();
    allPosData = [];
    snap.forEach(doc => allPosData.push({ id: doc.id, data: doc.data() }));
    allPosData.sort((a,b)=>{
      const ta = a.data.createdAt ? a.data.createdAt.seconds || 0 : 0;
      const tb = b.data.createdAt ? b.data.createdAt.seconds || 0 : 0;
      return tb - ta;
    });
    
    renderPosPagination();
    
  }catch(e){ console.error(e); $('posList').innerHTML = '<div class="muted">Gagal muat pos</div>'; }
}

function renderPosPagination() {
  const startIndex = (currentPosPage - 1) * posPerPage;
  const paginatedData = allPosData.slice(startIndex, startIndex + posPerPage);
  const totalPages = Math.ceil(allPosData.length / posPerPage);
  
  let html = '';
  if (paginatedData.length === 0) {
    html = '<div class="muted">Belum ada pos.</div>';
  } else {
    paginatedData.forEach(item => {
      const d = item.data; 
      const id = item.id;
      
      // Format status dan jenis
      const statusText = d.status === 'active' ? 'AKTIF' : 'PASIF';
      const statusClass = d.status === 'active' ? 'status-aman' : 'status-rawan';
      const jenisText = d.jenis === 'pos_dusun' ? 'Pos Dusun' : 'Pos RT';
      
      html += `
        <div class="p-3 border rounded mb-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h6 class="mb-1 text-primary">${escapeHtml(d.nama)}</h6>
              <div class="small text-muted mb-1">
                <span class="me-3">RT/RW: ${escapeHtml(d.rt||'-')}/${escapeHtml(d.rw||'-')}</span>
                <span class="me-3">Jenis: ${jenisText}</span>
                <span class="${statusClass}">Status: ${statusText}</span>
              </div>
              <div class="small text-muted">
                Pembuat: ${escapeHtml(d.pembuatNama||'-')}
              </div>
            </div>
            <div class="ms-2">
              <button class="btn btn-sm btn-outline-primary" onclick="viewPos('${id}')">Detail</button>`;
      
      if(currentWarga.data.role === 'kepala_dusun') 
        html += ` 
          <button class="btn btn-sm btn-outline-warning" onclick="editPos('${id}')">Edit</button> 
          <button class="btn btn-sm btn-outline-danger" onclick="deletePos('${id}')">Hapus</button>`;
      
      html += `</div></div>`;
      
      // Tampilkan foto thumbnail jika ada
      if(d.fotoBase64 && d.fotoBase64.length > 0) {
        html += `
          <div class="mt-2">
            <img src="${d.fotoBase64[0]}" style="max-width:200px; max-height:120px; border-radius:6px; border:1px solid #eee;" 
                 onclick="viewPos('${id}')" style="cursor:pointer" title="Klik untuk lihat detail">
          </div>`;
      }
      
      html += `</div>`;
    });
  }
  
  $('posList').innerHTML = html;
  $('pagePosInfo').textContent = `Halaman ${currentPosPage} dari ${totalPages || 1}`;
  $('prevPosBtn').style.visibility = currentPosPage > 1 ? 'visible' : 'hidden';
  $('nextPosBtn').style.visibility = currentPosPage < totalPages ? 'visible' : 'hidden';
}

function changePosPage(direction) {
  const totalPages = Math.ceil(allPosData.length / posPerPage);
  const newPage = currentPosPage + direction;
  
  if (newPage >= 1 && newPage <= totalPages) {
    currentPosPage = newPage;
    renderPosPagination();
  }
}

/* ================== VIEW / EDIT / DELETE POS ================== */
async function viewPos(id){
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(!doc.exists) return err("Pos tidak ditemukan");
    const d = doc.data();
    
    // Format status dan jenis untuk tampilan lebih baik
    const statusText = d.status === 'active' ? 'AKTIF' : 'PASIF';
    const statusClass = d.status === 'active' ? 'status-aman' : 'status-rawan';
    const jenisText = d.jenis === 'pos_dusun' ? 'Pos Dusun' : 'Pos RT';
    
    let fotoHtml = '';
    if(d.fotoBase64 && d.fotoBase64.length > 0) {
      fotoHtml = `
        <div class="mt-3">
          <strong>Foto Pos:</strong>
          <div class="photo-preview-grid mt-2">`;
      d.fotoBase64.forEach((foto, index) => {
        fotoHtml += `<img src="${foto}" style="max-width:100%; border-radius:6px; border:1px solid #ddd;">`;
      });
      fotoHtml += `</div></div>`;
    }
    
    const html = `
      <div class="mb-3">
        <h6 class="text-primary">${escapeHtml(d.nama||'-')}</h6>
      </div>
      
      <div class="row mb-2">
        <div class="col-6">
          <strong>RT/RW:</strong><br>
          ${escapeHtml(d.rt||'-')} / ${escapeHtml(d.rw||'-')}
        </div>
        <div class="col-6">
          <strong>Jenis Pos:</strong><br>
          ${jenisText}
        </div>
      </div>
      
      <div class="row mb-2">
        <div class="col-6">
          <strong>Status:</strong><br>
          <span class="${statusClass}">${statusText}</span>
        </div>
        <div class="col-6">
          <strong>Pembuat:</strong><br>
          ${escapeHtml(d.pembuatNama||'-')}
        </div>
      </div>
      
      <div class="mb-2">
        <strong>Koordinat:</strong><br>
        ${d.lat ? `${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}` : 'Tidak tersedia'}
      </div>
      
      ${fotoHtml}
      
      <div class="mt-3 small muted">
        <div>Dibuat: ${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : '-'}</div>
        ${d.updatedAt ? `<div>Diupdate: ${new Date(d.updatedAt.seconds*1000).toLocaleString()}</div>` : ''}
      </div>`;
    
    $('posViewContent').innerHTML = html;
    show('posViewModal');
    setTimeout(()=>{ initPosViewMap(d.lat,d.lng); }, 200);
  }catch(e){ console.error(e); err("Gagal tampilkan pos"); }
}

function closePosView(){ 
  hide('posViewModal'); 
  if(posViewMap){ 
    posViewMap.remove(); 
    posViewMap=null; 
  } 
}

function initPosViewMap(lat,lng){
  if(posViewMap) posViewMap.remove();
  posViewMap = L.map('posViewMap').setView([lat||-6.2, lng||106.8166], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ 
    attribution:'¬© OpenStreetMap',
    maxZoom: 19
  }).addTo(posViewMap);
  if(lat && lng) L.marker([lat,lng]).addTo(posViewMap);
}

async function editPos(id){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') return err("Hanya Kepala Dusun boleh edit pos");
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(!doc.exists) return err("Pos tidak ditemukan");
    const d = doc.data();
    $('pos_name').value = d.nama || '';
    $('pos_rt').value = d.rt || '';
    $('pos_rw').value = d.rw || '';
    $('pos_status').value = d.status || 'active';
    $('pos_jenis').value = d.jenis || 'pos_dusun';
    
    // Reset selected photos dan load existing photos
    selectedPhotos = [];
    if(d.fotoBase64 && d.fotoBase64.length > 0) {
      $('posPhotoPreview').innerHTML = '<div class="muted small">Foto sebelumnya tersimpan</div>';
    } else {
      $('posPhotoPreview').innerHTML = '';
    }
    
    tempChosenPos.lat = d.lat || null; tempChosenPos.lng = d.lng || null;
    $('chosenPosCoord').innerText = tempChosenPos.lat ? 
      `Terpilih: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}` : 
      'Lokasi belum ditetapkan.';
    $('posModal').dataset.editingId = id;
    $('posModalTitle').innerText = 'Edit Pos';
    show('posModal'); 
    setTimeout(()=>{ 
      initPosFormMap(); 
      if(tempChosenPos.lat && tempChosenPos.lng){ 
        if(posFormMarker) posFormMap.removeLayer(posFormMarker); 
        posFormMarker = L.marker([tempChosenPos.lat,tempChosenPos.lng]).addTo(posFormMap); 
        posFormMap.setView([tempChosenPos.lat,tempChosenPos.lng],15); 
      } 
    },200);
  }catch(e){ console.error(e); err("Gagal edit pos"); }
}

async function deletePos(id){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') return err("Hanya Kepala Dusun boleh hapus pos");
  const conf = await Swal.fire({ 
    title:'Hapus pos?', 
    text:'Data akan dihapus permanen', 
    icon:'warning', 
    showCancelButton:true 
  });
  if(!conf.isConfirmed) return;
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(doc.exists){
      await db.collection('PosDusun').doc(id).delete();
      toast("Pos dihapus");
      loadPosList(); loadMarkers();
    } else err("Pos tidak ditemukan");
  }catch(e){ console.error(e); err("Gagal hapus pos"); }
}

/* ================== SOS PAGE - DENGAN DUPLIKASI CHECK ================== */
let lastSOSClick = 0;
let sosClickCount = 0;

async function openSOSFromPage() {
  const now = Date.now();
  
  // Reset click count jika lebih dari 2 detik sejak klik terakhir
  if (now - lastSOSClick > 2000) {
    sosClickCount = 0;
  }
  
  sosClickCount++;
  lastSOSClick = now;
  
  // Jika diklik 2x dalam 2 detik
  if (sosClickCount === 2) {
    sosClickCount = 0;
    
    // Cek duplikasi laporan hari ini
    const jenis = window._selectedKejadian;
    if (!jenis) {
      err("Pilih jenis kejadian terlebih dahulu");
      return;
    }
    
    const today = new Date();
    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
    
    try {
      const existingReports = await db.collection('Laporan')
        .where('userId', '==', currentWarga.id)
        .where('jenis', '==', jenis)
        .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
        .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(endOfDay))
        .get();
      
      if (!existingReports.empty) {
        await Swal.fire({
          title: 'Peringatan',
          html: `Anda sudah melaporkan kejadian <strong>${jenis}</strong> hari ini.<br><br>
                 <small class="text-muted">Laporan duplikat tidak akan dikirim.</small>`,
          icon: 'warning',
          confirmButtonText: 'Mengerti'
        });
        return;
      }
    } catch (error) {
      console.error('Error checking duplicate reports:', error);
    }
  }
  
  // Lanjutkan dengan proses SOS normal
  const jenis = window._selectedKejadian;
  if (!jenis) {
    err("Pilih jenis kejadian terlebih dahulu");
    return;
  }
  
  const locOpt = document.getElementById('lap_loc_opt_sos').value;
  let desc = null;
  
  if (locOpt === 'lainnya') {
    const lokasiInput = document.getElementById('lap_lokasi_sos').value.trim();
    if (!lokasiInput) {
      err("Harap isi deskripsi lokasi");
      return;
    }
    desc = lokasiInput;
  }
  
  // Cek apakah user sudah bergabung dengan dusun
  if(!currentWarga || !currentWarga.data.kodeDusun) {
    err("Anda belum bergabung ke dusun. Silakan gabung dusun terlebih dahulu untuk membuat laporan.");
    return;
  }
  
  // Lanjutkan dengan proses SOS
  let lat=null,lng=null;
  try{
    if(navigator.geolocation){
      const pos = await new Promise((res,rej)=> 
        navigator.geolocation.getCurrentPosition(res,rej,{ timeout:10000 })
      );
      lat = pos.coords.latitude; lng = pos.coords.longitude;
    }
  }catch(e){ console.warn('gps denied'); }
  
  try{
    await db.collection('Laporan').add({
      jenis, lokasiDeskripsi: desc || null, tempat: locOpt, lat, lng,
      userId: currentWarga.id, userNama: currentWarga.data.nama, dusunCode: currentWarga.data.kodeDusun,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'open'
    });
    toast("Laporan terkirim!");
    subscribeReportsForDusun(currentWarga.data.kodeDusun);
    
    // Reset form setelah berhasil
    document.querySelectorAll('.kejadian-option').forEach(el => {
      el.style.borderColor = '#eee';
    });
    window._selectedKejadian = null;
    document.getElementById('lap_lokasi_sos').value = '';
    document.getElementById('lap_loc_opt_sos').value = 'rumah';
    document.getElementById('lap_lokasi_sos').classList.add('hidden');
    
  }catch(e){ console.error(e); err("Gagal kirim laporan"); }
}

/* ================== REPORTS ================== */
let reportsCache = [];
function subscribeReportsForDusun(kodeDusun){
  if(reportsUnsub) reportsUnsub();
  if(!kodeDusun) { renderEmptyReports(); return; }
  const since = new Date(Date.now() - 90*24*60*60*1000);
  reportsUnsub = db.collection('Laporan').where('dusunCode','==', kodeDusun).onSnapshot(snapshot=>{
    reportsCache = [];
    snapshot.forEach(doc => {
      const d = doc.data();
      if(d.createdAt && d.createdAt.toDate && d.createdAt.toDate() < since) return;
      reportsCache.push({ id: doc.id, data: d });
    });
    reportsCache.sort((a,b)=>{
      const ta = a.data.createdAt ? (a.data.createdAt.seconds || 0) : 0;
      const tb = b.data.createdAt ? (b.data.createdAt.seconds || 0) : 0;
      return tb - ta;
    });
    renderStatsFromCache();
  }, e=>console.error(e));
}

function renderEmptyReports(){ 
  // Kosongkan karena laporan dipindah ke menu Laporan
}

/* ================== UTILS ================== */
function generateCode(len=6){ 
  return Math.random().toString(36).substring(2,2+len).toUpperCase(); 
}

// Tambahkan event listener untuk lokasi SOS
document.addEventListener('DOMContentLoaded', function() {
  // Event listener untuk lokasi SOS
  const lapLocOptSos = document.getElementById('lap_loc_opt_sos');
  const lapLokasiSos = document.getElementById('lap_lokasi_sos');
  
  if (lapLocOptSos && lapLokasiSos) {
    lapLocOptSos.addEventListener('change', function() {
      lapLokasiSos.classList.toggle('hidden', this.value === 'rumah');
    });
  }
});

/* ================== INITIAL LOAD ================== */
(async function init(){
  try{
    loadRegionDropdowns();
    initMainMap();
    const dSnap = await db.collection('Dusun').limit(1).get();
    if(dSnap.empty){
      const kode = 'DUSUN' + generateCode(3);
      await db.collection('Dusun').add({ 
        nama:'Dusun Demo', 
        kode, 
        desa:'Desaku', 
        kepalaNama:'Budi Demo', 
        kepalaHp:'081200000', 
        kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(Date.now()+3600*1000), 
        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
      });
    }
  }catch(e){ console.warn(e); }
})();

</script>
</body>
</html>
