<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>SISKA-E (Sistem Keamanan - Elektronik) (Perbaikan Index/CORS/Countdown)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>

      /* Sidebar Styles */
.nav .btn {
    border: 1px solid #dee2e6;
    padding: 12px 15px;
    text-align: left;
    width: 100%;
    transition: all 0.3s ease;
}

.nav .btn:hover {
    background-color: #e9ecef;
    border-color: #007bff;
}

.nav .btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.nav .btn i {
    width: 20px;
    text-align: center;
}

    /* Sidebar Mobile */
@media (max-width: 768px) {
  .sidebar-container {
    position: fixed;
    left: -100%;
    top: 0;
    width: 280px;
    height: 100vh;
    z-index: 1050;
    transition: left 0.3s ease;
    background: white;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  }
  
  .sidebar-container.sidebar-open {
    left: 0;
  }
  
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1040;
  }
  
  .sidebar-overlay.show {
    display: block;
  }
}
  
    /* Semua input pendaftaran otomatis huruf besar */
#authCard input,
#authCard select,
#authCard textarea {
  text-transform: uppercase;
}

    :root{ --muted:#6b7280; --accent:#ef4444; --safe:#16a34a; --caution:#f59e0b; --danger:#ef4444; --card-radius:12px; }
    body{background:#f4f7ff;font-family:Inter,Segoe UI,Arial,sans-serif;padding:16px;-webkit-text-size-adjust:100%;}
    .card{border-radius:var(--card-radius);box-shadow:0 8px 30px rgba(14,30,60,0.06);margin-bottom:16px;}
    .form-control,.btn{border-radius:8px;}
    .muted{color:var(--muted);font-size:0.95rem;}
    #map, #posFormMap, #posViewMap { width:100%; height:360px; border-radius:8px; background:#eef; }
    .hidden{display:none!important;}
    .sos-btn{width:110px;height:110px;border-radius:999px;background:var(--accent);color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;font-size:18px;border:none;cursor:pointer;box-shadow:0 12px 32px rgba(239,68,68,0.25);margin:0 auto;}
    @media(max-width:767px){ .sos-btn{width:96px;height:96px;position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:999;} body{padding-bottom:160px;} }
    .pos-photo{max-width:100%;max-height:160px;border-radius:8px;margin-top:6px;display:block;}
    .small{font-size:0.85rem;color:#555;}
    .kejadian-option{display:inline-block;margin:6px;text-align:center;cursor:pointer;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff;width:110px;}
    .kejadian-option span{display:block;margin-top:6px;font-size:0.9rem;}
    .status-aman{color:var(--safe);font-weight:700}.status-waspada{color:var(--caution);font-weight:700}.status-rawan{color:var(--danger);font-weight:700}
    .table-sm td,.table-sm th{padding:.35rem .5rem;}
    .modal-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1200;}
    .modal-box{width:92%;max-width:820px;background:#fff;padding:14px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:auto;max-height:90vh;}
    .file-label{display:inline-block;padding:.45rem .6rem;border-radius:8px;background:#f8fafc;border:1px dashed #e5e7eb;cursor:pointer;}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- Extras -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body>
<div class="text-center mb-3">
  <h2 class="mb-1">SISKA-E</h2>
  <div class="subtitle">(Sistem Keamanan Elektronik)</div>
</div>

  

    <!-- AUTH -->
  <div id="authCard" class="card p-3">

    <!-- Profile Modal -->
<div id="profileModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Profile User</h5>
    <div id="profileContent">
      <!-- Data akan diisi oleh JavaScript -->
    </div>
    <div class="d-flex gap-2 mt-3 justify-content-end">
      <button class="btn btn-secondary" onclick="closeProfile()">Tutup</button>
    </div>
  </div>
</div>

    
    <!-- FORM LOGIN -->
    <div id="loginCard">
      <h5>Login</h5>
      <input id="login_hp" class="form-control mb-2" placeholder="Nomor HP (contoh: 0812...)" oninput="formatPhoneTyping(this)">
      <input id="login_pass" type="password" class="form-control mb-2" placeholder="Password">
      <div class="d-grid gap-2 mb-2">
        <button class="btn btn-primary" onclick="onLogin()">Login</button>
      </div>
     <p class="small">Belum punya akun? 
  <a href="javascript:void(0)" onclick="showRegisterForm()">Daftar di sini</a>
</p>
    </div>

    <!-- FORM DAFTAR (disembunyikan awal) -->
    <div id="registerCard" style="display:none;">
      <h5>Pendaftaran Warga</h5>
      <input id="reg_nama" class="form-control mb-2" placeholder="Nama lengkap">
      <input id="reg_hp" class="form-control mb-2" placeholder="Nomor HP (0812...)" oninput="formatPhoneTyping(this)">
      <input id="reg_password" type="password" class="form-control mb-2" placeholder="Password ">
      <label class="form-label small">Pilih Status / Subrole</label>
      <select id="reg_status" class="form-control mb-2">
        <optgroup label="A. Kepala">
          <option value="kepala_desa">Kepala Desa</option>
          <option value="kepala_dusun">Kepala Dusun</option>
          <option value="ketua_rt_rw">Ketua RT</option>
          <option value="ketua_rt_rw">Ketua RW</option>
          <option value="kepala_keluarga">Kepala Keluarga</option>
        </optgroup>
        <optgroup label="B. Istri">
          <option value="istri">Istri</option>            
        </optgroup>
        <optgroup label="C. Anak">
          <option value="anak">Anak</option>
        </optgroup>
      </select>

      <!-- Region dropdowns -->
      <label class="form-label small">Provinsi / Kabupaten / Kecamatan / Desa / Dusun</label>
      <select id="reg_prov" class="form-control mb-1"><option value="">Pilih Provinsi</option></select>
      <select id="reg_kab" class="form-control mb-1"><option value="">Pilih Kabupaten/Kota</option></select>
      <select id="reg_kec" class="form-control mb-1"><option value="">Pilih Kecamatan</option></select>
      <select id="reg_des" class="form-control mb-1"><option value="">Pilih Desa/Kelurahan</option></select>

      <div class="row g-2 mb-2">
        <div class="col"><input id="reg_blok" class="form-control" placeholder="Blok (opsional)"></div>
        <div class="col"><input id="reg_no" class="form-control" placeholder="No Rumah (opsional)"></div>
      </div>
      <div class="row g-2 mb-2">
        <div class="col"><input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)"></div>
        <div class="col"><input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)"></div>
      </div>

      <textarea id="reg_alamat" class="form-control mb-2" placeholder="Alamat lengkap"></textarea>

      <div class="d-grid gap-2">
        <button id="btnRegister" class="btn btn-success" onclick="onRegister()">Daftar</button>
      </div>
      <p class="small">Sudah punya akun? <a href="javascript:void(0)" onclick="showLoginForm()">Login di sini</a></p>
    </div>

  </div>

  <!-- Dashboard -->
  <div id="dashboardCard" class="card p-3 hidden">
   <div class="row">
    <!-- Sidebar -->
    <div class="col-lg-3 col-md-4 mb-3">
      <div class="card">
        <div class="card-body">
          <div class="col-lg-3 col-md-4 mb-3 sidebar-container">
          <!-- User Info -->
          <div class="text-center mb-4">
            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" 
                 style="width: 80px; height: 80px;">
              <i class="fas fa-user text-white fa-2x"></i>
            </div>
            <h5 class="mt-2 mb-1" id="sidebar_name"></h5>
            <small class="text-muted" id="sidebar_role"></small>
          </div>

          <!-- Menu Items -->
          <div class="nav flex-column">
                    <button class="btn btn-outline-primary text-start mb-2" onclick="showProfile()">
              <i class="fas fa-user me-2"></i>Profile
            </button>
            <button class="btn btn-outline-primary text-start mb-2" onclick="showChangePassword()">
              <i class="fas fa-key me-2"></i>Ganti Password
            </button>
            <button class="btn btn-outline-danger text-start mb-2" onclick="onLogout()">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>
      <!-- Main Content -->
<div class="col-lg-9 col-md-8">
  <div class="topbar d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
      <!-- TOMBOL HAMBURGER -->
      
      <div>
      
          Selamat datang, <b id="display_name"></b> · 
      <span id="display_role"></span> · 
      <span id="display_status"></span>
    </div>
        <div class="muted small">Waktu: <span id="clock"></span></div>
      </div>
    </div>
   

    <div class="row g-3">
      <div class="col-lg-4">
        <!-- Kepala Dusun Info -->
        <div class="card p-3 mb-3">
          <h6>Informasi Dusun</h6>
          <div id="dusunInfo" class="muted">Memuat...</div>
        </div>

        <!-- SOS card (jenis kejadian + lokasi + sos button) -->
        <div class="card p-3 mb-3">
          <h6>Darurat / Lapor Cepat</h6>
          <div id="kejadianGrid" class="mb-2"></div>
          <label class="form-label small">Lokasi Laporan</label>
          <select id="lap_loc_opt" class="form-control mb-2">
            <option value="rumah">Di Rumah (alamat terdaftar)</option>
            <option value="lainnya">Di Tempat Lain</option>
          </select>
          <textarea id="lap_lokasi" class="form-control mb-2 hidden" placeholder="Deskripsi alamat (jika di tempat lain!"></textarea>
          <div class="centered mt-2"><button id="sosButton" class="sos-btn" onclick="openSOS()">SOS</button></div>
        </div>

        <!-- Buat Dusun (hanya kepala) -->
        <div id="createDusunCard" class="card p-3 mb-3 hidden">
          <h6>Buat Dusun (Kepala)</h6>
          <input id="dusun_nama" class="form-control mb-2" placeholder="Nama Dusun">
          <div class="d-grid gap-2"><button class="btn btn-primary" onclick="createDusun()">Buat Dusun</button></div>
          <div class="muted small mt-2">Kode dusun hanya terlihat oleh Kepala Dusun yang membuatnya.</div>
          <div id="myDusunCode" class="muted small mt-2"></div>
          <div id="kodeCountdown" class="muted small mt-1"></div>
          <div class="d-flex gap-2 mt-2">
            <button id="regenKodeBtn" class="btn btn-outline-primary btn-sm hidden" onclick="regenerateKodeDusun()">Regenerate Kode</button>
            <button id="expireKodeBtn" class="btn btn-outline-danger btn-sm hidden" onclick="expireKodeNow()">Expire Kode</button>
          </div>
        </div>

        <!-- Gabung Dusun -->
        <div id="joinDusunCard" class="card p-3 mb-3 hidden">
          <h6>Gabung Dusun</h6>
          <input id="join_kode" class="form-control upper mb-2" placeholder="Masukkan Kode Dusun">
          <div class="d-grid gap-2"><button class="btn btn-success" onclick="joinDusun()">Gabung</button></div>
        </div>

        <!-- Pending (only for kepala) -->
        <div id="pendingCard" class="card p-3 mb-3 hidden">
          <h6>Pending Pendaftar</h6>
          <div id="pendingList" class="muted">Memuat...</div>
        </div>
        <div id="verificationCard" class="card p-3 mb-3 hidden">
          <h6>Verifikasi Hierarki</h6>
          <div id="pendingVerifications" class="muted">Memuat...</div>
        </div>
      </div>

      <div class="col-lg-8">
        <!-- Map -->
        <div class="card p-3 mb-3">
          <h6>Peta Pos & Dusun</h6>
          <div id="map">Memuat peta...</div>
          <div class="d-flex gap-2 mt-3">
            <button id="btnOpenPosForm" class="btn btn-outline-primary hidden" onclick="openPosForm()">Tambah Pos</button>
            <button class="btn btn-outline-secondary" onclick="loadPosList()">Muat Ulang Pos</button>
          </div>
          <div id="posList" class="mt-3"></div>
        </div>

        <!-- History Laporan -->
        <div class="card p-3 mb-3">
          <h6>Riwayat Laporan Saya</h6>
          <div id="myReports">Memuat...</div>
        </div>
        <div class="card p-3 mb-3">
          <h6>Riwayat Laporan Warga Lain (Dusun)</h6>
          <div id="otherReports">Memuat...</div>
        </div>

        <!-- Statistik 30 hari -->
        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian (30 hari)</h6>
          <canvas id="chartKejadian" style="height:180px"></canvas>
          <div id="statSummary" class="mt-2"></div>
        </div>

        <!-- Anggota Keluarga -->
        <div class="card p-3 mb-3">
          <h6>Anggota Keluarga (Alamat Sama)</h6>
          <div id="familyList">Memuat...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pos Form Modal (inline) -->
<div id="posModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5 id="posModalTitle">Tambah Pos</h5>
    <div id="posFormArea">
      <input id="pos_name" class="form-control mb-2" placeholder="Nama Pos (mis. Pos RT01)">
      <div class="row g-2">
        <div class="col"><input id="pos_rt" class="form-control" placeholder="RT (001)"></div>
        <div class="col"><input id="pos_rw" class="form-control" placeholder="RW (001)"></div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col">
          <select id="pos_status" class="form-control">
            <option value="active">Active</option>
            <option value="pasif">Pasif</option>
          </select>
        </div>
        <div class="col">
          <select id="pos_jenis" class="form-control">
            <option value="pos_dusun">Pos Dusun</option>
            <option value="pos_rt">Pos RT</option>
          </select>
        </div>
      </div>
      <div class="mt-2">
        <label class="file-label">Pilih Foto <input id="pos_photo" type="file" accept="image/*" style="display:none"></label>
        <div id="posPhotoPreview" class="mt-2"></div>
      </div>
      <div class="mt-2">
        <small class="muted">Tandai lokasi di map (tetap di halaman ini). Klik titik pada peta untuk memilih lokasi.</small>
        <div id="posFormMap" class="mt-2"></div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-success" onclick="setPosLocationFromMap()">Set Lokasi</button>
          <button class="btn btn-primary" onclick="savePosFromModal()">Simpan Pos</button>
          <button class="btn btn-outline-secondary" onclick="closePosForm()">Batal</button>
        </div>
        <div id="chosenPosCoord" class="muted small mt-2">Lokasi belum ditetapkan.</div>
      </div>
    </div>
  </div>
</div>

<!-- Pos View Modal -->
<div id="posViewModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Detail Pos</h5>
    <div id="posViewContent"></div>
    <div id="posViewMap" class="mt-2"></div>
    <div class="d-flex gap-2 mt-3 justify-content-end">
      <button class="btn btn-secondary" onclick="closePosView()">Tutup</button>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG FIREBASE ================== */
const firebaseConfig = {
  apiKey: "AIzaSyA6GAeIc7ZesIed9MAelUf6x_sBFdp9E-Q",
  authDomain: "dusun-super.firebaseapp.com",
  projectId: "dusun-super",
  storageBucket: "dusun-super.appspot.com",
  messagingSenderId: "1083284057385",
  appId: "1:1083284057385:web:21cfe467b047bb5a241b38"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.warn(e));

/* ================== GLOBAL STATE ================== */
let currentUser = null;
let currentWarga = null;
let currentDusun = null;
let mainMap = null;
let mainMarkers = null;
let posFormMap = null, posFormMarker = null;
let posViewMap = null;
let chartKej = null;
let reportsUnsub = null;
let posModalEditingId = null;
let kodeCountdownTimer = null;
let tempChosenPos = { lat:null, lng:null };

/* ================== HELPERS ================== */
const $ = id => document.getElementById(id);
const show = id => { const e=$(id); if(e) e.classList.remove('hidden'); };
const hide = id => { const e=$(id); if(e) e.classList.add('hidden'); };
const toast = (t) => Swal.fire({title:t,icon:'success',toast:true,position:'top-end',showConfirmButton:false,timer:1400});
const err = (m) => Swal.fire('Error', m, 'error');
function formatPhoneTyping(el){ el.value = el.value.replace(/[^\d\+]/g,''); }
function normalizePhoneForKey(v){ let s=(v||"").replace(/\D/g,""); if(s.startsWith("0")) s="62"+s.substring(1); if(!s.startsWith("62")) s="62"+s; return s; }
function padRT(el){ let v=(el.value||'').replace(/\D/g,''); v=v.padStart(3,'0'); el.value=v; }
function padRW(el){ let v=(el.value||'').replace(/\D/g,''); v=v.padStart(3,'0'); el.value=v; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function showDashboard() {
    hide('authCard');
    show('dashboardCard');
}

function showAuth() {
    show('authCard');
    hide('dashboardCard');
}
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

// ✅ ✅ ✅ SISIPKAN INI ✅ ✅ ✅
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}
  // ✅ ✅ ✅ SISIPKAN FUNGSI BARU INI DI SINI ✅ ✅ ✅
function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.7) {
    return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
            resolve(file);
            return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth || height > maxHeight) {
                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(blob => {
                resolve(new File([blob], file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                }));
            }, 'image/jpeg', quality);
        };
        
        img.onerror = () => resolve(file);
        img.src = URL.createObjectURL(file);
    });
}

  // Auto show register
if (window.location.search.includes('show=register')) {
    showRegisterForm();
}

  /* ================== SIDEBAR FUNCTIONS ================== */
function updateSidebarInfo() {
    if (!currentWarga) return;
    
    $('#sidebar_name').textContent = currentWarga.data.nama || '';
    $('#sidebar_role').textContent = (currentWarga.data.role || '').toUpperCase();
}

function showDashboardView() {
    // Reset active state
    document.querySelectorAll('.nav .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.nav .btn')[0].classList.add('active');
    
    // Tampilkan dashboard (default sudah tampil)
}

// Update sidebar ketika load profile
async function loadProfileAndShow(){
  if(!auth.currentUser) return;
  const uid = auth.currentUser.uid;
  const doc = await db.collection('Warga').doc(uid).get();
  if(!doc.exists){ showAuth(); return; }
  currentWarga = { id: doc.id, data: doc.data() };
  
  // Update semua display
  $('display_name').innerText = currentWarga.data.nama || '';
  $('display_role').innerText = (currentWarga.data.role || '').toUpperCase();
  $('display_status').innerText = (currentWarga.data.status || '').toUpperCase();
  
  // UPDATE SIDEBAR
  updateSidebarInfo();
  
  showDashboard();
  // ... kode lainnya ...
}
  
  /* ================== PROFILE FUNCTIONS ================== */
function showProfile() {
    if (!currentWarga) return;
    
    const profileData = currentWarga.data;
    const html = `
        <div class="mb-3">
            <strong>Nama Lengkap:</strong><br>
            ${escapeHtml(profileData.nama || '-')}
        </div>
        <div class="mb-3">
            <strong>Nomor HP:</strong><br>
            ${escapeHtml(profileData.phone || '-')}
        </div>
        <div class="mb-3">
            <strong>Role:</strong><br>
            ${escapeHtml(profileData.role || '-')}
        </div>
        <div class="mb-3">
            <strong>Status:</strong><br>
            ${escapeHtml(profileData.status || '-')}
        </div>
        <div class="mb-3">
            <strong>Alamat:</strong><br>
            ${escapeHtml(profileData.alamat || '-')}
        </div>
        <div class="mb-3">
            <strong>RT/RW:</strong><br>
            ${escapeHtml(profileData.rt || '-')} / ${escapeHtml(profileData.rw || '-')}
        </div>
        <div class="mb-3">
            <strong>Bergabung:</strong><br>
            ${profileData.createdAt ? new Date(profileData.createdAt.seconds * 1000).toLocaleDateString('id-ID') : '-'}
        </div>
        
        <div class="border-top pt-3 mt-3">
            <h6>Update Data</h6>
            <button class="btn btn-warning btn-sm me-2" onclick="showChangeRole()">Change Role</button>
            <button class="btn btn-info btn-sm" onclick="showChangePassword()">Change Password</button>
        </div>
    `;
    
    $('#profileContent').innerHTML = html;
    show('profileModal');
}

function closeProfile() {
    hide('profileModal');
}

function showChangeRole() {
    // Fitur change role (bisa dikembangkan)
    alert('Fitur change role akan segera hadir!');
}

function showChangePassword() {
    // Fitur change password
    Swal.fire({
        title: 'Change Password',
        html: `
            <input type="password" id="currentPass" class="form-control mb-2" placeholder="Password saat ini">
            <input type="password" id="newPass" class="form-control mb-2" placeholder="Password baru">
            <input type="password" id="confirmPass" class="form-control" placeholder="Konfirmasi password baru">
        `,
        showCancelButton: true,
        confirmButtonText: 'Update Password',
        preConfirm: () => {
            const current = document.getElementById('currentPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirm = document.getElementById('confirmPass').value;
            
            if (!current || !newPass || !confirm) {
                Swal.showValidationMessage('Semua field harus diisi');
                return false;
            }
            
            if (newPass.length < 6) {
                Swal.showValidationMessage('Password baru minimal 6 karakter');
                return false;
            }
            
            if (newPass !== confirm) {
                Swal.showValidationMessage('Password baru tidak cocok');
                return false;
            }
            
            return { current, newPass };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            changePassword(result.value.current, result.value.newPass);
        }
    });
}

async function changePassword(currentPass, newPass) {
    try {
        const user = auth.currentUser;
        const email = user.email;
        
        // Re-authenticate user
        const credential = firebase.auth.EmailAuthProvider.credential(email, currentPass);
        await user.reauthenticateWithCredential(credential);
        
        // Update password
        await user.updatePassword(newPass);
        
        toast('Password berhasil diupdate!');
        closeProfile();
        
    } catch (error) {
        console.error('Password change error:', error);
        err('Gagal update password: ' + (error.message || 'Password saat ini salah'));
    }
}


/* ================== TOGGLE LOGIN/REGISTER FORM ================== */
function toggleSidebar() {
   const sidebar = document.querySelector('.sidebar-container');
    const overlay = document.querySelector('.sidebar-overlay');
    
    sidebar.classList.toggle('sidebar-open');
    
    if (!overlay) {
        // Buat overlay jika belum ada
        const newOverlay = document.createElement('div');
        newOverlay.className = 'sidebar-overlay';
        newOverlay.onclick = toggleSidebar;
        document.body.appendChild(newOverlay);
    }
    
    document.querySelector('.sidebar-overlay').classList.toggle('show');
}
function showLoginForm(){
  $('loginCard').style.display = 'block';
  $('registerCard').style.display = 'none';
}

function showRegisterForm(){
  $('loginCard').style.display = 'none';
  $('registerCard').style.display = 'block';
}

function formatPhoneTyping(el){ 
  el.value = el.value.replace(/[^\d\+]/g,''); 
}

/* ================== CLOCK ================== */
function updateClock(){ if($('clock')) $('clock').innerText = new Date().toLocaleString(); setTimeout(updateClock,1000); }
updateClock();

/* ================== LOAD REGION DROPDOWNS ================== */
const API_REG = "https://www.emsifa.com/api-wilayah-indonesia/api/";
async function loadRegionDropdowns(){
  try{
    const res = await fetch(API_REG + 'provinces.json'); 
    const provs = await res.json();
    const provSel = $('reg_prov');
    provs.forEach(p=>provSel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    
    $('reg_prov').addEventListener('change', async function(){
      $('reg_kab').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>'; 
      $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>';
      if(!this.value) { autofillAlamat(); return; }
      const r = await fetch(API_REG + 'regencies/' + this.value + '.json'); 
      const data = await r.json();
      data.forEach(k => $('reg_kab').innerHTML += `<option value="${k.id}">${k.name}</option>`);
      autofillAlamat();
    });
    
    $('reg_kab').addEventListener('change', async function(){ 
      $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; 
      if(!this.value) { autofillAlamat(); return; } 
      const r = await fetch(API_REG + 'districts/' + this.value + '.json'); 
      const data = await r.json(); 
      data.forEach(k => $('reg_kec').innerHTML += `<option value="${k.id}">${k.name}</option>`); 
      autofillAlamat(); 
    });
    
    $('reg_kec').addEventListener('change', async function(){ 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; 
      if(!this.value) { autofillAlamat(); return; } 
      const r = await fetch(API_REG + 'villages/' + this.value + '.json'); 
      const data = await r.json(); 
      data.forEach(d => $('reg_des').innerHTML += `<option value="${d.id}">${d.name}</option>`); 
      autofillAlamat(); 
    });
    
    $('reg_des').addEventListener('change', ()=>{ autofillAlamat(); });
    ['reg_blok','reg_no','reg_rt','reg_rw'].forEach(id=>{ 
      const el=$(id); 
      if(el) el.addEventListener('input', autofillAlamat); 
    });
  }catch(e){ console.warn('Gagal load region', e); }
}

/* ================== AUTOFILL ALAMAT ================== */
function autofillAlamat(){
  const prov = $('reg_prov').selectedOptions[0]?.text || '';
  const kab = $('reg_kab').selectedOptions[0]?.text || '';
  const kec = $('reg_kec').selectedOptions[0]?.text || '';
  const des = $('reg_des').selectedOptions[0]?.text || '';
  const blok = $('reg_blok').value || '';
  const no = $('reg_no').value || '';
  const rt = $('reg_rt').value || '';
  const rw = $('reg_rw').value || '';
  const parts = [];
  
  // Format: Blok A - No. 15, RT 001 / RW 002, Desa ABC, Kec. XYZ, Kab/Kota DEF, Prov GHI
  if(blok || no) {
    let blokNo = '';
    if(blok) blokNo += 'Blok ' + blok;
    if(no) blokNo += (blok ? ' - ' : '') + 'No. ' + no;
    parts.push(blokNo);
  }
  
  if(rt || rw) parts.push('RT ' + (rt || '000') + ' / RW ' + (rw || '000'));
  if(des) parts.push('Desa ' + des);
  if(kec) parts.push('Kec. ' + kec);
  if(kab) parts.push(kab.includes('Kota') ? kab : 'Kab. ' + kab);
  if(prov) parts.push('Prov. ' + prov);
  
  $('reg_alamat').value = parts.join(', ');
}

/* ================== AUTO SHOW REGISTER ================== */
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show') === 'register') {
        showRegisterForm();
    }
});
  
/* ================== REGISTER ================== */
async function onRegister(){
  const nama = $('reg_nama').value.trim();
  const hp = $('reg_hp').value.trim();
  const password = $('reg_password').value;
  const role = $('reg_status').value || 'warga';
  const prov = $('reg_prov').value;
  const kab = $('reg_kab').value;
  const kec = $('reg_kec').value;
  const des = $('reg_des').value;
  const provText = $('reg_prov').selectedOptions[0]?.text || '';
  const kabText = $('reg_kab').selectedOptions[0]?.text || '';
  const kecText = $('reg_kec').selectedOptions[0]?.text || '';
  const desText = $('reg_des').selectedOptions[0]?.text || '';
  const alamat = $('reg_alamat').value.trim();
  const blok = $('reg_blok').value.trim();
  const no = $('reg_no').value.trim();
  const rt = $('reg_rt').value.trim();
  const rw = $('reg_rw').value.trim();

  if(!nama || !hp || !password) return err("Lengkapi Nama, HP, Password");
  if(password.length < 6) return err("Password minimal 6 karakter");

  try{
    const norm = normalizePhoneForKey(hp);
    
    // Cek duplikasi nomor HP
    const dup = await db.collection('Warga').where('phone','==',norm).limit(1).get();
    if(!dup.empty) return err("Nomor HP sudah terdaftar");

    const email = norm + "@dusun.fake";
    const uc = await auth.createUserWithEmailAndPassword(email, password);
    const uid = uc.user.uid;

    // Generate kode referral hanya untuk kepala keluarga
    const kodeReferral = (role === 'kepala_keluarga') ? generateCode(6) : null;
    
    // Tentukan status berdasarkan role
    const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
    const status = kepalaRoles.includes(role) ? 'pending' : 'pending_referral';

    // Data untuk disimpan
    const userData = {
      nama: nama.toUpperCase(),
      phone: norm,
      role: role,
      status: status,
      provinsi: provText,
      kabupaten: kabText,
      kecamatan: kecText,
      desa: desText,
      alamat: alamat.toUpperCase(),
      blok: blok.toUpperCase(),
      no: no.toUpperCase(),
      rt: rt,
      rw: rw,
      kodeReferral: kodeReferral,
      kodeDusun: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Simpan ke Firestore
    await db.collection('Warga').doc(uid).set(userData);

    // Reset form dan logout
    $('reg_password').value = '';
    await auth.signOut();
    
    // Tampilkan sukses
    await Swal.fire({
      icon: 'success',
      title: 'Pendaftaran Berhasil',
      text: 'Silakan login menggunakan nomor HP dan password Anda'
    });
    
    // Kembali ke login
    clearRegister();
    showLoginForm();

  } catch(e){
    console.error('Register Error:', e);
    let errorMessage = 'Terjadi kesalahan saat pendaftaran';
    
    if(e.code === 'auth/email-already-in-use'){
      errorMessage = 'Nomor HP sudah terdaftar';
    } else if(e.code === 'auth/weak-password'){
      errorMessage = 'Password terlalu lemah, minimal 6 karakter';
    } else if(e.code === 'auth/invalid-email'){
      errorMessage = 'Format nomor HP tidak valid';
    } else {
      errorMessage = e.message || errorMessage;
    }
    
    Swal.fire({
      icon: 'error',
      title: 'Gagal Mendaftar',
      text: errorMessage
    });
  }
}

function clearRegister(){
  // Reset semua field form
  const fields = ['reg_nama','reg_hp','reg_password','reg_blok','reg_no','reg_rt','reg_rw','reg_alamat'];
  fields.forEach(id => {
    if($(id)) $(id).value = '';
  });

function navigateTo(pageId) {
  localStorage.setItem("lastPage", pageId); // simpan halaman terakhir
  showPage(pageId); // tampilkan halaman
}
  // Reset dropdowns
  if($('reg_status')) $('reg_status').selectedIndex = 0;
  if($('reg_prov')) $('reg_prov').selectedIndex = 0;
  if($('reg_kab')) $('reg_kab').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
  if($('reg_kec')) $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>';
  if($('reg_des')) $('reg_des').innerHTML = '<option value="">Pilih Desa</option>';
}

async function onLogin(){
  const hp = document.getElementById('login_hp').value.trim();
  const pass = document.getElementById('login_pass').value;
  
  if(!hp || !pass) return err("Nomor HP & password wajib");
  
  try{
    const norm = normalizePhoneForKey(hp);
    const email = norm + "@dusun.fake";
    
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    
    currentUser = cred.user;
    document.getElementById('login_pass').value = '';
    
    await loadProfileAndShow();
    toast("Login berhasil");
    
  }catch(e){ 
    console.error('Login Error:', e);
    
    let errorMessage = 'Login gagal';
    if(e.code === 'auth/user-not-found') {
      errorMessage = 'Nomor HP belum terdaftar';
    } else if(e.code === 'auth/wrong-password') {
      errorMessage = 'Password salah';
    } else if(e.code === 'auth/invalid-email') {
      errorMessage = 'Format nomor HP tidak valid';
    } else {
      errorMessage = e.message || errorMessage;
    }
    
    err(errorMessage);
  }
}

/* ================== AUTH STATE LISTENER ================== */
auth.onAuthStateChanged(async u => {
  if (u) {
    try {
      currentUser = u;

      // ✅ cek halaman terakhir
      const lastPage = localStorage.getItem("lastPage") || "dashboard";

      // kalau lastPage = dashboard, jalankan normal
      if (lastPage === "dashboard") {
        await loadProfileAndShow();
      } else {
        showPage(lastPage); // buka halaman terakhir
      }

    } catch (e) { 
      console.warn('Auth state error:', e);
    }
  } else {
    currentUser = null; 
    currentWarga = null; 
    currentDusun = null;
    localStorage.removeItem("lastPage"); // reset biar ga nyangkut
    showPage("homepage"); // ✅ bukan showAuth()
  }
});


  
/* ================== LOGOUT ================== */
async function onLogout(){
  try{
    await auth.signOut();
    // Redirect langsung ke homepage
    window.location.href = "homepage.html";
  }catch(e){ 
    console.error(e); 
    err(e.message || String(e)); 
  }
}
/* ================== LOAD PROFILE & INIT DASHBOARD ================== */
async function loadProfileAndShow(){
  if(!auth.currentUser) return;
  const uid = auth.currentUser.uid;
  const doc = await db.collection('Warga').doc(uid).get();
  if(!doc.exists){ showAuth(); return; }
  currentWarga = { id: doc.id, data: doc.data() };
  $('display_name').innerText = currentWarga.data.nama || '';
  $('display_role').innerText = (currentWarga.data.role || '').toUpperCase();
  $('display_status').innerText = (currentWarga.data.status || '').toUpperCase();
  showDashboard();

  // Hanya kepala_dusun yang bisa membuat dusun dan mengelola kode
  if(currentWarga.data.role === 'kepala_dusun'){
    show('createDusunCard'); 
    show('btnOpenPosForm'); 
    show('pendingCard'); 
    $('regenKodeBtn').classList.remove('hidden'); 
    $('expireKodeBtn').classList.remove('hidden');
  } else {
    hide('createDusunCard'); 
    
    // Kepala lainnya (kepala_desa, ketua_rt_rw, kepala_keluarga) hanya bisa buat pos
    const kepalaLainnya = ['kepala_desa','ketua_rt_rw','kepala_keluarga'];
    if(kepalaLainnya.includes(currentWarga.data.role)) {
      show('btnOpenPosForm');
    } else {
      hide('btnOpenPosForm');
    }
    
    hide('pendingCard'); 
    $('regenKodeBtn').classList.add('hidden'); 
    $('expireKodeBtn').classList.add('hidden');
  }

    // ✅ ✅ ✅ TAMBAHKAN INI - TAMPILKAN CARD VERIFIKASI UNTUK KEPALA YANG AKTIF
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
  if(kepalaRoles.includes(currentWarga.data.role) && currentWarga.data.status === 'aktif') {
    show('verificationCard');
    loadPendingVerifications();
  } else {
    hide('verificationCard');
  }
  // ✅ ✅ ✅ SAMPAI SINI
 
  if(currentWarga.data.kodeDusun){
    await loadDusunByCode(currentWarga.data.kodeDusun);
    loadPosList();
    loadMarkers();
    subscribeReportsForDusun(currentWarga.data.kodeDusun);
  } else {
    show('joinDusunCard');
    $('kepalaInfo').innerHTML = '<div class="muted">Anda belum bergabung dengan dusun manapun.</div>';
    $('posList').innerHTML = '<div class="muted">Gabung dusun untuk melihat pos.</div>';
    renderEmptyReports();
  }

  refreshFamilyList();
  loadRegionDropdowns();
  loadKejadianOptions();
  initMainMap();
  loadPendingList();
}

/* ================== CREATE DUSUN ================== */
async function createDusun(){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') {
    return err("Hanya Kepala Dusun yang boleh membuat dusun");
  }
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
  if(!kepalaRoles.includes(currentWarga.data.role)) return err("Hanya subrole kepala boleh membuat dusun");
  const nama = $('dusun_nama').value.trim();
  if(!nama) return err("Nama dusun wajib");
  try{
    const kode = generateCode(6);
    const expiresMs = Date.now() + (60 * 60 * 1000);
    const payload = {
      nama, 
      kode,
      kepalaId: currentWarga.id,
      kepalaNama: currentWarga.data.nama,
      kepalaHp: currentWarga.data.phone || '',
      // SIMPAN DATA ALAMAT LENGKAP KEPALA DUSUN
      kepalaBlok: currentWarga.data.blok || '',
      kepalaNo: currentWarga.data.no || '',
      kepalaRt: currentWarga.data.rt || '',
      kepalaRw: currentWarga.data.rw || '',
      kepalaAlamat: currentWarga.data.alamat || '',
      kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(expiresMs),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    const docRef = await db.collection('Dusun').add(payload);
    await db.collection('Warga').doc(currentWarga.id).update({ kodeDusun: kode });
    currentWarga.data.kodeDusun = kode;
    $('dusun_nama').value = '';
    await loadDusunByCode(kode);
    loadPosList(); loadMarkers(); subscribeReportsForDusun(kode);
    toast("Dusun dibuat: " + kode);
  }catch(e){ console.error(e); err(e.message || String(e)); }
}
/* ================ REGENERATE / EXPIRE KODE ================ */
async function regenerateKodeDusun(){
  if(!currentDusun || !currentWarga) return;
  
  // Hanya kepala_dusun yang membuat kode bisa regenerate
  if(currentDusun.data.kepalaId !== currentWarga.id || currentWarga.data.role !== 'kepala_dusun') 
    return err("Hanya Kepala Dusun yang bisa regenerate kode");
  
  try{
    const newCode = generateCode(6);
    const expiresMs = Date.now() + (60*60*1000);
    await db.collection('Dusun').doc(currentDusun.id).update({ 
      kode:newCode, 
      kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(expiresMs) 
    });
    await loadDusunByCode(newCode);
    toast("Kode berhasil diganti");
  }catch(e){ console.error(e); err("Gagal regenerate kode"); }
}

async function expireKodeNow(){
  if(!currentDusun || !currentWarga) return;
  
  // Hanya kepala_dusun yang membuat kode bisa expire
  if(currentDusun.data.kepalaId !== currentWarga.id || currentWarga.data.role !== 'kepala_dusun') 
    return err("Hanya Kepala Dusun yang bisa expire kode");
  
  try{
    await db.collection('Dusun').doc(currentDusun.id).update({ 
      kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(Date.now()-1000) 
    });
    await loadDusunByCode(currentDusun.data.kode);
    toast("Kode di-expire sekarang");
  }catch(e){ console.error(e); err("Gagal expire kode"); }
}
/* ================== LOAD DUSUN BY CODE & COUNTDOWN ================== */
async function loadDusunByCode(kode){
   try{
    const snap = await db.collection('Dusun').where('kode','==',kode).limit(1).get();
    if(snap.empty){ 
      $('dusunInfo').innerHTML = '<div class="muted">Dusun tidak ditemukan.</div>'; 
      return; 
    }
    const doc = snap.docs[0]; 
    currentDusun = { id: doc.id, data: doc.data() };
    const d = currentDusun.data;
    
    // Format alamat lengkap kepala dusun
    let alamatKepala = '';
    if(d.kepalaAlamat) {
      alamatKepala = d.kepalaAlamat;
    } else if(d.kepalaBlok || d.kepalaNo) {
      alamatKepala = `${d.kepalaBlok ? 'Blok ' + d.kepalaBlok : ''}${d.kepalaNo ? (d.kepalaBlok ? ' - ' : '') + 'No. ' + d.kepalaNo : ''}`;
    }
    
    // Tampilkan informasi dusun lengkap
    $('dusunInfo').innerHTML = `
      <div class="mb-2">
        <strong>Nama Dusun:</strong><br>
        <span class="text-primary">${escapeHtml(d.nama||'-')}</span>
      </div>
      <div class="mb-2">
        <strong>Kepala Dusun:</strong><br>
        ${escapeHtml(d.kepalaNama||'-')}
      </div>
      <div class="mb-2">
        <strong>HP Kepala Dusun:</strong><br>
        ${escapeHtml(d.kepalaHp||'-')}
      </div>
      <div class="mb-2">
        <strong>Alamat Kepala Dusun:</strong><br>
        ${escapeHtml(alamatKepala||'-')}
        ${d.kepalaRt || d.kepalaRw ? `<br>RT ${d.kepalaRt||'-'} / RW ${d.kepalaRw||'-'}` : ''}
      </div>
    `;
    
    // Show kode only if current user is kepala_dusun that created it
    if(currentWarga && currentWarga.id === d.kepalaId && currentWarga.data.role === 'kepala_dusun'){
      $('myDusunCode').innerText = 'Kode dusun: ' + (d.kode||'');
      $('myDusunCode').classList.remove('hidden');
      show('createDusunCard');
      show('regenKodeBtn'); show('expireKodeBtn');
      
      const expiresTs = d.kodeExpiresAt && d.kodeExpiresAt.toMillis ? d.kodeExpiresAt.toMillis() : null;
      if(expiresTs){
        startKodeCountdown(expiresTs);
      } else {
        $('kodeCountdown').innerText = '';
        if(kodeCountdownTimer){ clearInterval(kodeCountdownTimer); kodeCountdownTimer = null; }
      }
    } else {
      $('myDusunCode').innerText = '';
      $('kodeCountdown').innerText = '';
      hide('regenKodeBtn'); hide('expireKodeBtn');
    }
    hide('joinDusunCard');
  }catch(e){ console.error(e); }
}
function startKodeCountdown(expiresAtMs){
  if(kodeCountdownTimer) clearInterval(kodeCountdownTimer);
  function update(){
    const diff = expiresAtMs - Date.now();
    if(diff <= 0){
      $('kodeCountdown').innerText = 'Kode KADALUARSA';
      clearInterval(kodeCountdownTimer);
      kodeCountdownTimer = null;
    } else {
      const h = Math.floor(diff/3600000);
      const m = Math.floor((diff%3600000)/60000);
      const s = Math.floor((diff%60000)/1000);
      $('kodeCountdown').innerText = `Sisa waktu kode: ${h}h ${m}m ${s}s`;
    }
  }
  update();
  kodeCountdownTimer = setInterval(update,1000);
}

/* ================== JOIN DUSUN ================== */
async function joinDusun(){
  const kode = ($('join_kode').value || '').trim().toUpperCase();
  if(!kode) return err("Masukkan kode dusun");
  try{
    const snap = await db.collection('Dusun').where('kode','==',kode).limit(1).get();
    if(snap.empty) return err("Kode tidak ditemukan");
    await db.collection('Warga').doc(currentWarga.id).update({ kodeDusun: kode });
    currentWarga.data.kodeDusun = kode;
    toast("Berhasil gabung ke dusun " + kode);
    $('join_kode').value = '';
    await loadDusunByCode(kode);
    loadPosList(); loadMarkers(); subscribeReportsForDusun(kode);
  }catch(e){ console.error(e); err(e.message || String(e)); }
}

/* ================== MAIN MAP & MARKERS ================== */
function initMainMap(){
  if(mainMap) return;
  mainMap = L.map('map').setView([-6.2, 106.8166], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(mainMap);
  mainMarkers = L.layerGroup().addTo(mainMap);
}

async function loadMarkers(){
  if(!mainMap) initMainMap();
  mainMarkers.clearLayers();
  if(!currentWarga || !currentWarga.data.kodeDusun) return;
  try{
    const snap = await db.collection('PosDusun').where('dusunCode','==', currentWarga.data.kodeDusun).get();
    if(snap.empty) return;
    const bounds = [];
    snap.forEach(doc=>{
      const d = doc.data();
      if(d.lat && d.lng){
        const color = d.status === 'active' ? 'green' : 'red';
        const marker = L.circleMarker([d.lat, d.lng], { 
          radius:8, color, fillColor: color, fillOpacity:0.9 
        }).addTo(mainMarkers);
        let popup = `
          <div><strong>${escapeHtml(d.nama||'-')}</strong></div>
          <div class="muted small">RT/RW: ${escapeHtml(d.rt||'-')}/${escapeHtml(d.rw||'-')}</div>
          <div class="muted small">Jenis: ${escapeHtml(d.jenis||'')}</div>
          <div class="muted small">Status: ${escapeHtml(d.status||'')}</div>
          <div class="muted small">Pembuat: ${escapeHtml(d.pembuatNama||'-')}</div>`;
        if(d.foto) popup += `<div style="margin-top:6px"><img src="${d.foto}" style="max-width:200px;border-radius:6px;"></div>`;
        marker.bindPopup(popup);
        bounds.push([d.lat,d.lng]);
      }
    });
    if(bounds.length) mainMap.fitBounds(bounds,{padding:[40,40],maxZoom:16});
  }catch(e){ console.error(e); }
}

/* ================== POS FORM ================== */
function openPosForm(){
  if(!currentWarga) return err("Login dulu");
  
  // Semua kepala bisa menambah pos (kepala_dusun, kepala_desa, ketua_rt_rw, kepala_keluarga)
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
  if(!kepalaRoles.includes(currentWarga.data.role)) 
    return err("Hanya subrole kepala boleh menambah pos");
  
  posModalEditingId = null;
  $('posModalTitle').innerText = 'Tambah Pos';
  show('posModal');
  setTimeout(()=>initPosFormMap(),200);
}

function closePosForm(){
  hide('posModal');
  ['pos_name','pos_rt','pos_rw'].forEach(id=>{ if($(id)) $(id).value=''; });
  $('pos_status').value = 'active';
  $('pos_jenis').value = 'pos_dusun';
  $('posPhotoPreview').innerHTML = '';
  $('pos_photo').value = '';
  $('chosenPosCoord').innerText = 'Lokasi belum ditetapkan.';
  tempChosenPos = { lat:null, lng:null };
  if(posFormMarker){ posFormMap.removeLayer(posFormMarker); posFormMarker=null; }
  if(posFormMap){ posFormMap.setView([-6.2,106.8166], 12); }
  delete $('posModal').dataset.editingId;
}

function initPosFormMap(){
  if(posFormMap) return;
  posFormMap = L.map('posFormMap').setView([-6.2,106.8166], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(posFormMap);
  posFormMap.on('click', function(e){
    tempChosenPos.lat = e.latlng.lat; tempChosenPos.lng = e.latlng.lng;
    if(posFormMarker) posFormMap.removeLayer(posFormMarker);
    posFormMarker = L.marker([tempChosenPos.lat, tempChosenPos.lng]).addTo(posFormMap);
    $('chosenPosCoord').innerText = `Terpilih: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}`;
  });

 // ✅ ✅ ✅ GANTI TOTAL DENGAN INI ✅ ✅ ✅
$('pos_photo').addEventListener('change', function(){
  const f = this.files[0];
  if(!f) { 
    $('posPhotoPreview').innerHTML=''; 
    return; 
  }
  
  // Validasi ukuran file
  if(f.size > 10 * 1024 * 1024) {
    err("Ukuran foto terlalu besar! Maksimal 10MB");
    this.value = '';
    return;
  }
  
  // Validasi tipe file
  if(!f.type.startsWith('image/')) {
    err("File harus berupa gambar!");
    this.value = '';
    return;
  }
  
  const url = URL.createObjectURL(f);
  $('posPhotoPreview').innerHTML = `<img src="${url}" class="pos-photo">`;
});
}

function setPosLocationFromMap(){
  if(!tempChosenPos.lat || !tempChosenPos.lng) return err("Pilih titik di peta terlebih dahulu");
  $('chosenPosCoord').innerText = `Lokasi ditetapkan: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}`;
  toast("Lokasi pos telah ditetapkan");
}

async function savePosFromModal(){
  const editingId = $('posModal').dataset.editingId || null;
  if(editingId) { return updatePos(editingId); }
  return savePosNew();
}

async function savePosNew(){
  if(!currentWarga) return err("Login dulu");
  const name = $('pos_name').value.trim();
  const rt = $('pos_rt').value.trim();
  const rw = $('pos_rw').value.trim();
  const status = $('pos_status').value;
  const jenis = $('pos_jenis').value;
  const fotoFile = $('pos_photo').files[0];
  
  if(!name || !rt || !rw || !fotoFile) return err("Isi semua field dan upload foto pos (wajib)");
  if(!tempChosenPos.lat || !tempChosenPos.lng) return err("Tentukan lokasi pos pada peta");

  try{
    Swal.fire({ 
      title: 'Mengompresi foto...', 
      didOpen: () => Swal.showLoading(),
      allowOutsideClick: false
    });

    // Kompresi foto dan konversi ke Base64
    const compressedFile = await compressImage(fotoFile, 400, 300, 0.6);
    const base64String = await fileToBase64(compressedFile);
    
    Swal.close();

    // Simpan Base64 langsung ke Firestore
    const payload = {
      nama: name, rt, rw, status, jenis, 
      fotoBase64: base64String,
      fotoName: fotoFile.name,
      pembuatId: currentWarga.id, 
      pembuatNama: currentWarga.data.nama,
      lat: tempChosenPos.lat, 
      lng: tempChosenPos.lng,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      dusunCode: currentWarga.data.kodeDusun || null
    };
    
    await db.collection('PosDusun').add(payload);
    toast("Pos tersimpan!");
    closePosForm();
    loadPosList();
    loadMarkers();
    
  }catch(e){ 
    console.error(e); 
    Swal.close(); 
    err("Gagal simpan pos"); 
  }
}
async function updatePos(id){
  if(!currentWarga) return err("Login dulu");
  try{
    const docRef = db.collection('PosDusun').doc(id);
    const docSnap = await docRef.get();
    if(!docSnap.exists) return err("Pos tidak ditemukan");
    const d = docSnap.data();
    const name = $('pos_name').value.trim();
    const rt = $('pos_rt').value.trim();
    const rw = $('pos_rw').value.trim();
    const status = $('pos_status').value;
    const jenis = $('pos_jenis').value;
    const fotoFile = $('pos_photo').files[0];
    let fotoUrl = d.foto, fotoPath = d.fotoPath || null;
    if(fotoFile){
      try{ if(fotoPath) await storage.ref().child(fotoPath).delete(); }catch(e){ console.warn(e); }
      const path = `pos_photos/${Date.now()}_${fotoFile.name.replace(/\s+/g,'_')}`;
      const up = await storage.ref().child(path).put(fotoFile);
      fotoUrl = await up.ref.getDownloadURL();
      fotoPath = path;
    }
    await docRef.update({
      nama: name, rt, rw, status, jenis, foto: fotoUrl, fotoPath,
      lat: tempChosenPos.lat || d.lat || null, lng: tempChosenPos.lng || d.lng || null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    toast("Pos diperbarui");
    delete $('posModal').dataset.editingId;
    closePosForm(); loadPosList(); loadMarkers();
  }catch(e){ console.error(e); err("Gagal update pos"); }
}

/* ================== LOAD POS LIST ================== */
async function loadPosList(){
  if(!currentWarga || !currentWarga.data.kodeDusun){ 
    $('posList').innerHTML = '<div class="muted">Gabung dusun untuk melihat daftar pos.</div>'; 
    return; 
  }
  try{
    const snap = await db.collection('PosDusun').where('dusunCode','==', currentWarga.data.kodeDusun).get();
    if(snap.empty){ 
      $('posList').innerHTML = '<div class="muted">Belum ada pos.</div>'; 
      return; 
    }
    const arr = [];
    snap.forEach(doc => arr.push({ id: doc.id, data: doc.data() }));
    arr.sort((a,b)=>{
      const ta = a.data.createdAt ? a.data.createdAt.seconds || 0 : 0;
      const tb = b.data.createdAt ? b.data.createdAt.seconds || 0 : 0;
      return tb - ta;
    });
    let html = '';
    arr.forEach(item=>{
      const d = item.data; 
      const id = item.id;
      
      // Format status dan jenis
      const statusText = d.status === 'active' ? 'AKTIF' : 'PASIF';
      const statusClass = d.status === 'active' ? 'status-aman' : 'status-rawan';
      const jenisText = d.jenis === 'pos_dusun' ? 'Pos Dusun' : 'Pos RT';
      
      html += `
        <div class="p-3 border rounded mb-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h6 class="mb-1 text-primary">${escapeHtml(d.nama)}</h6>
              <div class="small text-muted mb-1">
                <span class="me-3">RT/RW: ${escapeHtml(d.rt||'-')}/${escapeHtml(d.rw||'-')}</span>
                <span class="me-3">Jenis: ${jenisText}</span>
                <span class="${statusClass}">Status: ${statusText}</span>
              </div>
              <div class="small text-muted">
                Pembuat: ${escapeHtml(d.pembuatNama||'-')}
              </div>
            </div>
            <div class="ms-2">
              <button class="btn btn-sm btn-outline-primary" onclick="viewPos('${id}')">Detail</button>`;
      
      if(currentWarga.data.role === 'kepala_dusun') 
        html += ` 
          <button class="btn btn-sm btn-outline-warning" onclick="editPos('${id}')">Edit</button> 
          <button class="btn btn-sm btn-outline-danger" onclick="deletePos('${id}')">Hapus</button>`;
      
      html += `</div></div>`;
      
      // Tampilkan foto thumbnail jika ada
      if(d.fotoBase64) {
        html += `
          <div class="mt-2">
            <img src="${d.fotoBase64}" style="max-width:200px; max-height:120px; border-radius:6px; border:1px solid #eee;" 
                 onclick="viewPos('${id}')" style="cursor:pointer" title="Klik untuk lihat detail">
          </div>`;
      }
      
      html += `</div>`;
    });
    $('posList').innerHTML = html;
  }catch(e){ console.error(e); $('posList').innerHTML = '<div class="muted">Gagal muat pos</div>'; }
}
/* ================== VIEW / EDIT / DELETE / UPDATE POS ================== */
async function viewPos(id){
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(!doc.exists) return err("Pos tidak ditemukan");
    const d = doc.data();
    
    // Format status dan jenis untuk tampilan lebih baik
    const statusText = d.status === 'active' ? 'AKTIF' : 'PASIF';
    const statusClass = d.status === 'active' ? 'status-aman' : 'status-rawan';
    const jenisText = d.jenis === 'pos_dusun' ? 'Pos Dusun' : 'Pos RT';
    
    const html = `
      <div class="mb-3">
        <h6 class="text-primary">${escapeHtml(d.nama||'-')}</h6>
      </div>
      
      <div class="row mb-2">
        <div class="col-6">
          <strong>RT/RW:</strong><br>
          ${escapeHtml(d.rt||'-')} / ${escapeHtml(d.rw||'-')}
        </div>
        <div class="col-6">
          <strong>Jenis Pos:</strong><br>
          ${jenisText}
        </div>
      </div>
      
      <div class="row mb-2">
        <div class="col-6">
          <strong>Status:</strong><br>
          <span class="${statusClass}">${statusText}</span>
        </div>
        <div class="col-6">
          <strong>Pembuat:</strong><br>
          ${escapeHtml(d.pembuatNama||'-')}
        </div>
      </div>
      
      <div class="mb-2">
        <strong>Koordinat:</strong><br>
        ${d.lat ? `${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}` : 'Tidak tersedia'}
      </div>
      
      ${d.fotoBase64 ? `
        <div class="mt-3">
          <strong>Foto Pos:</strong>
          <div class="mt-2">
            <img src="${d.fotoBase64}" style="max-width:100%; max-height:300px; border-radius:8px; border:1px solid #ddd;">
          </div>
        </div>
      ` : ''}
      
      <div class="mt-3 small muted">
        <div>Dibuat: ${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : '-'}</div>
        ${d.updatedAt ? `<div>Diupdate: ${new Date(d.updatedAt.seconds*1000).toLocaleString()}</div>` : ''}
      </div>`;
    
    $('posViewContent').innerHTML = html;
    show('posViewModal');
    setTimeout(()=>{ initPosViewMap(d.lat,d.lng); }, 200);
  }catch(e){ console.error(e); err("Gagal tampilkan pos"); }
}
function closePosView(){ 
  hide('posViewModal'); 
  if(posViewMap){ 
    posViewMap.remove(); 
    posViewMap=null; 
  } 
}

function initPosViewMap(lat,lng){
  if(posViewMap) posViewMap.remove();
  posViewMap = L.map('posViewMap').setView([lat||-6.2, lng||106.8166], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(posViewMap);
  if(lat && lng) L.marker([lat,lng]).addTo(posViewMap);
}

async function editPos(id){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') return err("Hanya Kepala Dusun boleh edit pos");
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(!doc.exists) return err("Pos tidak ditemukan");
    const d = doc.data();
    $('pos_name').value = d.nama || '';
    $('pos_rt').value = d.rt || '';
    $('pos_rw').value = d.rw || '';
    $('pos_status').value = d.status || 'active';
    $('pos_jenis').value = d.jenis || 'pos_dusun';
    $('posPhotoPreview').innerHTML = d.fotoBase64 ? 
  `<img src="${d.fotoBase64}" class="pos-photo">` : 
  '<div class="muted small">Foto sebelumnya tersimpan</div>';
    tempChosenPos.lat = d.lat || null; tempChosenPos.lng = d.lng || null;
    $('chosenPosCoord').innerText = tempChosenPos.lat ? 
      `Terpilih: ${tempChosenPos.lat.toFixed(6)}, ${tempChosenPos.lng.toFixed(6)}` : 
      'Lokasi belum ditetapkan.';
    $('posModal').dataset.editingId = id;
    $('posModalTitle').innerText = 'Edit Pos';
    show('posModal'); 
    setTimeout(()=>{ 
      initPosFormMap(); 
      if(tempChosenPos.lat && tempChosenPos.lng){ 
        if(posFormMarker) posFormMap.removeLayer(posFormMarker); 
        posFormMarker = L.marker([tempChosenPos.lat,tempChosenPos.lng]).addTo(posFormMap); 
        posFormMap.setView([tempChosenPos.lat,tempChosenPos.lng],15); 
      } 
    },200);
  }catch(e){ console.error(e); err("Gagal edit pos"); }
}

async function deletePos(id){
  if(!currentWarga) return err("Login dulu");
  if(currentWarga.data.role !== 'kepala_dusun') return err("Hanya Kepala Dusun boleh hapus pos");
  const conf = await Swal.fire({ 
    title:'Hapus pos?', 
    text:'Data akan dihapus permanen', 
    icon:'warning', 
    showCancelButton:true 
  });
  if(!conf.isConfirmed) return;
  try{
    const doc = await db.collection('PosDusun').doc(id).get();
    if(doc.exists){
      const d = doc.data();
      if(d.fotoPath){ 
        try{ await storage.ref().child(d.fotoPath).delete(); }catch(e){ console.warn(e); } 
      }
      await db.collection('PosDusun').doc(id).delete();
      toast("Pos dihapus");
      loadPosList(); loadMarkers();
    } else err("Pos tidak ditemukan");
  }catch(e){ console.error(e); err("Gagal hapus pos"); }
}
  async function updatePos(id){
  if(!currentWarga) return err("Login dulu");
  try{
    const docRef = db.collection('PosDusun').doc(id);
    const docSnap = await docRef.get();
    if(!docSnap.exists) return err("Pos tidak ditemukan");
    const d = docSnap.data();
    const name = $('pos_name').value.trim();
    const rt = $('pos_rt').value.trim();
    const rw = $('pos_rw').value.trim();
    const status = $('pos_status').value;
    const jenis = $('pos_jenis').value;
    const fotoFile = $('pos_photo').files[0];
    
    let fotoBase64 = d.fotoBase64;
    
    if(fotoFile){
      // Kompresi dan konversi ke Base64 untuk foto baru
      const compressedFile = await compressImage(fotoFile, 400, 300, 0.6);
      fotoBase64 = await fileToBase64(compressedFile);
    }
    
    await docRef.update({
      nama: name, rt, rw, status, jenis, 
      fotoBase64: fotoBase64,
      fotoName: fotoFile ? fotoFile.name : d.fotoName,
      lat: tempChosenPos.lat || d.lat || null, 
      lng: tempChosenPos.lng || d.lng || null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    toast("Pos diperbarui");
    delete $('posModal').dataset.editingId;
    closePosForm(); 
    loadPosList(); 
    loadMarkers();
  }catch(e){ console.error(e); err("Gagal update pos"); }
}

/* ================== KEJADIAN OPTIONS ================== */
function loadKejadianOptions(){
  const types = [
    { key:'Kebakaran', icon:'🔥' },
    { key:'Kemalingan', icon:'🛑' },
    { key:'Medis', icon:'🏥' },
    { key:'Ambulance', icon:'🚑' },
    { key:'Mencurigakan', icon:'👀' }
  ];
  const container = $('kejadianGrid'); container.innerHTML = '';
  types.forEach(t=>{
    const el = document.createElement('div'); el.className='kejadian-option';
    el.innerHTML = `<div style="font-size:28px">${t.icon}</div><span>${t.key}</span>`;
    el.onclick = ()=> { selectKejadian(t.key, t.icon); };
    container.appendChild(el);
  });
  window._selectedKejadian = null;
}

function selectKejadian(key, icon){
  window._selectedKejadian = key;
  Array.from(document.querySelectorAll('.kejadian-option')).forEach(el=>el.style.borderColor='#eee');
  const found = Array.from(document.querySelectorAll('.kejadian-option')).find(el=>el.innerText.includes(key));
  if(found) found.style.borderColor = '#3b82f6';
}

/* ================== OPEN SOS ================== */
async function openSOS(){
  const jenis = window._selectedKejadian || null;
  if(!jenis) return err("Pilih jenis kejadian terlebih dahulu");
  const locOpt = $('lap_loc_opt').value;
  let desc = null;
  if(locOpt === 'lainnya'){
    const { value: input } = await Swal.fire({ 
      title:'Deskripsi lokasi', 
      input: 'text', 
      inputPlaceholder: 'Jelaskan alamat atau titik', 
      showCancelButton:true 
    });
    if(!input) return;
    desc = input;
  }
  let lat=null,lng=null;
  try{
    if(navigator.geolocation){
      const pos = await new Promise((res,rej)=> 
        navigator.geolocation.getCurrentPosition(res,rej,{ timeout:10000 })
      );
      lat = pos.coords.latitude; lng = pos.coords.longitude;
    }
  }catch(e){ console.warn('gps denied'); }
  if(!currentWarga || !currentWarga.data.kodeDusun) return err("Anda belum bergabung ke dusun");
  try{
    await db.collection('Laporan').add({
      jenis, lokasiDeskripsi: desc || null, tempat: locOpt, lat, lng,
      userId: currentWarga.id, userNama: currentWarga.data.nama, dusunCode: currentWarga.data.kodeDusun,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'open'
    });
    toast("Laporan terkirim!");
    subscribeReportsForDusun(currentWarga.data.kodeDusun);
  }catch(e){ console.error(e); err("Gagal kirim laporan"); }
}

/* ================== REPORTS ================== */
let reportsCache = [];
function subscribeReportsForDusun(kodeDusun){
  if(reportsUnsub) reportsUnsub();
  if(!kodeDusun) { renderEmptyReports(); return; }
  const since = new Date(Date.now() - 90*24*60*60*1000);
  reportsUnsub = db.collection('Laporan').where('dusunCode','==', kodeDusun).onSnapshot(snapshot=>{
    reportsCache = [];
    snapshot.forEach(doc => {
      const d = doc.data();
      if(d.createdAt && d.createdAt.toDate && d.createdAt.toDate() < since) return;
      reportsCache.push({ id: doc.id, data: d });
    });
    reportsCache.sort((a,b)=>{
      const ta = a.data.createdAt ? (a.data.createdAt.seconds || 0) : 0;
      const tb = b.data.createdAt ? (b.data.createdAt.seconds || 0) : 0;
      return tb - ta;
    });
    renderReportsFromCache();
    renderStatsFromCache();
  }, e=>console.error(e));
}

function renderReportsFromCache(){
  if(!currentWarga){ renderEmptyReports(); return; }
  const my = reportsCache.filter(r => r.data.userId === currentWarga.id);
  const others = reportsCache.filter(r => r.data.userId !== currentWarga.id);
  const myEl = $('myReports'), otherEl = $('otherReports');
  myEl.innerHTML = my.length ? 
    my.map(r=>`
      <div class="p-2 border rounded mb-2">
        <strong>${escapeHtml(r.data.jenis||'-')}</strong>
        <div class="muted small">${r.data.lokasiDeskripsi||''} · ${r.data.createdAt ? new Date(r.data.createdAt.seconds*1000).toLocaleString() : '-'}</div>
      </div>`).join('') : 
    '<div class="muted">Belum ada laporan Anda.</div>';
  otherEl.innerHTML = others.length ? 
    others.map(r=>`
      <div class="p-2 border rounded mb-2">
        <strong>${escapeHtml(r.data.jenis||'-')}</strong>
        <div class="muted small">Oleh: ${escapeHtml(r.data.userNama||'')} · ${r.data.createdAt ? new Date(r.data.createdAt.seconds*1000).toLocaleString() : '-'}</div>
        <div class="muted small">${r.data.lokasiDeskripsi||''}</div>
      </div>`).join('') : 
    '<div class="muted">Belum ada laporan warga lain.</div>';
}

function renderEmptyReports(){ 
  $('myReports').innerHTML='<div class="muted">Tidak ada laporan</div>'; 
  $('otherReports').innerHTML='<div class="muted">Tidak ada laporan</div>'; 
}

/* ================== STATISTICS ================== */
function renderStatsFromCache(){
  const since = new Date(Date.now() - 30*24*60*60*1000);
  const recent = reportsCache.filter(r => r.data.createdAt && new Date(r.data.createdAt.seconds*1000) >= since);
  const labels = ['Kebakaran','Kemalingan','Medis','Ambulance','Mencurigakan'];
  const counts = labels.map(l => recent.filter(x => x.data.jenis === l).length);
  const total = counts.reduce((s,v)=>s+v,0);
  if(chartKej) chartKej.destroy();
  const ctx = $('chartKejadian').getContext('2d');
  chartKej = new Chart(ctx,{ 
    type:'bar', 
    data:{ 
      labels, 
      datasets:[{ 
        label:'Jumlah', 
        data:counts, 
        backgroundColor:['#ef4444','#f59e0b','#16a34a','#3b82f6','#9b59b6'] 
      }] 
    }, 
    options:{ responsive:true, maintainAspectRatio:false }
  });
  let cat='AMAN', cls='status-aman';
  if(total>=20){ cat='RAWAN'; cls='status-rawan'; } else if(total>=6){ cat='WASPADA'; cls='status-waspada'; }
  $('statSummary').innerHTML = `<div>Total 30 hari: <strong>${total}</strong> · <span class="${cls}">${cat}</span></div>`;
  let html = '<table class="table table-sm mt-2"><thead><tr><th>Jenis</th><th>Jumlah</th><th>Persen</th></tr></thead><tbody>';
  labels.forEach((l,i)=>{ 
    const c = counts[i]; 
    const pct = total ? Math.round(c/total*100) : 0; 
    html += `
      <tr>
        <td>${l}</td>
        <td>${c}</td>
        <td style="width:60%">
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width:${pct}%">${pct}%</div>
          </div>
        </td>
      </tr>`; 
  });
  html += '</tbody></table>';
  $('statSummary').innerHTML += html;
}

/* ================== FAMILY ================== */
async function refreshFamilyList(){
  if(!currentWarga) return;
  if(!currentWarga.data.kodeDusun){ 
    $('familyList').innerHTML = '<div class="muted">Belum gabung dusun</div>'; 
    return; 
  }
  try{
    const snap = await db.collection('Warga').where('kodeDusun','==', currentWarga.data.kodeDusun).get();
    if(snap.empty){ 
      $('familyList').innerHTML = '<div class="muted">Tidak ada anggota</div>'; 
      return; 
    }
    const list = [];
    snap.forEach(doc => list.push({ id: doc.id, data: doc.data() }));
    const keyComparator = (d) => `${d.alamat||''}|${d.blok||''}|${d.no||''}|${d.rt||''}|${d.rw||''}`;
    const myKey = keyComparator(currentWarga.data);
    const myMembers = list.filter(x => keyComparator(x.data) === myKey);
    if(!myMembers.length){ 
      $('familyList').innerHTML = '<div class="muted">Belum ada anggota keluarga di alamat ini</div>'; 
      return; 
    }
    let html = '<table class="table table-sm"><thead><tr><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
    myMembers.forEach(m => {
      const d = m.data;
      let aksi = '';
      const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
      if(kepalaRoles.includes(currentWarga.data.role) && m.id !== currentWarga.id){
        aksi = d.status !== 'aktif' ? 
          `<button class="btn btn-sm btn-success" onclick="approveUser('${m.id}')">Verifikasi</button>` : 
          '<span class="muted small">Terverifikasi</span>';
      }
      html += `
        <tr>
          <td>${escapeHtml(d.nama||'')}</td>
          <td>${escapeHtml(d.role||'')}</td>
          <td>${escapeHtml(d.status||'')}</td>
          <td>${aksi}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    $('familyList').innerHTML = html;
  }catch(e){ console.error(e); $('familyList').innerHTML = '<div class="muted">Gagal muat keluarga</div>'; }
}

/* ================== APPROVE USER ================== */
async function approveUser(uid){
  try{ 
    await db.collection('Warga').doc(uid).update({ 
      status:'aktif', 
      approvedBy: currentWarga.id, 
      approvedAt: firebase.firestore.FieldValue.serverTimestamp() 
    }); 
    toast("Warga disetujui"); 
    refreshFamilyList(); 
    loadPendingList(); 
  }catch(e){ console.error(e); err("Gagal approve"); }
}

/* ================== PENDING LIST ================== */
async function loadPendingList(){
  const kepalaRoles = ['kepala_desa','kepala_dusun','ketua_rt_rw','kepala_keluarga'];
  if(!currentWarga || !kepalaRoles.includes(currentWarga.data.role) || !currentWarga.data.kodeDusun) { 
    if($('pendingList')) $('pendingList').innerHTML=''; 
    return; 
  }
  try{
    const snap = await db.collection('Warga').where('kodeDusun','==', currentWarga.data.kodeDusun).where('status','==','pending').get();
    const container = $('pendingList');
    if(!container) return;
    if(snap.empty){ 
      container.innerHTML = '<div class="muted">Tidak ada pendaftar pending</div>'; 
      return; 
    }
    let html=''; 
    snap.forEach(doc => { 
      const d = doc.data(); 
      html += `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <strong>${escapeHtml(d.nama||'')}</strong>
            <div class="muted small">${escapeHtml(d.phone||'')}</div>
          </div>
          <div>
            <button class="btn btn-sm btn-success" onclick="approveUser('${doc.id}')">Setujui</button>
          </div>
        </div>`; 
    });
    container.innerHTML = html;
  }catch(e){ console.error(e); }
}

/* ================== LOAD PENDING VERIFICATIONS ================== */
async function loadPendingVerifications(){
  if(!currentWarga) return;
  
  const container = $('pendingVerifications');
  if(!container) return;
  
  let html = '';
  
  // ✅ KEPALA DESA: lihat pending Kepala Dusun di desa yang sama
  if(currentWarga.data.role === 'kepala_desa' && currentWarga.data.status === 'aktif') {
    const pending = await db.collection('Warga')
      .where('role', '==', 'kepala_dusun')
      .where('desa', '==', currentWarga.data.desa)
      .where('status', '==', 'pending')
      .get();
    
    if(pending.empty) {
      html = '<div class="muted small">Tidak ada Kepala Dusun pending</div>';
    } else {
      pending.forEach(doc => {
        const d = doc.data();
        html += `
          <div class="p-2 border rounded mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${escapeHtml(d.nama)}</strong>
                <div class="small muted">Kepala Dusun · ${escapeHtml(d.dusun || '-')}</div>
                <div class="small muted">${escapeHtml(d.alamat || '')}</div>
              </div>
              <button class="btn btn-sm btn-success" onclick="verifyHierarchyUser('${doc.id}')">Setujui</button>
            </div>
          </div>`;
      });
    }
  }
  
  // ✅ KEPALA DUSUN: lihat pending Ketua RW & RT di dusun yang sama
  else if(currentWarga.data.role === 'kepala_dusun' && currentWarga.data.status === 'aktif') {
    const pending = await db.collection('Warga')
      .where('role', '==', 'ketua_rt_rw')
      .where('desa', '==', currentWarga.data.desa)
      .where('dusun', '==', currentWarga.data.dusun)
      .where('status', '==', 'pending')
      .get();
    
    if(pending.empty) {
      html = '<div class="muted small">Tidak ada Ketua RW/RT pending</div>';
    } else {
      pending.forEach(doc => {
        const d = doc.data();
        const jenis = d.rt && d.rw ? `Ketua RT ${d.rt} / RW ${d.rw}` : 
                     d.rw ? `Ketua RW ${d.rw}` : 'Ketua RT/RW';
        
        html += `
          <div class="p-2 border rounded mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${escapeHtml(d.nama)}</strong>
                <div class="small muted">${jenis} · Dusun ${escapeHtml(d.dusun || '-')}</div>
                <div class="small muted">${escapeHtml(d.alamat || '')}</div>
              </div>
              <button class="btn btn-sm btn-success" onclick="verifyHierarchyUser('${doc.id}')">Setujui</button>
            </div>
          </div>`;
      });
    }
  }
  
  // ✅ KETUA RW: lihat pending Ketua RT di RW yang sama
  else if(currentWarga.data.role === 'ketua_rt_rw' && currentWarga.data.status === 'aktif' && currentWarga.data.rw) {
    const pending = await db.collection('Warga')
      .where('role', '==', 'ketua_rt_rw')
      .where('rw', '==', currentWarga.data.rw)
      .where('status', '==', 'pending')
      .get();
    
    if(pending.empty) {
      html = '<div class="muted small">Tidak ada Ketua RT pending</div>';
    } else {
      pending.forEach(doc => {
        const d = doc.data();
        // Filter hanya yang RT berbeda (asumsi Ketua RT)
        if(d.rt && d.rt !== currentWarga.data.rt) {
          html += `
            <div class="p-2 border rounded mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>${escapeHtml(d.nama)}</strong>
                  <div class="small muted">Ketua RT ${escapeHtml(d.rt)} / RW ${escapeHtml(d.rw)}</div>
                  <div class="small muted">${escapeHtml(d.alamat || '')}</div>
                </div>
                <button class="btn btn-sm btn-success" onclick="verifyHierarchyUser('${doc.id}')">Setujui</button>
              </div>
            </div>`;
        }
      });
    }
  }
  
  // ✅ KETUA RT: lihat pending Kepala Keluarga di RT yang sama
  else if(currentWarga.data.role === 'ketua_rt_rw' && currentWarga.data.rt && currentWarga.data.status === 'aktif') {
    const pending = await db.collection('Warga')
      .where('role', '==', 'kepala_keluarga')
      .where('rt', '==', currentWarga.data.rt)
      .where('rw', '==', currentWarga.data.rw)
      .where('status', '==', 'pending')
      .get();
    
    if(pending.empty) {
      html = '<div class="muted small">Tidak ada Kepala Keluarga pending</div>';
    } else {
      pending.forEach(doc => {
        const d = doc.data();
        html += `
          <div class="p-2 border rounded mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${escapeHtml(d.nama)}</strong>
                <div class="small muted">Kepala Keluarga · RT ${escapeHtml(d.rt)} / RW ${escapeHtml(d.rw)}</div>
                <div class="small muted">${escapeHtml(d.alamat || '')}</div>
              </div>
              <button class="btn btn-sm btn-success" onclick="verifyHierarchyUser('${doc.id}')">Setujui</button>
            </div>
          </div>`;
      });
    }
  }
  
  // ✅ KEPALA KELUARGA: lihat pending anggota keluarga
  else if(currentWarga.data.role === 'kepala_keluarga' && currentWarga.data.status === 'aktif') {
    const pending = await db.collection('Warga')
      .where('kodeReferralUsed', '==', currentWarga.data.kodeReferral)
      .where('status', '==', 'pending_referral')
      .get();
    
    if(pending.empty) {
      html = '<div class="muted small">Tidak ada anggota keluarga pending</div>';
    } else {
      pending.forEach(doc => {
        const d = doc.data();
        html += `
          <div class="p-2 border rounded mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${escapeHtml(d.nama)}</strong>
                <div class="small muted">${escapeHtml(d.role)} · ${escapeHtml(d.alamat || '')}</div>
              </div>
              <button class="btn btn-sm btn-success" onclick="verifyHierarchyUser('${doc.id}')">Setujui</button>
            </div>
          </div>`;
      });
    }
    
    // ✅ TAMPILKAN KODE REFERRAL
    if(currentWarga.data.kodeReferral) {
      html += `
        <div class="p-3 border rounded mt-3 bg-light">
          <div class="text-center">
            <div class="small muted">Kode Referral Anda:</div>
            <div class="h5 text-primary">${currentWarga.data.kodeReferral}</div>
            <div class="small muted">Berikan kode ini ke anggota keluarga untuk registrasi</div>
          </div>
        </div>`;
    }
  }
  
  container.innerHTML = html || '<div class="muted small">Tidak ada yang perlu diverifikasi</div>';
}

/* ================== VERIFY HIERARCHY USER ================== */
async function verifyHierarchyUser(userId){
  try{
    const userDoc = await db.collection('Warga').doc(userId).get();
    if(!userDoc.exists) return err("User tidak ditemukan");
    
    const userData = userDoc.data();
    const currentData = currentWarga.data;
    
    // ✅ CEK APAKAH BISA VERIFIKASI USER INI (berdasarkan hierarki)
    let canVerify = false;
    let reason = "";
    
    if(currentData.role === 'kepala_desa' && 
       userData.role === 'kepala_dusun' && 
       userData.desa === currentData.desa) {
      canVerify = true;
      reason = "Kepala Desa verifikasi Kepala Dusun di desa yang sama";
    }
    else if(currentData.role === 'kepala_dusun' && 
            userData.role === 'ketua_rt_rw' && 
            userData.dusun === currentData.dusun) {
      canVerify = true;
      reason = "Kepala Dusun verifikasi Ketua RW/RT di dusun yang sama";
    }
    else if(currentData.role === 'ketua_rt_rw' && 
            userData.role === 'ketua_rt_rw' && 
            userData.rw === currentData.rw &&
            userData.rt && userData.rt !== currentData.rt) {
      canVerify = true;
      reason = "Ketua RW verifikasi Ketua RT di RW yang sama";
    }
    else if(currentData.role === 'ketua_rt_rw' && currentData.rt &&
            userData.role === 'kepala_keluarga' && 
            userData.rt === currentData.rt && 
            userData.rw === currentData.rw) {
      canVerify = true;
      reason = "Ketua RT verifikasi Kepala Keluarga di RT yang sama";
    }
    else if(currentData.role === 'kepala_keluarga' && 
            userData.kodeReferralUsed === currentData.kodeReferral) {
      canVerify = true;
      reason = "Kepala Keluarga verifikasi anggota dengan kode referral";
    }
    
    if(!canVerify) return err("Anda tidak berwenang memverifikasi user ini");
    
    // ✅ KONFIRMASI VERIFIKASI
    const conf = await Swal.fire({
      title: 'Verifikasi User?',
      html: `Verifikasi <strong>${escapeHtml(userData.nama)}</strong><br>
             <small class="muted">${reason}</small>`,
      icon: 'question',
      showCancelButton: true
    });
    
    if(!conf.isConfirmed) return;
    
    // ✅ LAKUKAN VERIFIKASI
    await db.collection('Warga').doc(userId).update({
      status: userData.role === 'kepala_keluarga' ? 'aktif' : 'aktif',
      verifiedBy: currentWarga.id,
      verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    toast("User berhasil diverifikasi");
    loadPendingVerifications();
    
  }catch(e){ 
    console.error("Verify error:", e); 
    err("Gagal verifikasi: " + (e.message || "Coba lagi")); 
  }
}

/* ================== UTILS ================== */
function generateCode(len=6){ 
  return Math.random().toString(36).substring(2,2+len).toUpperCase(); 
}

/* ================== INITIAL LOAD ================== */
(async function init(){
  try{
    loadRegionDropdowns();
    initMainMap();
    loadKejadianOptions();
    const dSnap = await db.collection('Dusun').limit(1).get();
    if(dSnap.empty){
      const kode = 'DUSUN' + generateCode(3);
      await db.collection('Dusun').add({ 
        nama:'Dusun Demo', 
        kode, 
        desa:'Desaku', 
        kepalaNama:'Budi Demo', 
        kepalaHp:'081200000', 
        kodeExpiresAt: firebase.firestore.Timestamp.fromMillis(Date.now()+3600*1000), 
        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
      });
    }
  }catch(e){ console.warn(e); }
})();

</script>
</body>
</html>
