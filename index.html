<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIKSA-E - Sistem Keamanan Elektronik</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5; --primary-dark: #4338ca; --secondary-color: #06b6d4; --success-color: #10b981;
            --warning-color: #f59e0b; --danger-color: #ef4444; --dark-color: #1e293b; --light-color: #f8fafc;
            --card-bg: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b; --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1); --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-color); color: var(--text-primary); line-height: 1.6; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* --- Professional Header --- */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            min-height: 100px; 
            flex-shrink: 0;
        }
        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .app-title {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.25rem; 
            position: relative;
            z-index: 1;
        }
        .app-subtitle {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        /* --- Layout --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; padding-bottom: 80px; }
        .topbar { background-color: var(--card-bg); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); flex-shrink: 0; }
        .topbar-user { display: flex; align-items: center; gap: 0.75rem; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; }
        .content-area { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }

        /* --- Bottom Navigation --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; padding: 0.5rem 0; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; font-size: 0.75rem; padding: 0.5rem; transition: color 0.2s ease; width: 60px; position: relative; }
        .nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.sos { background: linear-gradient(135deg, var(--danger-color), #dc2626); color: white; border-radius: 50%; width: 70px; height: 70px; margin-top: -30px; box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5); animation: pulse-sos 2s infinite; }
        .nav-item.sos i { font-size: 1.75rem; }
        .notification-badge { position: absolute; top: 0; right: 10px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 0.625rem; font-weight: bold; }
        @keyframes pulse-sos { 0% { box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5); } 70% { box-shadow: 0 8px 35px rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5); } }

        /* --- Components --- */
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; }
        .page-subtitle { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem; }
        .card { background-color: var(--card-bg); border-radius: 0.75rem; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 1rem; }
        .card-body { padding: 1.5rem; }
        .btn { padding: 0.75rem 1.5rem; font-weight: 500; border-radius: 0.5rem; border: none; cursor: pointer; font-size: 1rem; }
        .btn-danger { background-color: var(--danger-color); color: white; width: 100%; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { font-weight: 500; margin-bottom: 0.5rem; display: block; }
        .form-control, .form-select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 1rem; }
        .map-container { height: 250px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; }
        .view { display: none; }
        .view.active { display: block; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-secondary) !important; }
        
        /* --- Home View --- */
        .dusun-info { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; box-shadow: var(--shadow-lg); margin-bottom: 1.5rem; }
        .dusun-info h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .security-status-widget { background: linear-gradient(135deg, var(--success-color), #059669); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; box-shadow: var(--shadow-lg); margin-bottom: 1.5rem; }
        .security-status-widget.danger { background: linear-gradient(135deg, var(--danger-color), #dc2626); }
        .security-status-widget.warning { background: linear-gradient(135deg, var(--warning-color), #d97706); }
        .security-status-widget h2 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .security-status-widget p { font-size: 0.875rem; opacity: 0.9; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { display: flex; align-items: center; padding: 1rem; background-color: var(--card-bg); border-radius: 0.75rem; box-shadow: var(--shadow-sm); border-left: 4px solid; }
        .stat-card.success { border-left-color: var(--success-color); } .stat-card.warning { border-left-color: var(--warning-color); } .stat-card.danger { border-left-color: var(--danger-color); } .stat-card.info { border-left-color: var(--secondary-color); }
        .stat-icon { width: 40px; height: 40px; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; margin-right: 1rem; }
        .stat-card.success .stat-icon { background-color: var(--success-color); } .stat-card.warning .stat-icon { background-color: var(--warning-color); } .stat-card.danger .stat-icon { background-color: var(--danger-color); } .stat-card.info .stat-icon { background-color: var(--secondary-color); }
        .stat-info h3 { font-size: 1.5rem; font-weight: 700; margin: 0; } .stat-info p { margin: 0; color: var(--text-secondary); font-size: 0.75rem; }
        .report-list-item { display: flex; align-items: flex-start; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .report-list-item:last-child { border-bottom: none; }
        .report-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem; flex-shrink: 0; font-size: 0.875rem; }
        .report-icon.kemalingan { background-color: var(--danger-color); } .report-icon.kebakaran { background-color: var(--warning-color); } .report-icon.ambulance { background-color: var(--secondary-color); } .report-icon.mencurigakan { background-color: var(--warning-color); } .report-icon.keributan { background-color: #8b5cf6; } .report-icon.lainnya { background-color: var(--text-secondary); }
        .report-content h5 { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem;} .report-content p { color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem; }
        .report-meta { display: flex; align-items: center; gap: 1rem; font-size: 0.625rem; color: var(--text-secondary); flex-wrap: wrap; }
        .report-status { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600; text-transform: uppercase; }
        .report-status.selesai { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); } .report-status.belum_selesai { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
        .notification-card { border-left: 5px solid var(--warning-color); background-color: rgba(245, 158, 11, 0.05); padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; }
        .notification-card h5 { font-weight: 600; margin-bottom: 0.5rem; }
        .profile-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        .profile-item:last-child { border-bottom: none; }
        .profile-item a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .profile-item a:hover { text-decoration: underline; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--card-bg); margin: 15% auto; padding: 1.5rem; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 0.75rem; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; } .close:hover,.close:focus { color: black; text-decoration: none; cursor: pointer; }
        .reporter-name-link { color: var(--primary-color); text-decoration: none; font-weight: 500; cursor: pointer; }
        .reporter-name-link:hover { text-decoration: underline; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .filter-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        
        /* --- New Styles --- */
        .code-timer { background-color: var(--primary-color); color: white; padding: 0.75rem; border-radius: 0.5rem; text-align: center; margin-bottom: 1rem; }
        .code-timer h4 { margin-bottom: 0.5rem; }
        .code-display { font-family: monospace; font-size: 1.25rem; font-weight: bold; letter-spacing: 2px; background-color: rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 0.25rem; margin: 0.5rem 0; }
        .pos-ronda-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .pos-ronda-item:last-child { border-bottom: none; }
        .pos-ronda-icon { width: 40px; height: 40px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; margin-right: 1rem; }
        .pos-ronda-info h5 { font-weight: 600; margin-bottom: 0.25rem; }
        .pos-ronda-info p { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .pos-status { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .pos-status.aktif { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); }
        .pos-status.nonaktif { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color); }
        .contact-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .contact-item:last-child { border-bottom: none; }
        .contact-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 1rem; }
        .contact-info h5 { font-weight: 600; margin-bottom: 0.25rem; }
        .contact-info p { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .contact-action { margin-left: auto; }
        .photo-gallery { display: flex; gap: 0.5rem; margin-top: 0.5rem; overflow-x: auto; }
        .photo-thumb { width: 80px; height: 80px; border-radius: 0.5rem; object-fit: cover; flex-shrink: 0; cursor: pointer; transition: transform 0.2s; }
        .photo-thumb:hover { transform: scale(1.05); }
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tab-nav-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; }
        .tab-nav-item.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dusun-status-card { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .dusun-status-card.aman { background-color: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--success-color); }
        .dusun-status-card.waspada { background-color: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning-color); }
        .dusun-status-card.bahaya { background-color: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger-color); }
        .dusun-status-card h5 { font-weight: 600; margin-bottom: 0.5rem; }
        .dusun-status-card p { margin-bottom: 0.25rem; font-size: 0.875rem; }
        .verification-badge { background-color: var(--warning-color); color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; }
        .verification-badge.verified { background-color: var(--success-color); }
        
        /* --- Emergency Type Icons --- */
        .emergency-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .emergency-type { display: flex; flex-direction: column; align-items: center; padding: 1rem; border-radius: 0.75rem; border: 2px solid var(--border-color); cursor: pointer; transition: all 0.2s ease; }
        .emergency-type:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .emergency-type.selected { border-color: var(--primary-color); background-color: rgba(79, 70, 229, 0.05); }
        .emergency-type i { font-size: 2rem; margin-bottom: 0.5rem; }
        .emergency-type.kemalingan i { color: var(--danger-color); }
        .emergency-type.kebakaran i { color: var(--warning-color); }
        .emergency-type.ambulance i { color: var(--secondary-color); }
        .emergency-type.mencurigakan i { color: var(--warning-color); }
        .emergency-type.keributan i { color: #8b5cf6; }
        .emergency-type.lainnya i { color: var(--text-secondary); }
        .emergency-type span { font-size: 0.875rem; font-weight: 500; }
        
        /* --- Detail Modal --- */
        .detail-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .detail-modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 1.5rem; border: 1px solid var(--border-color); width: 90%; max-width: 800px; border-radius: 0.75rem; animation: fadeIn 0.3s; position: relative; }
        .detail-close { position: absolute; top: 1rem; right: 1rem; color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; }
        .detail-close:hover { color: var(--danger-color); }
        .incident-list { margin-top: 1rem; }
        .incident-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .incident-item:last-child { border-bottom: none; }
        .incident-type { display: flex; align-items: center; }
        .incident-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 0.75rem; font-size: 0.875rem; }
        .incident-count { font-weight: 600; font-size: 1.25rem; }
        
        /* --- Pagination --- */
        .pagination { display: flex; justify-content: center; margin-top: 1rem; }
        .pagination button { padding: 0.5rem 0.75rem; margin: 0 0.25rem; border: 1px solid var(--border-color); background-color: var(--card-bg); border-radius: 0.25rem; cursor: pointer; }
        .pagination button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* --- Image Modal --- */
        .image-modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
        .image-modal-content { margin: auto; display: block; max-width: 90%; max-height: 90%; margin-top: 5%; }
        .image-modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        
        /* --- Role Switcher --- */
        .role-switcher { background-color: rgba(79, 70, 229, 0.1); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
        .role-switcher h5 { margin-bottom: 0.5rem; }
        .role-switcher select { width: 100%; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid var(--border-color); }
        
        /* --- Activity Feed --- */
        .activity-feed { max-height: 300px; overflow-y: auto; }
        .activity-item { display: flex; align-items: flex-start; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 0.75rem; flex-shrink: 0; font-size: 0.875rem; }
        .activity-content { flex-grow: 1; }
        .activity-content p { margin: 0; font-size: 0.875rem; }
        .activity-time { font-size: 0.75rem; color: var(--text-secondary); }
        
        /* --- Sanction List --- */
        .sanction-list { margin-top: 1rem; }
        .sanction-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .sanction-item:last-child { border-bottom: none; }
        .sanction-info h5 { font-weight: 600; margin-bottom: 0.25rem; }
        .sanction-info p { font-size: 0.875rem; color: var(--text-secondary); margin: 0; }
        .sanction-badge { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .sanction-badge.warning { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
        .sanction-badge.danger { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color); }
    </style>
</head>
<body>

    <!-- Professional App Header -->
    <header class="app-header">
        <h1 class="app-title">SIKSA-E</h1>
        <p class="app-subtitle">Sistem Keamanan Elektronik</p>
    </header>

    <main class="main-content">
        <!-- Topbar -->
        <header class="topbar">
            <div>
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <p class="page-subtitle" id="page-subtitle">Ringkasan keamanan desa Anda.</p>
            </div>
            <div class="topbar-user">
                <span style="font-size: 0.875rem;" id="topbar-username">Budi Santoso</span>
                <div class="user-avatar" id="topbar-avatar">BS</div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="content-area">
            <div id="alert-container"></div>
            
            <!-- HOME VIEW -->
            <div id="home-view" class="view active">
                <div class="dusun-info">
                    <h3 id="dusun-name">Semua Dusun</h3>
                    <p id="desa-name">Desa: Mekar Jaya</p>
                    <p id="user-role">Kepala Desa</p>
                </div>

                <!-- PERUBAHAN: Widget Kode Akses akan dikontrol oleh JavaScript -->
                <div class="code-timer" id="code-timer" style="display: none;">
                    <h4 id="code-timer-title">Kode Akses</h4>
                    <div class="code-display" id="code-display">------</div>
                    <p>Pembaruan dalam: <span id="countdown">--:--:--</span></p>
                </div>

                <div id="notification-panel"></div>

                <div class="security-status-widget" id="security-status-widget">
                    <i class="fas fa-shield-alt" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                    <h2 id="security-status-text">KEAMANAN AMAN</h2>
                    <p id="security-status-desc">Tingkat risiko rendah. <span id="security-percentage">(0%)</span></p>
                </div>

                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-line me-2"></i>Tingkat Keamanan (30 Hari Terakhir)</div>
                    <div class="card-body"><div class="chart-container"><canvas id="securityTrendChart"></canvas></div></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card info"><div class="stat-icon"><i class="fas fa-file-alt"></i></div><div class="stat-info"><h3 id="stat-total">12</h3><p>Total Laporan</p></div></div>
                    <div class="stat-card success"><div class="stat-icon"><i class="fas fa-check-circle"></i></div><div class="stat-info"><h3 id="stat-selesai">10</h3><p>Selesai</p></div></div>
                    <div class="stat-card warning"><div class="stat-icon"><i class="fas fa-clock"></i></div><div class="stat-info"><h3 id="stat-menunggu">2</h3><p>Menunggu</p></div></div>
                    <div class="stat-card danger"><div class="stat-icon"><i class="fas fa-history"></i></div><div class="stat-info"><h3>Aktivitas</h3><p>Terbaru</p></div></div>
                </div>

                <div class="card">
                    <div class="card-header"><i class="fas fa-history me-2"></i> Laporan Terbaru</div>
                    <div class="card-body" id="recent-reports-list"></div>
                </div>
            </div>

            <!-- STATISTIK VIEW -->
            <div id="statistik-view" class="view">
                <div class="card"><div class="card-header">Jenis Laporan (Bulan Ini)</div><div class="card-body"><div class="chart-container"><canvas id="reportTypeChart"></canvas></div></div></div>
                <div class="card"><div class="card-header">Tingkat Penyelesaian</div><div class="card-body"><div class="chart-container"><canvas id="resolutionRateChart"></canvas></div></div></div>
                <div class="card" id="dusun-status-cards" style="display: none;"><div class="card-header">Status Keamanan per Dusun</div><div class="card-body" id="dusun-status-container"></div></div>
            </div>

            <!-- SOS VIEW -->
            <div id="sos-view" class="view">
                <div class="card">
                    <div class="card-header">Buat Laporan Darurat</div>
                    <div class="card-body">
                        <form id="create-report-form">
                            <div class="form-group">
                                <label class="form-label">Jenis Kejadian</label>
                                <div class="emergency-types">
                                    <div class="emergency-type kemalingan" data-type="kemalingan">
                                        <i class="fas fa-user-secret"></i>
                                        <span>Kemalingan</span>
                                    </div>
                                    <div class="emergency-type kebakaran" data-type="kebakaran">
                                        <i class="fas fa-fire"></i>
                                        <span>Kebakaran</span>
                                    </div>
                                    <div class="emergency-type ambulance" data-type="ambulance">
                                        <i class="fas fa-ambulance"></i>
                                        <span>Ambulance</span>
                                    </div>
                                    <div class="emergency-type mencurigakan" data-type="mencurigakan">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>Mencurigakan</span>
                                    </div>
                                    <div class="emergency-type keributan" data-type="keributan">
                                        <i class="fas fa-users"></i>
                                        <span>Keributan</span>
                                    </div>
                                    <div class="emergency-type lainnya" data-type="lainnya">
                                        <i class="fas fa-ellipsis-h"></i>
                                        <span>Lainnya</span>
                                    </div>
                                </div>
                                <input type="hidden" id="report-type" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lokasi Kejadian</label>
                                <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                                    <div><input type="radio" id="loc-home" name="location-type" value="home" checked> <label for="loc-home">Di Rumah</label></div>
                                    <div><input type="radio" id="loc-other" name="location-type" value="other"> <label for="loc-other">Di Alamat Lain</label></div>
                                </div>
                                <input type="text" class="form-control" id="report-location" placeholder="Alamat akan terisi otomatis" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="report-description">Deskripsi Kejadian (Opsional)</label>
                                <textarea class="form-control" id="report-description" rows="4" placeholder="Jelaskan secara detail kejadian yang terjadi."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lokasi di Peta (GPS Anda)</label>
                                <div id="map" class="map-container"></div>
                                <input type="hidden" id="report-lat"><input type="hidden" id="report-lng">
                            </div>
                            <button type="submit" class="btn btn-danger"><i class="fas fa-paper-plane me-2"></i>KIRIM LAPORAN SEKARANG</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- LAPORAN VIEW -->
            <div id="laporan-view" class="view">
                <div class="card">
                    <div class="card-header">Daftar Laporan</div>
                    <div class="card-body">
                        <div class="tab-nav">
                            <div class="tab-nav-item active" onclick="switchReportTab('my-reports')">Laporan Saya</div>
                            <div class="tab-nav-item" onclick="switchReportTab('other-reports')">Laporan Warga Lain</div>
                        </div>
                        
                        <div id="my-reports" class="tab-content active">
                            <div class="filter-bar">
                                <select class="form-select" id="my-filter-month"><option value="">Semua Bulan</option><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option><option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option></select>
                                <input type="date" class="form-control" id="my-filter-date" style="max-width: 150px;">
                                <select class="form-select" id="my-filter-type">
                                    <option value="">Semua Jenis</option>
                                    <option value="kemalingan">Kemalingan</option>
                                    <option value="kebakaran">Kebakaran</option>
                                    <option value="ambulance">Ambulance</option>
                                    <option value="mencurigakan">Mencurigakan</option>
                                    <option value="keributan">Keributan</option>
                                    <option value="lainnya">Lainnya</option>
                                </select>
                                <select class="form-select" id="my-filter-status"><option value="">Semua Status</option><option value="selesai">Selesai</option><option value="belum_selesai">Belum Selesai</option></select>
                            </div>
                            <div id="my-reports-list"></div>
                            <div class="pagination" id="my-reports-pagination"></div>
                        </div>
                        
                        <div id="other-reports" class="tab-content">
                            <div class="filter-bar">
                                <select class="form-select" id="other-filter-month"><option value="">Semua Bulan</option><option value="1">Januari</option><option value="2">Februari</option><option value="3">Maret</option><option value="4">April</option><option value="5">Mei</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">Agustus</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option></select>
                                <input type="date" class="form-control" id="other-filter-date" style="max-width: 150px;">
                                <select class="form-select" id="other-filter-type">
                                    <option value="">Semua Jenis</option>
                                    <option value="kemalingan">Kemalingan</option>
                                    <option value="kebakaran">Kebakaran</option>
                                    <option value="ambulance">Ambulance</option>
                                    <option value="mencurigakan">Mencurigakan</option>
                                    <option value="keributan">Keributan</option>
                                    <option value="lainnya">Lainnya</option>
                                </select>
                                <select class="form-select" id="other-filter-status"><option value="">Semua Status</option><option value="selesai">Selesai</option><option value="belum_selesai">Belum Selesai</option></select>
                            </div>
                            <div id="other-reports-list"></div>
                            <div class="pagination" id="other-reports-pagination"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROFIL VIEW -->
            <div id="profil-view" class="view">
                <div class="card">
                    <div class="card-header">Informasi Akun</div>
                    <div class="card-body">
                        <div class="role-switcher">
                            <h5>Uji Coba Role (Demo)</h5>
                            <select id="role-switcher">
                                <option value="user_1">Kepala Desa</option>
                                <option value="user_2">Kepala Dusun</option>
                                <option value="user_3">Ketua RW</option>
                                <option value="user_4">Ketua RT</option>
                                <option value="user_5">Kepala Keluarga</option>
                            </select>
                        </div>
                        <div class="profile-item"><span>Nama</span><span id="profile-name">Budi Santoso</span></div>
                        <div class="profile-item"><span>No. HP</span><span id="profile-phone">08123456789</span></div>
                        <div class="profile-item"><span>Email</span><span id="profile-email">budi.santoso@example.com</span></div>
                        <div class="profile-item"><span>Role</span><span id="profile-role">Kepala Desa</span></div>
                        <div class="profile-item"><span>Desa</span><span id="profile-desa">Mekar Jaya</span></div>
                        <div class="profile-item"><span>Dusun</span><span id="profile-dusun">-</span></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Gabung ke Dusun</div>
                    <div class="card-body">
                        <form id="join-dusun-form">
                            <div class="form-group">
                                <label class="form-label" for="join-dusun-code">Kode Dusun</label>
                                <input type="text" class="form-control" id="join-dusun-code" placeholder="Masukkan kode dusun" required>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt me-2"></i>Gabung ke Dusun</button>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Pengaturan</div>
                    <div class="card-body">
                        <div class="profile-item"><span>Ubah Role</span><a href="#" onclick="openRoleChangeModal()">Ajukan Perubahan</a></div>
                        <div class="profile-item"><span>Ubah Password</span><a href="#" onclick="alert('Fitur ubah password dinonaktifkan untuk demo.')">Ubah</a></div>
                        <div class="profile-item"><span>Keluar Akun</span><a href="#" onclick="if(confirm('Apakah Anda yakin ingin keluar?')) location.reload();">Logout</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header text-danger">Bahaya</div>
                    <div class="card-body">
                        <div class="profile-item"><span>Hapus Akun</span><a href="#" style="color: var(--danger-color);" onclick="if(confirm('PERHATIAN: Tindakan ini tidak dapat dibatalkan dan semua data Anda akan hilang. Yakin?')) alert('Akun dihapus (simulasi).');">Hapus</a></div>
                    </div>
                </div>
            </div>

            <!-- POS RONDA VIEW -->
            <div id="pos-ronda-view" class="view">
                <div class="card">
                    <div class="card-header">Pos Ronda</div>
                    <div class="card-body">
                        <div class="tab-nav">
                            <div class="tab-nav-item active" onclick="switchTab('pos-list')">Daftar Pos</div>
                            <div class="tab-nav-item" onclick="switchTab('add-pos')">Tambah Pos</div>
                        </div>
                        
                        <div id="pos-list" class="tab-content active">
                            <div id="pos-ronda-list"></div>
                        </div>
                        
                        <div id="add-pos" class="tab-content">
                            <form id="add-pos-form">
                                <div class="form-group">
                                    <label class="form-label" for="pos-name">Nama Pos</label>
                                    <input type="text" class="form-control" id="pos-name" placeholder="Contoh: POS RT 01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="pos-status">
                                        <option value="aktif">Aktif</option>
                                        <option value="nonaktif">Nonaktif</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Lokasi di Peta</label>
                                    <div id="pos-map" class="map-container"></div>
                                    <input type="hidden" id="pos-lat"><input type="hidden" id="pos-lng">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Foto Pos (Maksimal 5)</label>
                                    <input type="file" class="form-control" id="pos-photos" multiple accept="image/*">
                                    <div class="photo-gallery" id="pos-photo-preview"></div>
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>TAMBAH POS</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DESA MANAGEMENT VIEW (FOR KEPALA DESA) -->
            <div id="desa-management-view" class="view">
                <div class="card">
                    <div class="card-header">Manajemen Desa</div>
                    <div class="card-body">
                        <div class="tab-nav">
                            <div class="tab-nav-item active" onclick="switchDesaTab('desa-info')">Informasi Desa</div>
                            <div class="tab-nav-item" onclick="switchDesaTab('dusun-list')">Daftar Dusun</div>
                            <div class="tab-nav-item" onclick="switchDesaTab('add-dusun')">Tambah Dusun</div>
                            <div class="tab-nav-item" onclick="switchDesaTab('verifikasi-kepala')">Verifikasi Kepala Dusun</div>
                        </div>
                        
                        <div id="desa-info" class="tab-content active">
                            <div class="form-group">
                                <label class="form-label" for="desa-name-input">Nama Desa</label>
                                <input type="text" class="form-control" id="desa-name-input" value="Mekar Jaya">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kode Desa</label>
                                <div class="code-display" id="desa-code-display">------</div>
                                <p>Pembaruan dalam: <span id="desa-countdown">--:--:--</span></p>
                            </div>
                            <button class="btn btn-primary" onclick="updateDesaInfo()">Simpan Perubahan</button>
                        </div>
                        
                        <div id="dusun-list" class="tab-content">
                            <div id="dusun-list-container"></div>
                        </div>
                        
                        <div id="add-dusun" class="tab-content">
                            <form id="add-dusun-form">
                                <div class="form-group">
                                    <label class="form-label" for="new-dusun-name">Nama Dusun</label>
                                    <input type="text" class="form-control" id="new-dusun-name" placeholder="Contoh: Mekar Sari" required>
                                </div>
                                <p class="text-muted">Kepala dusun akan ditetapkan setelah verifikasi oleh kepala desa.</p>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>TAMBAH DUSUN</button>
                            </form>
                        </div>
                        
                        <div id="verifikasi-kepala" class="tab-content">
                            <h5>Permintaan Verifikasi Kepala Dusun</h5>
                            <div id="verifikasi-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AKTIVITAS VIEW -->
            <div id="aktivitas-view" class="view">
                <div class="card">
                    <div class="card-header">Aktivitas Terkini</div>
                    <div class="card-body">
                        <div class="activity-feed" id="activity-feed"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Daftar Sanksi</div>
                    <div class="card-body">
                        <div class="sanction-list" id="sanction-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-view="home"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="#" class="nav-item" data-view="statistik"><i class="fas fa-chart-bar"></i><span>Statistik</span></a>
        <a href="#" class="nav-item" data-view="pos-ronda"><i class="fas fa-shield-alt"></i><span>Pos</span></a>
        <a href="#" class="nav-item sos" data-view="sos"><i class="fas fa-exclamation"></i><span>SOS</span></a>
        <a href="#" class="nav-item" data-view="laporan"><i class="fas fa-list-alt"></i><span>Laporan</span></a>
        <a href="#" class="nav-item" data-view="aktivitas" id="aktivitas-nav"><i class="fas fa-history"></i><span>Aktivitas</span></a>
        <a href="#" class="nav-item" data-view="desa-management" id="desa-management-nav" style="display: none;"><i class="fas fa-building"></i><span>Desa</span></a>
        <a href="#" class="nav-item" data-view="profil"><i class="fas fa-user"></i><span>Profil</span></a>
    </nav>

    <!-- Modals -->
    <div id="roleChangeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('roleChangeModal')">&times;</span>
            <h4>Ajukan Perubahan Role</h4>
            <p>Pilih role baru yang Anda inginkan. Permintaan akan menunggu persetujuan dari atasan Anda.</p>
            <div class="form-group">
                <label class="form-label">Role Baru</label>
                <select class="form-select" id="new-role-select">
                    <option value="">Pilih Role</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="submitRoleChange()">Kirim Permintaan</button>
        </div>
    </div>

    <div id="sanctionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sanctionModal')">&times;</span>
            <h4>Berikan Sanksi</h4>
            <p>Anda akan memberikan sanksi kepada: <strong id="sanction-user-name"></strong></p>
            <div class="form-group">
                <label class="form-label">Jenis Sanksi</label>
                <select class="form-select" id="sanction-type">
                    <option value="peringatan">Peringatan</option>
                    <option value="nonaktif">Nonaktifkan Sementara</option>
                    <option value="blokir">Blokir Permanen</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Alasan</label>
                <textarea class="form-control" id="sanction-reason" rows="3" placeholder="Jelaskan alasan pemberian sanksi."></textarea>
            </div>
            <button class="btn btn-danger" style="width: 100%;" onclick="submitSanction()">Berikan Sanksi</button>
        </div>
    </div>

    <div id="posDetailModal" class="detail-modal">
        <div class="detail-modal-content">
            <span class="detail-close" onclick="closeModal('posDetailModal')">&times;</span>
            <h4 id="pos-detail-name">Detail Pos Ronda</h4>
            <div class="form-group">
                <label class="form-label">Status</label>
                <span class="pos-status" id="pos-detail-status">Aktif</span>
            </div>
            <div class="form-group">
                <label class="form-label">Lokasi</label>
                <div id="pos-detail-map" class="map-container"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Foto Pos</label>
                <div class="photo-gallery" id="pos-detail-photos"></div>
            </div>
            <div class="form-group" id="pos-actions">
                <button class="btn btn-primary" onclick="editPos()"><i class="fas fa-edit me-2"></i>Ubah</button>
                <button class="btn btn-danger" onclick="deletePos()"><i class="fas fa-trash me-2"></i>Hapus</button>
            </div>
        </div>
    </div>

    <!-- Dusun Detail Modal -->
    <div id="dusunDetailModal" class="detail-modal">
        <div class="detail-modal-content">
            <span class="detail-close" onclick="closeModal('dusunDetailModal')">&times;</span>
            <h4 id="dusun-detail-name">Detail Kejadian Dusun</h4>
            <div class="incident-list" id="dusun-incident-list"></div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close" onclick="closeModal('imageModal')">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- MOCK DATA & STATE ---
        const currentUser = {
            uid: 'user_1', name: 'Budi Santoso', email: 'budi.santoso@example.com', phone: '08123456789',
            role_id: 1, role_name: 'Kepala Desa', dusun_id: null, dusun_name: null,
            desa_id: 'desa_1', desa_name: 'Mekar Jaya',
            home_address: 'Jl. Merdeka No. 1, Desa Mekar Jaya', is_blocked: false,
            rt_id: null, rt_name: null
        };

        // Desa and Dusun data
        let mockDesa = {
            id: 'desa_1',
            name: 'Mekar Jaya',
            code: generateRandomCode(),
            code_expiry: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours from now
            dusuns: [
                {
                    id: 'dusun_1',
                    name: 'Mekar Sari',
                    code: generateRandomCode(),
                    code_expiry: new Date(Date.now() + 24 * 60 * 60 * 1000),
                    kepala_dusun_uid: 'user_2',
                    kepala_dusun_name: 'Ahmad Fadli',
                    kepala_verified: true,
                    rts: [
                        { id: 'rt_1', name: 'RT 01' },
                        { id: 'rt_2', name: 'RT 02' }
                    ]
                },
                {
                    id: 'dusun_2',
                    name: 'Mekar Wangi',
                    code: generateRandomCode(),
                    code_expiry: new Date(Date.now() + 24 * 60 * 60 * 1000),
                    kepala_dusun_uid: 'user_5',
                    kepala_dusun_name: 'Siti Aminah',
                    kepala_verified: true,
                    rts: [
                        { id: 'rt_3', name: 'RT 01' },
                        { id: 'rt_4', name: 'RT 02' }
                    ]
                },
                {
                    id: 'dusun_3',
                    name: 'Mekar Indah',
                    code: generateRandomCode(),
                    code_expiry: new Date(Date.now() + 24 * 60 * 60 * 1000),
                    kepala_dusun_uid: null,
                    kepala_dusun_name: null,
                    kepala_verified: false,
                    rts: []
                }
            ]
        };

        let mockReports = [
            { id: '1', type: 'kemalingan', location: 'Jl. Merdeka No. 10', description: 'Sepeda motor di depan rumah raib.', status: 'belum_selesai', created_at: new Date(), reporter: 'Siti Aminah', reporter_uid: 'user_6', dusun_id: 'dusun_1' },
            { id: '2', type: 'kebakaran', location: 'Dekat Pos Ronda 2', description: 'Ada sampah yang terbakar, sudah dipadamkan.', status: 'selesai', created_at: new Date(Date.now() - 3600000), reporter: 'Budi Santoso', reporter_uid: 'user_7', dusun_id: 'dusun_1' },
            { id: '3', type: 'mencurigakan', location: 'Perempatan jalan', description: 'Orang asing mondar-mandir.', status: 'selesai', created_at: new Date(Date.now() - 7200000), reporter: 'Rina Wijaya', reporter_uid: 'user_8', dusun_id: 'dusun_1' },
            { id: '4', type: 'ambulance', location: 'Rumah Bapak Haji Hasan', description: 'Ibu Hasan sakit dada, butuh bantuan.', status: 'selesai', created_at: new Date(Date.now() - 10800000), reporter: 'Joko Pribadi', reporter_uid: 'user_9', dusun_id: 'dusun_1' },
            { id: '5', type: 'keributan', location: 'Warung Pak Joko', description: 'Ada keributan kecil, sudah diselesaikan.', status: 'selesai', created_at: new Date(Date.now() - 86400000), reporter: 'Warung Pak Joko', reporter_uid: 'user_10', dusun_id: 'dusun_1' },
            { id: '6', type: 'kemalingan', location: 'Jl. Melati No. 5', description: 'Sound system di depan rumah dicuri.', status: 'selesai', created_at: new Date(Date.now() - 2 * 86400000), reporter: 'Suparman', reporter_uid: 'user_11', dusun_id: 'dusun_1' },
            { id: '7', type: 'kemalingan', location: 'Jl. Anggrek No. 1', description: 'Gembok pagar dirusak.', status: 'selesai', created_at: new Date(Date.now() - 5 * 86400000), reporter: 'Wahyu Hidayat', reporter_uid: 'user_12', dusun_id: 'dusun_1' },
            { id: '8', type: 'kebakaran', location: 'Dusun Mekar Wangi', description: 'Kebakaran kecil di kebun.', status: 'selesai', created_at: new Date(Date.now() - 3 * 86400000), reporter: 'Rudi Hartono', reporter_uid: 'user_13', dusun_id: 'dusun_2' },
        ];

        let mockUsers = [
            { uid: 'user_1', name: 'Budi Santoso', role_id: 1, role_name: 'Kepala Desa', dusun_id: null },
            { uid: 'user_2', name: 'Ahmad Fadli', role_id: 2, role_name: 'Kepala Dusun', dusun_id: 'dusun_1' },
            { uid: 'user_3', name: 'Slamet Rahardjo', role_id: 3, role_name: 'Ketua RW', dusun_id: 'dusun_1' },
            { uid: 'user_4', name: 'Joko Pribadi', role_id: 4, role_name: 'Ketua RT', dusun_id: 'dusun_1', rt_id: 'rt_1' },
            { uid: 'user_5', name: 'Siti Aminah', role_id: 2, role_name: 'Kepala Dusun', dusun_id: 'dusun_2' },
            { uid: 'user_6', name: 'Anak Istri', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_1' },
            { uid: 'user_7', name: 'Budi Santoso', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_1' },
            { uid: 'user_8', name: 'Rina Wijaya', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_1' },
            { uid: 'user_9', name: 'Joko Pribadi', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_1' },
            { uid: 'user_10', name: 'Warung Pak Joko', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_1' },
            { uid: 'user_11', name: 'Suparman', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_1' },
            { uid: 'user_12', name: 'Wahyu Hidayat', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_1' },
            { uid: 'user_13', name: 'Rudi Hartono', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_2' },
            { uid: 'user_14', name: 'Rudi Hermawan', role_id: 5, role_name: 'Kepala Keluarga', dusun_id: 'dusun_3' },
        ];

        let mockRoleChangeRequests = [];
        let mockKepalaDusunRequests = [
            {
                id: 'req_1',
                dusun_id: 'dusun_3',
                dusun_name: 'Mekar Indah',
                requester_uid: 'user_14',
                requester_name: 'Rudi Hermawan',
                status: 'pending',
                created_at: new Date(Date.now() - 2 * 3600000)
            }
        ];

        let mockPosRonda = [
            {
                id: 'pos_1',
                name: 'POS RT 01',
                status: 'aktif',
                lat: -6.2088,
                lng: 106.8456,
                photos: [
                    'https://picsum.photos/seed/pos1a/400/300.jpg',
                    'https://picsum.photos/seed/pos1b/400/300.jpg',
                    'https://picsum.photos/seed/pos1c/400/300.jpg'
                ],
                dusun_id: 'dusun_1',
                rt_id: 'rt_1',
                created_by: 'user_4',
                created_at: new Date(Date.now() - 5 * 86400000)
            },
            {
                id: 'pos_2',
                name: 'POS RT 02',
                status: 'aktif',
                lat: -6.2100,
                lng: 106.8470,
                photos: [
                    'https://picsum.photos/seed/pos2a/400/300.jpg',
                    'https://picsum.photos/seed/pos2b/400/300.jpg'
                ],
                dusun_id: 'dusun_1',
                rt_id: 'rt_2',
                created_by: 'user_2',
                created_at: new Date(Date.now() - 10 * 86400000)
            },
            {
                id: 'pos_3',
                name: 'POS DUSUN MEKAR WANGI',
                status: 'nonaktif',
                lat: -6.2050,
                lng: 106.8430,
                photos: [
                    'https://picsum.photos/seed/pos3a/400/300.jpg',
                    'https://picsum.photos/seed/pos3b/400/300.jpg',
                    'https://picsum.photos/seed/pos3c/400/300.jpg',
                    'https://picsum.photos/seed/pos3d/400/300.jpg',
                    'https://picsum.photos/seed/pos3e/400/300.jpg'
                ],
                dusun_id: 'dusun_2',
                rt_id: null,
                created_by: 'user_5',
                created_at: new Date(Date.now() - 15 * 86400000)
            }
        ];

        let mockSanctions = [];
        let mockActivities = [];

        let map = null, posMap = null, currentMarker = null, currentSanctionTarget = null, currentPosMarker = null, currentPosDetail = null;
        
        // Notification state
        let notifications = {
            home: false,
            statistik: false,
            'pos-ronda': false,
            sos: false,
            laporan: false,
            'desa-management': false,
            profil: false,
            aktivitas: false
        };

        // Pagination state
        let myReportsPage = 1;
        let otherReportsPage = 1;
        const reportsPerPage = 5;

        // --- UTILITY FUNCTIONS ---
        function generateRandomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function updateCodeCountdown() {
            const now = new Date();
            const codeTimerWidget = document.getElementById('code-timer');
            const codeDisplay = document.getElementById('code-display');
            
            // Update desa code countdown if user is kepala desa
            if (currentUser.role_id === 1) {
                const desaTimeLeft = mockDesa.code_expiry - now;
                if (desaTimeLeft <= 0) {
                    mockDesa.code = generateRandomCode();
                    mockDesa.code_expiry = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                    if(codeTimerWidget.style.display !== 'none') {
                        codeDisplay.textContent = mockDesa.code;
                    }
                }
                
                const desaHours = Math.floor(desaTimeLeft / (1000 * 60 * 60));
                const desaMinutes = Math.floor((desaTimeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const desaSeconds = Math.floor((desaTimeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').textContent = 
                    `${desaHours.toString().padStart(2, '0')}:${desaMinutes.toString().padStart(2, '0')}:${desaSeconds.toString().padStart(2, '0')}`;
            }
            
            // Update dusun code countdown if user is kepala dusun
            if (currentUser.role_id === 2 && currentUser.dusun_id) {
                const dusun = mockDesa.dusuns.find(d => d.id === currentUser.dusun_id);
                if (dusun) {
                    const timeLeft = dusun.code_expiry - now;
                    if (timeLeft <= 0) {
                        dusun.code = generateRandomCode();
                        dusun.code_expiry = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                        if(codeTimerWidget.style.display !== 'none') {
                            codeDisplay.textContent = dusun.code;
                        }
                    }
                    
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                    
                    document.getElementById('countdown').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
        }

        // --- VIEW MANAGEMENT ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId + '-view').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[data-view="${viewId}"]`).classList.add('active');
            
            // Mark notification as read when viewing the page
            if (notifications[viewId]) {
                notifications[viewId] = false;
                updateNotificationBadges();
            }
            
            const titles = { 
                home: 'Dashboard', 
                statistik: 'Statistik', 
                sos: 'Laporan Darurat', 
                laporan: 'Daftar Laporan', 
                profil: 'Profil',
                'pos-ronda': 'Pos Ronda',
                'desa-management': 'Manajemen Desa',
                'aktivitas': 'Aktivitas'
            };
            const subtitles = { 
                home: 'Ringkasan keamanan desa Anda.', 
                statistik: 'Grafik dan analisis keamanan.', 
                sos: 'Kirim laporan segera.', 
                laporan: 'Riwayat semua laporan.', 
                profil: 'Pengaturan akun Anda.',
                'pos-ronda': 'Kelola pos ronda di wilayah Anda.',
                'desa-management': 'Kelola desa dan dusun.',
                'aktivitas': 'Riwayat aktivitas dan sanksi.'
            };
            document.getElementById('page-title').innerText = titles[viewId];
            document.getElementById('page-subtitle').innerText = subtitles[viewId];
            
            if (viewId === 'statistik') initCharts();
            if (viewId === 'sos') initMap();
            if (viewId === 'home') renderHome();
            if (viewId === 'pos-ronda') renderPosRonda();
            if (viewId === 'desa-management') renderDesaManagement();
            if (viewId === 'laporan') renderReports();
            if (viewId === 'aktivitas') renderAktivitas();
        }
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => { 
                e.preventDefault(); 
                showView(item.getAttribute('data-view')); 
            });
        });

        // --- DASHBOARD LOGIC ---
        function calculateSecurityStatus() {
            const thirtyDaysAgo = new Date(); 
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            // For kepala desa, show overall desa status
            let reportsInPeriod;
            if (currentUser.role_id === 1) {
                reportsInPeriod = mockReports.filter(r => new Date(r.created_at) > thirtyDaysAgo);
            } else {
                // For other users, filter by user's dusun
                reportsInPeriod = mockReports.filter(r => 
                    new Date(r.created_at) > thirtyDaysAgo && r.dusun_id === currentUser.dusun_id
                );
            }
            
            const totalReports = reportsInPeriod.length;
            const unresolvedReports = reportsInPeriod.filter(r => r.status === 'belum_selesai').length;
            const riskPercentage = totalReports > 0 ? Math.round((unresolvedReports / totalReports) * 100) : 0;

            const widget = document.getElementById('security-status-widget');
            const text = document.getElementById('security-status-text');
            const desc = document.getElementById('security-status-desc');
            const percentageSpan = document.getElementById('security-percentage');
            
            widget.className = 'security-status-widget';
            if (riskPercentage === 0) {
                widget.classList.add('success'); 
                text.innerText = 'KEAMANAN AMAN'; 
                desc.innerHTML = `Tingkat risiko rendah. <span>(${riskPercentage}%)</span>`;
            } else if (riskPercentage <= 30) {
                widget.classList.add('warning'); 
                text.innerText = 'KEAMANAN WASPADA'; 
                desc.innerHTML = `Terdapat ${unresolvedReports} laporan belum selesai. <span>(${riskPercentage}%)</span>`;
            } else {
                widget.classList.add('danger'); 
                text.innerText = 'KEAMANAN BAHAYA'; 
                desc.innerHTML = `Tingkat risiko tinggi! ${unresolvedReports} laporan belum selesai. <span>(${riskPercentage}%)</span>`;
            }
        }
        
        function renderNotifications() {
            const panel = document.getElementById('notification-panel');
            const requests = mockRoleChangeRequests.filter(req => 
                req.target_approver_uid === currentUser.uid && req.status === 'pending'
            );
            
            if (requests.length > 0) {
                notifications.home = true;
                updateNotificationBadges();
                
                panel.innerHTML = requests.map(req => `
                    <div class="notification-card">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Permintaan Perubahan Role</h5>
                        <p><strong>${req.requester_name}</strong> (Role: ${req.requester_role_name}) ingin menjadi <strong>${req.new_role_name}</strong>.</p>
                        <button class="btn btn-sm btn-success" onclick="processRoleChange('${req.id}', 'approved')">Setujui</button>
                        <button class="btn btn-sm btn-danger" onclick="processRoleChange('${req.id}', 'rejected')">Tolak</button>
                    </div>
                `).join('');
            } else { 
                panel.innerHTML = ''; 
            }
        }
        
        function renderHome() { 
            calculateSecurityStatus(); 
            renderNotifications(); 
            
            // --- PERUBAHAN: LOGIKA KODE AKSES BERDASARKAN ROLE ---
            const codeTimerWidget = document.getElementById('code-timer');
            const codeDisplay = document.getElementById('code-display');
            const codeTitle = document.getElementById('code-timer-title');

            // Sembunyikan widget terlebih dahulu
            codeTimerWidget.style.display = 'none';

            if (currentUser.role_id === 1) { // Kepala Desa
                codeTitle.innerText = 'Kode Akses Desa';
                codeDisplay.textContent = mockDesa.code;
                codeTimerWidget.style.display = 'block';
            } else if (currentUser.role_id === 2 && currentUser.dusun_id) { // Kepala Dusun
                const dusun = mockDesa.dusuns.find(d => d.id === currentUser.dusun_id);
                if (dusun) {
                    codeTitle.innerText = 'Kode Akses Dusun';
                    codeDisplay.textContent = dusun.code;
                    codeTimerWidget.style.display = 'block';
                }
            }
            // --- AKHIR PERUBAHAN ---

            // Filter reports based on user role
            let reportsToShow;
            if (currentUser.role_id === 1) {
                reportsToShow = mockReports;
            } else {
                reportsToShow = mockReports.filter(r => r.dusun_id === currentUser.dusun_id);
            }
            
            renderReportList(reportsToShow.slice(0, 3), 'recent-reports-list'); 
            updateStats(); 
            initDashboardCharts(); 
        }
        
        function updateStats() {
            // Filter reports based on user role
            let reportsToCount;
            if (currentUser.role_id === 1) {
                reportsToCount = mockReports;
            } else {
                reportsToCount = mockReports.filter(r => r.dusun_id === currentUser.dusun_id);
            }
            
            const total = reportsToCount.length;
            const selesai = reportsToCount.filter(r => r.status === 'selesai').length;
            const menunggu = total - selesai;
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-selesai').innerText = selesai;
            document.getElementById('stat-menunggu').innerText = menunggu;
        }

        // --- PROFILE & ROLE CHANGE ---
        function openRoleChangeModal() {
            const modal = document.getElementById('roleChangeModal');
            const select = document.getElementById('new-role-select');
            select.innerHTML = '<option value="">Pilih Role</option>';
            
            // Get available roles based on current role
            let availableRoles = [];
            if (currentUser.role_id === 5) { // Kepala Keluarga can request to become Ketua RT
                availableRoles = mockUsers.filter(u => u.role_id === 4);
            } else if (currentUser.role_id === 4) { // Ketua RT can request to become Ketua RW
                availableRoles = mockUsers.filter(u => u.role_id === 3);
            } else if (currentUser.role_id === 3) { // Ketua RW can request to become Kepala Dusun
                availableRoles = mockUsers.filter(u => u.role_id === 2);
            } else if (currentUser.role_id === 2) { // Kepala Dusun can request to become Kepala Desa
                availableRoles = mockUsers.filter(u => u.role_id === 1);
            }
            
            availableRoles.forEach(role => { 
                select.innerHTML += `<option value="${role.role_id}">${role.role_name}</option>`; 
            });
            
            modal.style.display = 'block';
        }
        
        function closeModal(modalId) { 
            document.getElementById(modalId).style.display = 'none'; 
        }
        
        function submitRoleChange() {
            const newRoleId = parseInt(document.getElementById('new-role-select').value);
            if (!newRoleId) { 
                alert('Pilih role baru.'); 
                return; 
            }
            
            const newRole = mockUsers.find(u => u.role_id === newRoleId);
            let targetApprover;
            
            if (newRoleId === 1) {
                targetApprover = mockUsers.find(u => u.role_id === 1);
            } else {
                targetApprover = mockUsers.find(u => u.role_id === newRoleId - 1);
            }
            
            const request = { 
                id: Date.now().toString(), 
                requester_uid: currentUser.uid, 
                requester_name: currentUser.name, 
                requester_role_name: currentUser.role_name, 
                new_role_id: newRoleId, 
                new_role_name: newRole.role_name, 
                target_approver_uid: targetApprover.uid, 
                target_approver_name: targetApprover.name, 
                status: 'pending' 
            };
            
            mockRoleChangeRequests.push(request);
            closeModal('roleChangeModal');
            showAlert('Permintaan perubahan role telah dikirim ke ' + targetApprover.name + '.', 'success');
            showView('profil');
        }
        
        function processRoleChange(requestId, action) {
            const reqIndex = mockRoleChangeRequests.findIndex(r => r.id === requestId);
            if (reqIndex > -1) {
                if (action === 'approved') { 
                    showAlert(`Permintaan role untuk ${mockRoleChangeRequests[reqIndex].requester_name} telah disetujui.`, 'success'); 
                }
                else { 
                    showAlert(`Permintaan role untuk ${mockRoleChangeRequests[reqIndex].requester_name} telah ditolak.`, 'info'); 
                }
                mockRoleChangeRequests[reqIndex].status = action;
                renderHome();
            }
        }

        // --- SOS & REPORTS ---
        function initMap() {
            if (!map) {
                map = L.map('map').setView([-6.2088, 106.8456], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
                
                // Enhanced GPS for mobile
                if (navigator.geolocation) {
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    };
                    
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const lat = pos.coords.latitude;
                            const lng = pos.coords.longitude;
                            map.setView([lat, lng], 16);
                            
                            if (currentMarker) {
                                map.removeLayer(currentMarker);
                            }
                            
                            currentMarker = L.marker([lat, lng]).addTo(map)
                                .bindPopup('Lokasi Anda Saat Ini')
                                .openPopup();
                            
                            document.getElementById('report-lat').value = lat;
                            document.getElementById('report-lng').value = lng;
                            
                            // Add accuracy circle
                            L.circle([lat, lng], pos.coords.accuracy).addTo(map);
                        },
                        (err) => {
                            console.error('GPS Error:', err);
                            showAlert('Tidak dapat mengakses lokasi GPS. Pastikan izin lokasi diaktifkan.', 'warning');
                        },
                        options
                    );
                    
                    // Watch position for real-time updates
                    navigator.geolocation.watchPosition(
                        (pos) => {
                            const lat = pos.coords.latitude;
                            const lng = pos.coords.longitude;
                            
                            if (currentMarker) {
                                currentMarker.setLatLng([lat, lng]);
                            }
                            
                            document.getElementById('report-lat').value = lat;
                            document.getElementById('report-lng').value = lng;
                        },
                        null,
                        options
                    );
                }
            } else { 
                setTimeout(() => map.invalidateSize(), 100); 
            }
        }
        
        // Initialize emergency type selection
        document.addEventListener('DOMContentLoaded', () => {
            const emergencyTypes = document.querySelectorAll('.emergency-type');
            emergencyTypes.forEach(type => {
                type.addEventListener('click', () => {
                    // Remove selected class from all types
                    emergencyTypes.forEach(t => t.classList.remove('selected'));
                    // Add selected class to clicked type
                    type.classList.add('selected');
                    // Set the hidden input value
                    document.getElementById('report-type').value = type.getAttribute('data-type');
                });
            });
        });
        
        document.getElementById('create-report-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.getElementById('report-type').value;
            const location = document.getElementById('report-location').value;
            
            if (!type) { 
                showAlert('Silakan pilih jenis kejadian terlebih dahulu.', 'warning'); 
                return; 
            }
            
            if (!location) { 
                showAlert('Lokasi kejadian harus diisi.', 'warning'); 
                return; 
            }
            
            const newReport = { 
                id: Date.now().toString(), 
                type: type, 
                location: location, 
                description: document.getElementById('report-description').value, 
                status: 'belum_selesai', 
                created_at: new Date(), 
                reporter: currentUser.name, 
                reporter_uid: currentUser.uid,
                dusun_id: currentUser.dusun_id
            };
            
            mockReports.unshift(newReport);
            
            // Add activity
            addActivity('report', `${currentUser.name} membuat laporan ${type} di ${location}`);
            
            showAlert('Laporan berhasil dikirim! Warga lain telah diberitahu.', 'success');
            e.target.reset();
            
            // Reset emergency type selection
            document.querySelectorAll('.emergency-type').forEach(t => t.classList.remove('selected'));
            document.getElementById('report-type').value = '';
            
            document.getElementById('loc-home').checked = true;
            updateLocationField();
            
            if(currentMarker) { 
                map.removeLayer(currentMarker); 
                currentMarker = null; 
            }
            
            // Update notification for reports
            notifications.laporan = true;
            notifications.aktivitas = true;
            updateNotificationBadges();
            
            showView('laporan');
        });
        
        function updateLocationField() {
            const locInput = document.getElementById('report-location');
            if (document.getElementById('loc-home').checked) { 
                locInput.value = currentUser.home_address; 
                locInput.readOnly = true; 
            }
            else { 
                locInput.value = ''; 
                locInput.readOnly = false; 
            }
        }
        
        document.querySelectorAll('input[name="location-type"]').forEach(r => { 
            r.addEventListener('change', updateLocationField); 
        });

        // --- POS RONDA ---
        function renderPosRonda() {
            // Filter pos based on user role and permissions
            let userPos;
            if (currentUser.role_id === 1) {
                // Kepala desa can see all pos
                userPos = mockPosRonda;
            } else if (currentUser.role_id === 2) {
                // Kepala dusun can see all pos in their dusun
                userPos = mockPosRonda.filter(p => p.dusun_id === currentUser.dusun_id);
            } else if (currentUser.role_id <= 4 && currentUser.rt_id) {
                // Ketua RT can see pos in their RT
                userPos = mockPosRonda.filter(p => p.rt_id === currentUser.rt_id);
            } else {
                // Other users can only see pos in their dusun
                userPos = mockPosRonda.filter(p => p.dusun_id === currentUser.dusun_id);
            }
            
            const posList = document.getElementById('pos-ronda-list');
            posList.innerHTML = userPos.map(pos => {
                const dusun = mockDesa.dusuns.find(d => d.id === pos.dusun_id);
                const rtName = pos.rt_id ? dusun.rts.find(r => r.id === pos.rt_id).name : 'Dusun';
                
                return `
                    <div class="pos-ronda-item">
                        <div class="pos-ronda-icon"><i class="fas fa-shield-alt"></i></div>
                        <div class="pos-ronda-info">
                            <h5>${pos.name}</h5>
                            <p>${rtName} - ${dusun.name}</p>
                            <p>Dibuat: ${formatTime(pos.created_at)}</p>
                        </div>
                        <span class="pos-status ${pos.status}">${pos.status === 'aktif' ? 'Aktif' : 'Nonaktif'}</span>
                        <button class="btn btn-sm btn-primary ms-2" onclick="showPosDetail('${pos.id}')">Detail</button>
                    </div>
                `;
            }).join('');
            
            // Initialize pos map if not already initialized
            if (!posMap) {
                setTimeout(() => {
                    posMap = L.map('pos-map').setView([-6.2088, 106.8456], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(posMap);
                    
                    posMap.on('click', function(e) {
                        if (currentPosMarker) {
                            posMap.removeLayer(currentPosMarker);
                        }
                        currentPosMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(posMap);
                        document.getElementById('pos-lat').value = e.latlng.lat;
                        document.getElementById('pos-lng').value = e.latlng.lng;
                    });
                }, 100);
            } else {
                setTimeout(() => posMap.invalidateSize(), 100);
            }
        }
        
        function showPosDetail(posId) {
            const pos = mockPosRonda.find(p => p.id === posId);
            if (!pos) return;
            
            currentPosDetail = pos;
            document.getElementById('pos-detail-name').textContent = pos.name;
            document.getElementById('pos-detail-status').textContent = pos.status === 'aktif' ? 'Aktif' : 'Nonaktif';
            document.getElementById('pos-detail-status').className = `pos-status ${pos.status}`;
            
            // Show photos with click functionality
            const photoGallery = document.getElementById('pos-detail-photos');
            photoGallery.innerHTML = pos.photos.map(photo => 
                `<img src="${photo}" class="photo-thumb" alt="Foto Pos" onclick="openImageModal('${photo}')">`
            ).join('');
            
            // Initialize map for pos detail
            setTimeout(() => {
                const posDetailMap = L.map('pos-detail-map').setView([pos.lat, pos.lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(posDetailMap);
                L.marker([pos.lat, pos.lng]).addTo(posDetailMap).bindPopup(pos.name).openPopup();
            }, 100);
            
            // Show/hide action buttons based on user permissions
            let canEdit = false;
            if (currentUser.role_id === 1) {
                // Kepala desa can edit all pos
                canEdit = true;
            } else if (currentUser.role_id === 2 && pos.dusun_id === currentUser.dusun_id && !pos.rt_id) {
                // Kepala dusun can edit dusun-level pos in their dusun
                canEdit = true;
            } else if (currentUser.role_id <= 4 && pos.rt_id === currentUser.rt_id) {
                // Ketua RT can edit RT-level pos in their RT
                canEdit = true;
            }
            
            document.getElementById('pos-actions').style.display = canEdit ? 'block' : 'none';
            
            document.getElementById('posDetailModal').style.display = 'block';
        }
        
        function openImageModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('imageModal').style.display = 'block';
        }
        
        function editPos() {
            if (!currentPosDetail) return;
            
            // Switch to add pos tab and populate form
            switchTab('add-pos');
            document.getElementById('pos-name').value = currentPosDetail.name;
            document.getElementById('pos-status').value = currentPosDetail.status;
            
            // Set map marker to pos location
            if (posMap && currentPosMarker) {
                posMap.removeLayer(currentPosMarker);
            }
            currentPosMarker = L.marker([currentPosDetail.lat, currentPosDetail.lng]).addTo(posMap);
            document.getElementById('pos-lat').value = currentPosDetail.lat;
            document.getElementById('pos-lng').value = currentPosDetail.lng;
            
            // Center map on pos
            posMap.setView([currentPosDetail.lat, currentPosDetail.lng], 16);
            
            closeModal('posDetailModal');
        }
        
        function deletePos() {
            if (!currentPosDetail) return;
            
            if (confirm(`Apakah Anda yakin ingin menghapus pos "${currentPosDetail.name}"?`)) {
                const index = mockPosRonda.findIndex(p => p.id === currentPosDetail.id);
                if (index > -1) {
                    mockPosRonda.splice(index, 1);
                    showAlert('Pos berhasil dihapus.', 'success');
                    closeModal('posDetailModal');
                    renderPosRonda();
                }
            }
        }
        
        document.getElementById('add-pos-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('pos-name').value;
            const status = document.getElementById('pos-status').value;
            const lat = document.getElementById('pos-lat').value;
            const lng = document.getElementById('pos-lng').value;
            
            if (!name) {
                showAlert('Nama pos harus diisi.', 'warning');
                return;
            }
            
            if (!lat || !lng) {
                showAlert('Pilih lokasi pos di peta.', 'warning');
                return;
            }
            
            // Check if user can add pos at this location
            let canAddPos = false;
            let posType = '';
            
            if (currentUser.role_id === 1) {
                // Kepala desa can add dusun-level pos
                canAddPos = true;
                posType = 'dusun';
            } else if (currentUser.role_id === 2) {
                // Kepala dusun can add dusun-level pos in their dusun
                canAddPos = true;
                posType = 'dusun';
            } else if (currentUser.role_id <= 4 && currentUser.rt_id) {
                // Ketua RT can add RT-level pos in their RT
                canAddPos = true;
                posType = 'rt';
            }
            
            if (!canAddPos) {
                showAlert('Anda tidak memiliki izin untuk menambah pos.', 'warning');
                return;
            }
            
            const newPos = {
                id: 'pos_' + Date.now(),
                name: name,
                status: status,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                photos: [], // In a real app, photos would be uploaded
                dusun_id: currentUser.dusun_id || mockDesa.dusuns[0].id,
                rt_id: posType === 'rt' ? currentUser.rt_id : null,
                created_by: currentUser.uid,
                created_at: new Date()
            };
            
            mockPosRonda.push(newPos);
            
            // Add activity
            addActivity('pos', `${currentUser.name} menambahkan pos ${name}`);
            
            showAlert('Pos berhasil ditambahkan.', 'success');
            e.target.reset();
            
            if (currentPosMarker) {
                posMap.removeLayer(currentPosMarker);
                currentPosMarker = null;
            }
            
            switchTab('pos-list');
        });
        
        document.getElementById('pos-photos').addEventListener('change', (e) => {
            const files = e.target.files;
            const preview = document.getElementById('pos-photo-preview');
            preview.innerHTML = '';
            
            if (files.length > 5) {
                showAlert('Maksimal 5 foto yang dapat diunggah.', 'warning');
                e.target.value = '';
                return;
            }
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.className = 'photo-thumb';
                    img.onclick = function() { openImageModal(event.target.src); };
                    preview.appendChild(img);
                };
                
                reader.readAsDataURL(file);
            }
        });
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'add-pos' && posMap) {
                setTimeout(() => posMap.invalidateSize(), 100);
            }
        }

        // --- DESA MANAGEMENT ---
        function renderDesaManagement() {
            // Update desa info
            document.getElementById('desa-name-input').value = mockDesa.name;
            document.getElementById('desa-code-display').textContent = mockDesa.code;
            
            // Render dusun list
            const dusunListContainer = document.getElementById('dusun-list-container');
            dusunListContainer.innerHTML = mockDesa.dusuns.map(dusun => {
                // Calculate security status for each dusun
                const thirtyDaysAgo = new Date(); 
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const dusunReports = mockReports.filter(r => 
                    r.dusun_id === dusun.id && new Date(r.created_at) > thirtyDaysAgo
                );
                const totalReports = dusunReports.length;
                const unresolvedReports = dusunReports.filter(r => r.status === 'belum_selesai').length;
                const riskPercentage = totalReports > 0 ? Math.round((unresolvedReports / totalReports) * 100) : 0;
                
                let statusClass = 'aman';
                let statusText = 'Aman';
                if (riskPercentage > 30) {
                    statusClass = 'bahaya';
                    statusText = 'Bahaya';
                } else if (riskPercentage > 0) {
                    statusClass = 'waspada';
                    statusText = 'Waspada';
                }
                
                const kepalaText = dusun.kepala_dusun_name ? 
                    `${dusun.kepala_dusun_name} ${dusun.kepala_verified ? '<span class="verification-badge verified">Terverifikasi</span>' : '<span class="verification-badge">Menunggu Verifikasi</span>'}` : 
                    'Belum ada Kepala Dusun';
                
                return `
                    <div class="dusun-status-card ${statusClass}">
                        <h5>${dusun.name}</h5>
                        <p>Kepala Dusun: ${kepalaText}</p>
                        <p>Kode: ${dusun.code}</p>
                        <p>Status: ${statusText} (${riskPercentage}% risiko)</p>
                        <button class="btn btn-sm btn-primary" onclick="showDusunDetail('${dusun.id}')">Detail Kejadian</button>
                    </div>
                `;
            }).join('');
            
            // Render verifikasi list
            renderVerifikasiList();
        }
        
        function showDusunDetail(dusunId) {
            const dusun = mockDesa.dusuns.find(d => d.id === dusunId);
            if (!dusun) return;
            
            // Get reports for this dusun
            const dusunReports = mockReports.filter(r => r.dusun_id === dusunId);
            
            // Count incidents by type
            const incidentCounts = {};
            dusunReports.forEach(r => { 
                incidentCounts[r.type] = (incidentCounts[r.type] || 0) + 1; 
            });
            
            // Update modal title
            document.getElementById('dusun-detail-name').textContent = `Detail Kejadian - ${dusun.name}`;
            
            // Render incident list
            const incidentList = document.getElementById('dusun-incident-list');
            
            // Check if there are any incidents
            if (Object.keys(incidentCounts).length === 0) {
                incidentList.innerHTML = '<p class="text-muted">Tidak ada kejadian yang dilaporkan dalam 30 hari terakhir.</p>';
            } else {
                incidentList.innerHTML = Object.keys(incidentCounts).map(type => {
                    const icon = getIconForType(type);
                    const typeName = type.charAt(0).toUpperCase() + type.slice(1);
                    const count = incidentCounts[type];
                    
                    return `
                        <div class="incident-item">
                            <div class="incident-type">
                                <div class="incident-icon ${type}"><i class="fas fa-${icon}"></i></div>
                                <span>${typeName}</span>
                            </div>
                            <div class="incident-count">${count}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show modal
            document.getElementById('dusunDetailModal').style.display = 'block';
        }
        
        function renderVerifikasiList() {
            const verifikasiList = document.getElementById('verifikasi-list');
            const pendingRequests = mockKepalaDusunRequests.filter(req => req.status === 'pending');
            
            if (pendingRequests.length === 0) {
                verifikasiList.innerHTML = '<p class="text-muted">Tidak ada permintaan verifikasi kepala dusun saat ini.</p>';
                return;
            }
            
            verifikasiList.innerHTML = pendingRequests.map(req => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>${req.requester_name}</h5>
                        <p> ingin menjadi kepala dusun untuk <strong>${req.dusun_name}</strong></p>
                        <p class="text-muted">Diajukan: ${formatTime(req.created_at)}</p>
                        <button class="btn btn-sm btn-success" onclick="verifyKepalaDusun('${req.id}', 'approved')">
                            <i class="fas fa-check me-1"></i>Verifikasi
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="verifyKepalaDusun('${req.id}', 'rejected')">
                            <i class="fas fa-times me-1"></i>Tolak
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function verifyKepalaDusun(requestId, action) {
            const request = mockKepalaDusunRequests.find(req => req.id === requestId);
            if (!request) return;
            
            if (action === 'approved') {
                // Update dusun with kepala dusun info
                const dusun = mockDesa.dusuns.find(d => d.id === request.dusun_id);
                if (dusun) {
                    dusun.kepala_dusun_uid = request.requester_uid;
                    dusun.kepala_dusun_name = request.requester_name;
                    dusun.kepala_verified = true;
                }
                
                // Update user role to Kepala Dusun
                const user = mockUsers.find(u => u.uid === request.requester_uid);
                if (user) {
                    user.role_id = 2;
                    user.role_name = 'Kepala Dusun';
                    user.dusun_id = request.dusun_id;
                }
                
                showAlert(`${request.requester_name} telah diverifikasi sebagai kepala dusun ${request.dusun_name}.`, 'success');
                
                // Add activity
                addActivity('verifikasi', `${currentUser.name} menyetujui ${request.requester_name} sebagai kepala dusun ${request.dusun_name}`);
            } else {
                showAlert(`Permintaan ${request.requester_name} sebagai kepala dusun telah ditolak.`, 'info');
                
                // Add activity
                addActivity('verifikasi', `${currentUser.name} menolak ${request.requester_name} sebagai kepala dusun ${request.dusun_name}`);
            }
            
            // Update request status
            request.status = action;
            
            // Re-render the verification list and dusun list
            renderVerifikasiList();
            renderDesaManagement();
        }
        
        function updateDesaInfo() {
            const newName = document.getElementById('desa-name-input').value;
            if (!newName) {
                showAlert('Nama desa harus diisi.', 'warning');
                return;
            }
            
            mockDesa.name = newName;
            showAlert('Informasi desa berhasil diperbarui.', 'success');
            
            // Update current user's desa name if it's the same
            if (currentUser.desa_id === mockDesa.id) {
                currentUser.desa_name = newName;
                document.getElementById('desa-name').textContent = newName;
                document.getElementById('profile-desa').textContent = newName;
            }
        }
        
        function switchDesaTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'verifikasi-kepala') {
                renderVerifikasiList();
            }
        }

        // --- REPORTS ---
        function renderReports() {
            renderMyReports();
            renderOtherReports();
        }
        
        function renderMyReports() {
            const myReports = mockReports.filter(r => r.reporter_uid === currentUser.uid);
            const filteredReports = filterReports(myReports, 'my-');
            
            // Pagination
            const startIndex = (myReportsPage - 1) * reportsPerPage;
            const endIndex = startIndex + reportsPerPage;
            const paginatedReports = filteredReports.slice(startIndex, endIndex);
            
            renderReportList(paginatedReports, 'my-reports-list');
            
            // Render pagination
            const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
            renderPagination('my-reports-pagination', myReportsPage, totalPages, (page) => {
                myReportsPage = page;
                renderMyReports();
            });
        }
        
        function renderOtherReports() {
            const otherReports = mockReports.filter(r => r.reporter_uid !== currentUser.uid);
            const filteredReports = filterReports(otherReports, 'other-');
            
            // Pagination
            const startIndex = (otherReportsPage - 1) * reportsPerPage;
            const endIndex = startIndex + reportsPerPage;
            const paginatedReports = filteredReports.slice(startIndex, endIndex);
            
            renderReportList(paginatedReports, 'other-reports-list');
            
            // Render pagination
            const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
            renderPagination('other-reports-pagination', otherReportsPage, totalPages, (page) => {
                otherReportsPage = page;
                renderOtherReports();
            });
        }
        
        function filterReports(reports, prefix) {
            const typeFilter = document.getElementById(`${prefix}filter-type`).value;
            const statusFilter = document.getElementById(`${prefix}filter-status`).value;
            const monthFilter = document.getElementById(`${prefix}filter-month`).value;
            const dateFilter = document.getElementById(`${prefix}filter-date`).value;
            
            let filteredReports = reports;
            
            if (typeFilter) {
                filteredReports = filteredReports.filter(r => r.type === typeFilter);
            }
            if (statusFilter) {
                filteredReports = filteredReports.filter(r => r.status === statusFilter);
            }
            if (monthFilter) {
                filteredReports = filteredReports.filter(r => new Date(r.created_at).getMonth() + 1 === parseInt(monthFilter));
            }
            if (dateFilter) {
                filteredReports = filteredReports.filter(r => r.created_at.toDateString() === new Date(dateFilter).toDateString());
            }
            
            return filteredReports;
        }
        
        function renderPagination(containerId, currentPage, totalPages, changePage) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => changePage(currentPage - 1);
            container.appendChild(prevBtn);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => changePage(i);
                container.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => changePage(currentPage + 1);
            container.appendChild(nextBtn);
        }
        
        function switchReportTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // --- JOIN DUSUN ---
        document.getElementById('join-dusun-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('join-dusun-code').value.trim().toUpperCase();
            
            if (!code) {
                showAlert('Kode dusun harus diisi.', 'warning');
                return;
            }
            
            // Find dusun with matching code
            const dusun = mockDesa.dusuns.find(d => d.code === code);
            
            if (!dusun) {
                showAlert('Kode dusun tidak valid. Silakan periksa kembali kode Anda.', 'danger');
                return;
            }
            
            // Update user's dusun
            currentUser.dusun_id = dusun.id;
            currentUser.dusun_name = dusun.name;
            
            // Update UI
            document.getElementById('dusun-name').textContent = dusun.name;
            document.getElementById('profile-dusun').textContent = dusun.name;
            
            // Show code timer
            document.getElementById('code-display').textContent = dusun.code;
            document.getElementById('code-timer').style.display = 'block';
            
            showAlert(`Anda berhasil bergabung dengan dusun ${dusun.name}.`, 'success');
            e.target.reset();
            
            // Add activity
            addActivity('join', `${currentUser.name} bergabung dengan dusun ${dusun.name}`);
            
            // Refresh views
            renderHome();
            renderPosRonda();
            renderReports();
        });
        
        // --- ROLE SWITCHER ---
        document.getElementById('role-switcher').addEventListener('change', (e) => {
            const userId = e.target.value;
            const user = mockUsers.find(u => u.uid === userId);
            
            if (!user) return;
            
            // Update current user
            Object.assign(currentUser, user);
            
            // Update UI
            document.getElementById('topbar-username').innerText = currentUser.name;
            document.getElementById('topbar-avatar').innerText = currentUser.name.split(' ').map(n=>n[0]).join('');
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-phone').innerText = currentUser.phone;
            document.getElementById('profile-email').innerText = currentUser.email;
            document.getElementById('profile-role').innerText = currentUser.role_name;
            document.getElementById('profile-desa').innerText = currentUser.desa_name;
            document.getElementById('profile-dusun').innerText = currentUser.dusun_name || '-';
            
            // Update dusun info
            document.getElementById('dusun-name').textContent = currentUser.dusun_name || 'Semua Dusun';
            document.getElementById('desa-name').textContent = `Desa: ${currentUser.desa_name}`;
            document.getElementById('user-role').textContent = currentUser.role_name;
            
            // Show/hide code timer
            if (currentUser.dusun_id) {
                const dusun = mockDesa.dusuns.find(d => d.id === currentUser.dusun_id);
                if (dusun) {
                    document.getElementById('code-display').textContent = dusun.code;
                    document.getElementById('code-timer').style.display = 'block';
                }
            } else {
                document.getElementById('code-timer').style.display = 'none';
            }
            
            // Show/hide desa management nav
            if (currentUser.role_id === 1) {
                document.getElementById('desa-management-nav').style.display = 'flex';
                document.getElementById('aktivitas-nav').style.display = 'none';
            } else {
                document.getElementById('desa-management-nav').style.display = 'none';
                document.getElementById('aktivitas-nav').style.display = 'flex';
            }
            
            // Refresh views
            renderHome();
            renderPosRonda();
            renderReports();
            
            showAlert(`Berhasil beralih ke role: ${currentUser.role_name}`, 'success');
        });
        
        // --- ADD DUSUN ---
        document.getElementById('add-dusun-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('new-dusun-name').value.trim();
            
            if (!name) {
                showAlert('Nama dusun harus diisi.', 'warning');
                return;
            }
            
            // Create new dusun
            const newDusun = {
                id: 'dusun_' + Date.now(),
                name: name,
                code: generateRandomCode(),
                code_expiry: new Date(Date.now() + 24 * 60 * 60 * 1000),
                kepala_dusun_uid: null,
                kepala_dusun_name: null,
                kepala_verified: false,
                rts: []
            };
            
            // Add to dusun list
            mockDesa.dusuns.push(newDusun);
            
            // Add activity
            addActivity('dusun', `${currentUser.name} menambahkan dusun ${name}`);
            
            // Show success message
            showAlert(`Dusun "${name}" berhasil ditambahkan dengan kode: ${newDusun.code}`, 'success');
            
            // Reset form
            e.target.reset();
            
            // Switch to dusun list tab
            switchDesaTab('dusun-list');
            
            // Re-render dusun list
            renderDesaManagement();
        });

        // --- ACTIVITY & SANCTION ---
        function addActivity(type, description) {
            const activity = {
                id: Date.now().toString(),
                type: type,
                description: description,
                created_at: new Date(),
                user: currentUser.name
            };
            
            mockActivities.unshift(activity);
            
            // Keep only last 50 activities
            if (mockActivities.length > 50) {
                mockActivities = mockActivities.slice(0, 50);
            }
            
            // Update notification
            notifications.aktivitas = true;
            updateNotificationBadges();
        }
        
        function renderAktivitas() {
            // Render activity feed
            const activityFeed = document.getElementById('activity-feed');
            activityFeed.innerHTML = mockActivities.slice(0, 20).map(activity => {
                const icon = getActivityIcon(activity.type);
                const color = getActivityColor(activity.type);
                
                return `
                    <div class="activity-item">
                        <div class="activity-icon" style="background-color: ${color};">
                            <i class="fas fa-${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <p>${activity.description}</p>
                            <span class="activity-time">${formatDateTime(activity.created_at)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render sanction list
            const sanctionList = document.getElementById('sanction-list');
            if (mockSanctions.length === 0) {
                sanctionList.innerHTML = '<p class="text-muted">Belum ada sanksi yang diberikan.</p>';
            } else {
                sanctionList.innerHTML = mockSanctions.map(sanction => {
                    const badgeClass = sanction.type === 'blokir' ? 'danger' : 'warning';
                    
                    return `
                        <div class="sanction-item">
                            <div class="sanction-info">
                                <h5>${sanction.user_name}</h5>
                                <p>${sanction.reason}</p>
                                <span class="text-muted">${formatDateTime(sanction.created_at)}</span>
                            </div>
                            <span class="sanction-badge ${badgeClass}">${sanction.type}</span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function getActivityIcon(type) {
            const icons = {
                report: 'exclamation-triangle',
                pos: 'shield-alt',
                verifikasi: 'user-check',
                join: 'sign-in-alt',
                dusun: 'map-marker-alt',
                sanction: 'gavel'
            };
            return icons[type] || 'circle';
        }
        
        function getActivityColor(type) {
            const colors = {
                report: 'var(--warning-color)',
                pos: 'var(--secondary-color)',
                verifikasi: 'var(--success-color)',
                join: 'var(--primary-color)',
                dusun: 'var(--info-color)',
                sanction: 'var(--danger-color)'
            };
            return colors[type] || 'var(--text-secondary)';
        }

        // --- UTILITY & RENDERING ---
        function showAlert(message, type = 'success') {
            const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            document.getElementById('alert-container').innerHTML = alertHtml;
            setTimeout(() => { document.getElementById('alert-container').innerHTML = ''; }, 5000);
        }
        
        function getIconForType(type) { 
            const icons = { 
                kemalingan: 'user-secret', 
                kebakaran: 'fire', 
                ambulance: 'ambulance', 
                mencurigakan: 'exclamation-triangle', 
                keributan: 'users', 
                lainnya: 'ellipsis-h' 
            }; 
            return icons[type] || 'file-alt'; 
        }
        
        function formatTime(date) { 
            const now = new Date(); 
            const diff = Math.floor((now - date) / 1000); 
            if (diff < 60) return 'Baru saja'; 
            if (diff < 3600) return `${Math.floor(diff / 60)} menit lalu`; 
            if (diff < 86400) return `${Math.floor(diff / 3600)} jam lalu`; 
            return date.toLocaleDateString('id-ID'); 
        }
        
        function formatDateTime(date) {
            return date.toLocaleString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function renderReportList(reports, containerId) {
            const listContainer = document.getElementById(containerId);
            listContainer.innerHTML = reports.map(report => {
                const canSanction = currentUser.role_id >= 2 && currentUser.role_id <= 4 && report.reporter_uid !== currentUser.uid;
                const isOwnReport = report.reporter_uid === currentUser.uid;
                const reporterNameHtml = canSanction ? `<a href="#" class="reporter-name-link" onclick="openSanctionModal('${report.reporter_uid}', '${report.reporter}')">${report.reporter}</a>` : `<span>${report.reporter}</span>`;
                const resolveButtonHtml = isOwnReport && report.status === 'belum_selesai' ? `<button class="btn btn-sm btn-success ms-2" onclick="resolveReport('${report.id}')">Tandai Selesai</button>` : '';
                
                return `
                    <div class="report-list-item">
                        <div class="report-icon ${report.type}"><i class="fas fa-${getIconForType(report.type)}"></i></div>
                        <div class="report-content">
                            <h5>${report.type.charAt(0).toUpperCase() + report.type.slice(1)}</h5>
                            <p>${report.description}</p>
                            <div class="report-meta">
                                <span><i class="fas fa-map-marker-alt me-1"></i>${report.location}</span>
                                <span><i class="fas fa-user me-1"></i>${reporterNameHtml}</span>
                                <span><i class="fas fa-calendar me-1"></i>${formatDateTime(report.created_at)}</span>
                            </div>
                        </div>
                        <span class="report-status ${report.status}">${report.status.replace('_', ' ')}</span>
                        ${resolveButtonHtml}
                    </div>
                `;
            }).join('');
        }
        
        function openSanctionModal(uid, name) {
            currentSanctionTarget = { uid, name };
            document.getElementById('sanction-user-name').innerText = name;
            document.getElementById('sanctionModal').style.display = 'block';
        }
        
        function submitSanction() {
            const type = document.getElementById('sanction-type').value;
            const reason = document.getElementById('sanction-reason').value;
            if (!reason) { 
                alert('Alasan harus diisi.'); 
                return; 
            }
            
            // Add sanction to list
            const sanction = {
                id: Date.now().toString(),
                user_uid: currentSanctionTarget.uid,
                user_name: currentSanctionTarget.name,
                type: type,
                reason: reason,
                created_at: new Date(),
                given_by: currentUser.name
            };
            
            mockSanctions.unshift(sanction);
            
            // Add activity
            addActivity('sanction', `${currentUser.name} memberikan sanksi ${type} kepada ${currentSanctionTarget.name}: ${reason}`);
            
            showAlert(`Sanksi '${type}' telah diberikan kepada ${currentSanctionTarget.name}.`, 'warning');
            closeModal('sanctionModal');
            
            // Update user status if blocked
            if (type === 'blokir') {
                const user = mockUsers.find(u => u.uid === currentSanctionTarget.uid);
                if (user) {
                    user.is_blocked = true;
                }
            }
        }
        
        function resolveReport(reportId) {
            const report = mockReports.find(r => r.id === reportId);
            if (report) {
                report.status = 'selesai';
                showAlert('Laporan telah ditandai sebagai selesai.', 'success');
                
                // Add activity
                addActivity('report', `${currentUser.name} menyelesaikan laporan ${report.type} di ${report.location}`);
                
                // Update security status immediately
                calculateSecurityStatus();
                updateStats();
                
                // Refresh reports list
                renderReports();
            }
        }
        
        function updateNotificationBadges() {
            document.querySelectorAll('.nav-item').forEach(item => {
                const viewId = item.getAttribute('data-view');
                const badge = item.querySelector('.notification-badge');
                
                if (badge) {
                    badge.remove();
                }
                
                if (notifications[viewId]) {
                    const newBadge = document.createElement('span');
                    newBadge.className = 'notification-badge';
                    newBadge.textContent = '!';
                    item.appendChild(newBadge);
                }
            });
        }

        // --- CHARTS ---
        function initDashboardCharts() {
            const ctx = document.getElementById('securityTrendChart');
            if(ctx.chart) ctx.chart.destroy();
            
            // Filter reports based on user role
            let reportsForChart;
            if (currentUser.role_id === 1) {
                reportsForChart = mockReports;
            } else {
                reportsForChart = mockReports.filter(r => r.dusun_id === currentUser.dusun_id);
            }
            
            const last30Days = [];
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today); 
                date.setDate(today.getDate() - i);
                const reportsOnDay = reportsForChart.filter(r => r.created_at.toDateString() === date.toDateString()).length;
                let status = 'aman';
                if (reportsOnDay > 3) status = 'bahaya';
                else if (reportsOnDay > 0) status = 'rawan';
                last30Days.push({ date: date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }), reports: reportsOnDay, status });
            }
            
            ctx.chart = new Chart(ctx, {
                type: 'line', data: {
                    labels: last30Days.map(d => d.date),
                    datasets: [{
                        label: 'Jumlah Laporan',
                        data: last30Days.map(d => d.reports),
                        borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: false
                    }]
                }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        
        function initCharts() {
            // Filter reports based on user role
            let reportsForCharts;
            if (currentUser.role_id === 1) {
                reportsForCharts = mockReports;
            } else {
                reportsForCharts = mockReports.filter(r => r.dusun_id === currentUser.dusun_id);
            }
            
            const reportTypeCtx = document.getElementById('reportTypeChart');
            if(reportTypeCtx.chart) reportTypeCtx.chart.destroy();
            const reportCounts = {};
            reportsForCharts.forEach(r => { 
                reportCounts[r.type] = (reportCounts[r.type] || 0) + 1; 
            });
            reportTypeCtx.chart = new Chart(reportTypeCtx, {
                type: 'bar', data: {
                    labels: Object.keys(reportCounts), 
                    datasets: [{ 
                        label: 'Jumlah Laporan', 
                        data: Object.values(reportCounts), 
                        backgroundColor: ['#ef4444', '#f59e0b', '#06b6d4', '#f59e0b', '#8b5cf6', '#64748b'] 
                    }]
                }, options: { responsive: true, maintainAspectRatio: false }
            });

            const resolutionRateCtx = document.getElementById('resolutionRateChart');
            if(resolutionRateCtx.chart) resolutionRateCtx.chart.destroy();
            const selesai = reportsForCharts.filter(r => r.status === 'selesai').length;
            const belumSelesai = reportsForCharts.length - selesai;
            resolutionRateCtx.chart = new Chart(resolutionRateCtx, {
                type: 'doughnut', data: {
                    labels: ['Selesai', 'Belum Selesai'],
                    datasets: [{ data: [selesai, belumSelesai], backgroundColor: ['#10b981', '#f59e0b'] }]
                }, options: { responsive: true, maintainAspectRatio: false }
            });
            
            // Show dusun status cards if user is kepala desa
            if (currentUser.role_id === 1) {
                document.getElementById('dusun-status-cards').style.display = 'block';
                
                // Render status cards for all dusuns
                const statusContainer = document.getElementById('dusun-status-container');
                statusContainer.innerHTML = mockDesa.dusuns.map(dusun => {
                    const thirtyDaysAgo = new Date(); 
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const dusunReports = mockReports.filter(r => 
                        r.dusun_id === dusun.id && new Date(r.created_at) > thirtyDaysAgo
                    );
                    const totalReports = dusunReports.length;
                    const unresolvedReports = dusunReports.filter(r => r.status === 'belum_selesai').length;
                    const riskPercentage = totalReports > 0 ? Math.round((unresolvedReports / totalReports) * 100) : 0;
                    
                    let statusClass = 'aman';
                    let statusText = 'Aman';
                    if (riskPercentage > 30) {
                        statusClass = 'bahaya';
                        statusText = 'Bahaya';
                    } else if (riskPercentage > 0) {
                        statusClass = 'waspada';
                        statusText = 'Waspada';
                    }
                    
                    const kepalaText = dusun.kepala_dusun_name ? 
                        `${dusun.kepala_dusun_name} ${dusun.kepala_verified ? '<span class="verification-badge verified">Terverifikasi</span>' : '<span class="verification-badge">Menunggu Verifikasi</span>'}` : 
                        'Belum ada Kepala Dusun';
                    
                    return `
                        <div class="dusun-status-card ${statusClass}">
                            <h5>${dusun.name}</h5>
                            <p>Kepala Dusun: ${kepalaText}</p>
                            <p>Status: ${statusText} (${riskPercentage}% risiko)</p>
                            <button class="btn btn-sm btn-primary" onclick="showDusunDetail('${dusun.id}')">Detail Kejadian</button>
                        </div>
                    `;
                }).join('');
            }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Update UI based on current user
            document.getElementById('topbar-username').innerText = currentUser.name;
            document.getElementById('topbar-avatar').innerText = currentUser.name.split(' ').map(n=>n[0]).join('');
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-phone').innerText = currentUser.phone;
            document.getElementById('profile-email').innerText = currentUser.email;
            document.getElementById('profile-role').innerText = currentUser.role_name;
            document.getElementById('profile-desa').innerText = currentUser.desa_name;
            document.getElementById('profile-dusun').innerText = currentUser.dusun_name || '-';
            
            // Update dusun info
            document.getElementById('dusun-name').textContent = currentUser.dusun_name || 'Semua Dusun';
            document.getElementById('desa-name').textContent = `Desa: ${currentUser.desa_name}`;
            document.getElementById('user-role').textContent = currentUser.role_name;
            
            // Show/hide desa management nav based on role
            if (currentUser.role_id === 1) {
                document.getElementById('desa-management-nav').style.display = 'flex';
                document.getElementById('aktivitas-nav').style.display = 'none';
            } else {
                document.getElementById('desa-management-nav').style.display = 'none';
                document.getElementById('aktivitas-nav').style.display = 'flex';
            }
            
            updateLocationField();
            
            // Start countdown timer
            updateCodeCountdown();
            setInterval(updateCodeCountdown, 1000);

            renderHome();
            renderReports();

            // Event listeners for filters
            document.getElementById('my-filter-type').addEventListener('change', renderMyReports);
            document.getElementById('my-filter-status').addEventListener('change', renderMyReports);
            document.getElementById('my-filter-month').addEventListener('change', renderMyReports);
            document.getElementById('my-filter-date').addEventListener('change', renderMyReports);
            
            document.getElementById('other-filter-type').addEventListener('change', renderOtherReports);
            document.getElementById('other-filter-status').addEventListener('change', renderOtherReports);
            document.getElementById('other-filter-month').addEventListener('change', renderOtherReports);
            document.getElementById('other-filter-date').addEventListener('change', renderOtherReports);
        });
    </script>
</body>
</html>
