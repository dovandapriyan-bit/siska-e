<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>SISKA-E (Sistem Keamanan - Elektronik)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{ 
      --muted:#6b7280; --accent:#ef4444; --safe:#16a34a; --caution:#f59e0b; --danger:#ef4444; --card-radius:12px;
      --primary: #2563eb; --secondary: #64748b; --success: #16a34a; --warning: #f59e0b; --danger: #ef4444;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body{
      background:#f4f7ff;
      font-family: 'Inter', Segoe UI, Arial, sans-serif;
      padding:16px;
      padding-bottom:80px;
      -webkit-text-size-adjust:100%;
      font-weight: 400;
      line-height: 1.6;
    }
    
    .card{
      border-radius:var(--card-radius);
      box-shadow:0 8px 30px rgba(14,30,60,0.06);
      margin-bottom:16px;
      border: none;
    }
    
    .form-control,.btn{
      border-radius:8px;
      font-family: 'Inter', sans-serif;
    }
    
    .muted{color:var(--muted);font-size:0.95rem;}
    #map, #posFormMap, #posViewMap { width:100%; height:360px; border-radius:8px; background:#eef; }
    .hidden{display:none!important;}
    
    .sos-btn{
      width:110px;height:110px;border-radius:999px;
      background:var(--accent);color:#fff;font-weight:800;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;border:none;cursor:pointer;
      box-shadow:0 12px 32px rgba(239,68,68,0.25);margin:0 auto;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .sos-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 16px 40px rgba(239,68,68,0.4);
    }
    
    @media(max-width:767px){ 
      .sos-btn{width:96px;height:96px;} 
      body{padding-bottom:160px;} 
    }
    
    .pos-photo{max-width:100%;max-height:160px;border-radius:8px;margin-top:6px;display:block;}
    .small{font-size:0.85rem;color:#555;}
    
    .kejadian-option{
      display:inline-block;margin:6px;text-align:center;cursor:pointer;
      padding:12px 8px;border-radius:12px;border:2px solid #eee;background:#fff;
      width:110px;transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .kejadian-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .kejadian-option span{display:block;margin-top:6px;font-size:0.9rem;font-weight:500;}
    .status-aman{color:var(--safe);font-weight:700}
    .status-waspada{color:var(--caution);font-weight:700}
    .status-rawan{color:var(--danger);font-weight:700}
    
    .table-sm td,.table-sm th{padding:.35rem .5rem;}
    .modal-overlay{
      position:fixed;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,.5);display:flex;align-items:center;
      justify-content:center;z-index:1200;
    }
    
    .modal-box{
      width:92%;max-width:820px;background:#fff;padding:20px;
      border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);
      overflow:auto;max-height:90vh;
    }
    
    .file-label{
      display:inline-block;padding:.45rem .6rem;border-radius:8px;
      background:#f8fafc;border:1px dashed #e5e7eb;cursor:pointer;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      max-width: 80px;
    }
    
    .nav-item.active {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
    }
    
    .nav-item i {
      font-size: 22px;
      margin-bottom: 6px;
      transition: all 0.3s ease;
    }
    
    .nav-item.sos {
      background: linear-gradient(135deg, #ef4444, #f87171);
      color: white;
    }
    
    .nav-item.sos.active {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    
    .nav-label {
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    /* Typography Improvements */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      color: #1e293b;
    }
    
    h2 {
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h5, h6 {
      font-weight: 600;
      color: #334155;
    }
    
    .subtitle {
      font-size: 0.9rem;
      color: #64748b;
      font-weight: 500;
    }
    
    /* Table Improvements */
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .table {
      margin-bottom: 0;
      font-family: 'Inter', sans-serif;
    }
    
    .table thead th {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #475569;
      padding: 12px 16px;
    }
    
    .table tbody td {
      padding: 12px 16px;
      border-color: #f1f5f9;
    }
    
    .table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    /* Pagination */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding: 12px 0;
    }
    
    .page-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background: white;
      color: #475569;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .page-btn:hover:not(:disabled) {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .page-info {
      font-weight: 600;
      color: #475569;
      font-family: 'Inter', sans-serif;
    }
    
    /* Statistik Table Fix */
    .statistik-table {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .statistik-table .table {
      font-size: 0.9rem;
    }
    
    .statistik-table .progress {
      height: 8px;
      border-radius: 4px;
    }
    
    .statistik-table .progress-bar {
      border-radius: 4px;
    }
    
    /* Report Limits */
    .report-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 8px;
    }
    
    .report-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .report-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    
    .report-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .report-container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Button Improvements */
    .btn {
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Alert Improvements */
    .alert {
      border: none;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
    }
    
    /* Semua input pendaftaran otomatis huruf besar */
    #authCard input,
    #authCard select,
    #authCard textarea {
      text-transform: uppercase;
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- Extras -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="text-center mb-3">
  <h2 class="mb-1">SISKA-E</h2>
  <div class="subtitle">(Sistem Keamanan Elektronik)</div>
</div>

<!-- AUTH -->
<div id="authCard" class="card p-3">
  <!-- FORM LOGIN -->
  <div id="loginCard">
    <h5>Login</h5>
    <input id="login_hp" class="form-control mb-2" placeholder="Nomor HP (contoh: 0812...)" oninput="formatPhoneTyping(this)">
    <input id="login_pass" type="password" class="form-control mb-2" placeholder="Password">
    <div class="d-grid gap-2 mb-2">
      <button class="btn btn-primary" onclick="onLogin()">Login</button>
    </div>
    <p class="small">Belum punya akun? 
      <a href="javascript:void(0)" onclick="showRegisterForm()">Daftar di sini</a>
    </p>
  </div>

  <!-- FORM DAFTAR (disembunyikan awal) -->
  <div id="registerCard" style="display:none;">
    <h5>Pendaftaran Warga</h5>
    <input id="reg_nama" class="form-control mb-2" placeholder="Nama lengkap">
    <input id="reg_hp" class="form-control mb-2" placeholder="Nomor HP (0812...)" oninput="formatPhoneTyping(this)">
    <input id="reg_password" type="password" class="form-control mb-2" placeholder="Password ">
    <label class="form-label small">Pilih Status / Subrole</label>
    <select id="reg_status" class="form-control mb-2">
      <optgroup label="A. Kepala">
        <option value="kepala_desa">Kepala Desa</option>
        <option value="kepala_dusun">Kepala Dusun</option>
        <option value="ketua_rt_rw">Ketua RT</option>
        <option value="ketua_rt_rw">Ketua RW</option>
        <option value="kepala_keluarga">Kepala Keluarga</option>
      </optgroup>
      <optgroup label="B. Istri">
        <option value="istri">Istri</option>            
      </optgroup>
      <optgroup label="C. Anak">
        <option value="anak">Anak</option>
      </optgroup>
    </select>

    <!-- Region dropdowns -->
    <label class="form-label small">Provinsi / Kabupaten / Kecamatan / Desa / Dusun</label>
    <select id="reg_prov" class="form-control mb-1"><option value="">Pilih Provinsi</option></select>
    <select id="reg_kab" class="form-control mb-1"><option value="">Pilih Kabupaten/Kota</option></select>
    <select id="reg_kec" class="form-control mb-1"><option value="">Pilih Kecamatan</option></select>
    <select id="reg_des" class="form-control mb-1"><option value="">Pilih Desa/Kelurahan</option></select>

    <div class="row g-2 mb-2">
      <div class="col"><input id="reg_blok" class="form-control" placeholder="Blok (opsional)"></div>
      <div class="col"><input id="reg_no" class="form-control" placeholder="No Rumah (opsional)"></div>
    </div>
    <div class="row g-2 mb-2">
      <div class="col"><input id="reg_rt" class="form-control" placeholder="RT (mis. 001)" maxlength="3" onblur="padRT(this)"></div>
      <div class="col"><input id="reg_rw" class="form-control" placeholder="RW (mis. 001)" maxlength="3" onblur="padRW(this)"></div>
    </div>

    <textarea id="reg_alamat" class="form-control mb-2" placeholder="Alamat lengkap"></textarea>

    <div class="d-grid gap-2">
      <button id="btnRegister" class="btn btn-success" onclick="onRegister()">Daftar</button>
    </div>
    <p class="small">Sudah punya akun? <a href="javascript:void(0)" onclick="showLoginForm()">Login di sini</a></p>
  </div>
</div>

<!-- Dashboard Content -->
<div id="dashboardCard" class="hidden">
  <!-- Home/Dashboard -->
  <div id="homePage" class="page">
    <div class="topbar d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center">
        <div>
          Selamat datang, <b id="display_name"></b> · 
          <span id="display_role"></span> · 
          <span id="display_status"></span>
        </div>
      </div>
      <div class="muted small">Waktu: <span id="clock"></span></div>
    </div>

    <div class="row g-3">
      <div class="col-lg-4">
        <!-- Kepala Dusun Info -->
        <div class="card p-3 mb-3">
          <h6>Informasi Dusun</h6>
          <div id="dusunInfo" class="muted">Memuat...</div>
        </div>

        <!-- SOS card (jenis kejadian + lokasi + sos button) -->
        <div class="card p-3 mb-3">
          <h6>Darurat / Lapor Cepat</h6>
          <div id="kejadianGrid" class="mb-2"></div>
          <label class="form-label small">Lokasi Laporan</label>
          <select id="lap_loc_opt" class="form-control mb-2">
            <option value="rumah">Di Rumah (alamat terdaftar)</option>
            <option value="lainnya">Di Tempat Lain</option>
          </select>
          <textarea id="lap_lokasi" class="form-control mb-2 hidden" placeholder="Deskripsi alamat (jika di tempat lain!"></textarea>
          <div class="centered mt-2"><button id="sosButton" class="sos-btn" onclick="openSOS()">SOS</button></div>
        </div>

        <!-- Buat Dusun (hanya kepala) -->
        <div id="createDusunCard" class="card p-3 mb-3 hidden">
          <h6>Buat Dusun (Kepala)</h6>
          <input id="dusun_nama" class="form-control mb-2" placeholder="Nama Dusun">
          <div class="d-grid gap-2"><button class="btn btn-primary" onclick="createDusun()">Buat Dusun</button></div>
          <div class="muted small mt-2">Kode dusun hanya terlihat oleh Kepala Dusun yang membuatnya.</div>
          <div id="myDusunCode" class="muted small mt-2"></div>
          <div id="kodeCountdown" class="muted small mt-1"></div>
          <div class="d-flex gap-2 mt-2">
            <button id="regenKodeBtn" class="btn btn-outline-primary btn-sm hidden" onclick="regenerateKodeDusun()">Regenerate Kode</button>
            <button id="expireKodeBtn" class="btn btn-outline-danger btn-sm hidden" onclick="expireKodeNow()">Expire Kode</button>
          </div>
        </div>

        <!-- Gabung Dusun -->
        <div id="joinDusunCard" class="card p-3 mb-3 hidden">
          <h6>Gabung Dusun</h6>
          <input id="join_kode" class="form-control upper mb-2" placeholder="Masukkan Kode Dusun">
          <div class="d-grid gap-2"><button class="btn btn-success" onclick="joinDusun()">Gabung</button></div>
        </div>

        <!-- Pending (only for kepala) -->
        <div id="pendingCard" class="card p-3 mb-3 hidden">
          <h6>Pending Pendaftar</h6>
          <div id="pendingList" class="muted">Memuat...</div>
        </div>
        <div id="verificationCard" class="card p-3 mb-3 hidden">
          <h6>Verifikasi Hierarki</h6>
          <div id="pendingVerifications" class="muted">Memuat...</div>
        </div>
      </div>

      <div class="col-lg-8">
        <!-- Map -->
        <div class="card p-3 mb-3">
          <h6>Peta Pos & Dusun</h6>
          <div id="map">Memuat peta...</div>
          <div class="d-flex gap-2 mt-3">
            <button id="btnOpenPosForm" class="btn btn-outline-primary hidden" onclick="openPosForm()">Tambah Pos</button>
            <button class="btn btn-outline-secondary" onclick="loadPosList()">Muat Ulang Pos</button>
          </div>
          <div id="posList" class="mt-3"></div>
        </div>

        <!-- History Laporan -->
        <div class="card p-3 mb-3">
          <h6>Riwayat Laporan Saya</h6>
          <div id="myReports" class="report-container">Memuat...</div>
          <div class="pagination-container">
            <button id="prevMyReports" class="page-btn" onclick="changeMyReportsPage(-1)">← Sebelumnya</button>
            <span id="pageMyInfo" class="page-info">Halaman 1</span>
            <button id="nextMyReports" class="page-btn" onclick="changeMyReportsPage(1)">Selanjutnya →</button>
          </div>
        </div>
        
        <div class="card p-3 mb-3">
          <h6>Riwayat Laporan Warga Lain (Dusun)</h6>
          <div id="otherReports" class="report-container">Memuat...</div>
          <div class="pagination-container">
            <button id="prevOtherReports" class="page-btn" onclick="changeOtherReportsPage(-1)">← Sebelumnya</button>
            <span id="pageOtherInfo" class="page-info">Halaman 1</span>
            <button id="nextOtherReports" class="page-btn" onclick="changeOtherReportsPage(1)">Selanjutnya →</button>
          </div>
        </div>

        <!-- Statistik 30 hari -->
        <div class="card p-3 mb-3">
          <h6>Statistik Kejadian (30 hari)</h6>
          <canvas id="chartKejadian" style="height:180px"></canvas>
          <div id="statSummary" class="mt-2"></div>
        </div>

        <!-- Anggota Keluarga -->
        <div class="card p-3 mb-3">
          <h6>Anggota Keluarga (Alamat Sama)</h6>
          <div id="familyList">Memuat...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistik Page -->
  <div id="statistikPage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5>Statistik Laporan Per Bulan</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <select id="filterBulanStatistik" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
        <div class="col-md-6">
          <select id="filterTahunStatistik" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
      </div>
      <canvas id="chartStatistik" style="height:300px"></canvas>
      <div id="statistikSummary" class="mt-3"></div>
    </div>
  </div>

  <!-- SOS Page -->
  <div id="sosPage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5 class="text-center">Darurat / Lapor Cepat</h5>
      <div id="kejadianGridSOS" class="mb-3 text-center"></div>
      <label class="form-label small">Lokasi Laporan</label>
      <select id="lap_loc_opt_sos" class="form-control mb-2">
        <option value="rumah">Di Rumah (alamat terdaftar)</option>
        <option value="lainnya">Di Tempat Lain</option>
      </select>
      <textarea id="lap_lokasi_sos" class="form-control mb-3 hidden" placeholder="Deskripsi alamat (jika di tempat lain)"></textarea>
      <div class="text-center">
        <button id="sosButtonBig" class="sos-btn" onclick="openSOSFromPage()">SOS</button>
      </div>
    </div>
  </div>

  <!-- Laporan Page -->
  <div id="laporanPage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5>Riwayat Laporan</h5>
      <div class="row mb-3">
        <div class="col-md-4">
          <select id="filterBulanLaporan" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
        <div class="col-md-4">
          <select id="filterTahunLaporan" class="form-control">
            <!-- Options akan diisi oleh JavaScript -->
          </select>
        </div>
        <div class="col-md-4">
          <select id="filterJenisLaporan" class="form-control">
            <option value="semua">Semua Laporan</option>
            <option value="saya">Laporan Saya</option>
            <option value="warga">Laporan Warga Lain</option>
          </select>
        </div>
      </div>
      
      <div id="laporanListContainer">
        <div id="laporanList" class="mb-3"></div>
        <div class="pagination-container">
          <button id="prevPageBtn" class="page-btn" onclick="changeLaporanPage(-1)">← Sebelumnya</button>
          <span id="pageInfo" class="page-info">Halaman 1</span>
          <button id="nextPageBtn" class="page-btn" onclick="changeLaporanPage(1)">Selanjutnya →</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Page -->
  <div id="profilePage" class="page hidden">
    <div class="card p-3 mb-3">
      <h5>Profile User</h5>
      <div id="profileContentPage">
        <!-- Data akan diisi oleh JavaScript -->
      </div>
      <div class="d-grid gap-2 mt-3">
        <button class="btn btn-warning" onclick="showChangeRoleModal()">Ubah Role</button>
        <button class="btn btn-info" onclick="showChangePasswordModal()">Ubah Password</button>
        <button class="btn btn-danger" onclick="showDeleteAccountModal()">Hapus Akun</button>
        <button class="btn btn-secondary" onclick="onLogout()">Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- Pos Form Modal (inline) -->
<div id="posModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5 id="posModalTitle">Tambah Pos</h5>
    <div id="posFormArea">
      <input id="pos_name" class="form-control mb-2" placeholder="Nama Pos (mis. Pos RT01)">
      <div class="row g-2">
        <div class="col"><input id="pos_rt" class="form-control" placeholder="RT (001)"></div>
        <div class="col"><input id="pos_rw" class="form-control" placeholder="RW (001)"></div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col">
          <select id="pos_status" class="form-control">
            <option value="active">Active</option>
            <option value="pasif">Pasif</option>
          </select>
        </div>
        <div class="col">
          <select id="pos_jenis" class="form-control">
            <option value="pos_dusun">Pos Dusun</option>
            <option value="pos_rt">Pos RT</option>
          </select>
        </div>
      </div>
      <div class="mt-2">
        <label class="file-label">Pilih Foto <input id="pos_photo" type="file" accept="image/*" style="display:none"></label>
        <div id="posPhotoPreview" class="mt-2"></div>
      </div>
      <div class="mt-2">
        <small class="muted">Tandai lokasi di map (tetap di halaman ini). Klik titik pada peta untuk memilih lokasi.</small>
        <div id="posFormMap" class="mt-2"></div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-success" onclick="setPosLocationFromMap()">Set Lokasi</button>
          <button class="btn btn-primary" onclick="savePosFromModal()">Simpan Pos</button>
          <button class="btn btn-outline-secondary" onclick="closePosForm()">Batal</button>
        </div>
        <div id="chosenPosCoord" class="muted small mt-2">Lokasi belum ditetapkan.</div>
      </div>
    </div>
  </div>
</div>

<!-- Pos View Modal -->
<div id="posViewModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Detail Pos</h5>
    <div id="posViewContent"></div>
    <div id="posViewMap" class="mt-2"></div>
    <div class="d-flex gap-2 mt-3 justify-content-end">
      <button class="btn btn-secondary" onclick="closePosView()">Tutup</button>
    </div>
  </div>
</div>

<!-- Modal untuk Ubah Role -->
<div id="changeRoleModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Ubah Role</h5>
    <div class="mb-3">
      <label class="form-label">Pilih Role Baru</label>
      <select id="newRole" class="form-control">
        <optgroup label="A. Kepala">
          <option value="kepala_desa">Kepala Desa</option>
          <option value="kepala_dusun">Kepala Dusun</option>
          <option value="ketua_rt_rw">Ketua RT</option>
          <option value="ketua_rt_rw">Ketua RW</option>
          <option value="kepala_keluarga">Kepala Keluarga</option>
        </optgroup>
        <optgroup label="B. Istri">
          <option value="istri">Istri</option>            
        </optgroup>
        <optgroup label="C. Anak">
          <option value="anak">Anak</option>
        </optgroup>
      </select>
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button class="btn btn-secondary" onclick="hideChangeRoleModal()">Batal</button>
      <button class="btn btn-primary" onclick="updateRole()">Simpan</button>
    </div>
  </div>
</div>

<!-- Modal untuk Ubah Password -->
<div id="changePasswordModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Ubah Password</h5>
    <div class="mb-3">
      <label class="form-label">Password Baru</label>
      <input id="newPassword" type="password" class="form-control" placeholder="Masukkan password baru">
    </div>
    <div class="mb-3">
      <label class="form-label">Konfirmasi Password</label>
      <input id="confirmPassword" type="password" class="form-control" placeholder="Konfirmasi password baru">
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button class="btn btn-secondary" onclick="hideChangePasswordModal()">Batal</button>
      <button class="btn btn-primary" onclick="updatePassword()">Simpan</button>
    </div>
  </div>
</div>

<!-- Modal untuk Hapus Akun -->
<div id="deleteAccountModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h5>Hapus Akun</h5>
    <div class="mb-3">
      <p>Apakah Anda yakin ingin menghapus akun? Tindakan ini tidak dapat dibatalkan.</p>
    </div>
    <div class="d-flex gap-2 justify-content-end">
      <button class="btn btn-secondary" onclick="hideDeleteAccountModal()">Batal</button>
      <button class="btn btn-danger" onclick="deleteAccount()">Hapus Akun</button>
    </div>
  </div>
</div>

<!-- ================== BOTTOM NAVIGATION ================== -->
<div id="bottomNav" class="bottom-nav hidden">
  <div class="nav-item active" onclick="showPage('homePage')">
    <i class="fas fa-home"></i>
    <span class="nav-label">Home</span>
  </div>
  <div class="nav-item" onclick="showPage('statistikPage')">
    <i class="fas fa-chart-bar"></i>
    <span class="nav-label">Statistik</span>
  </div>
  <div class="nav-item sos" onclick="showPage('sosPage')">
    <i class="fas fa-exclamation-triangle"></i>
    <span class="nav-label">SOS</span>
  </div>
  <div class="nav-item" onclick="showPage('laporanPage')">
    <i class="fas fa-list"></i>
    <span class="nav-label">Laporan</span>
  </div>
  <div class="nav-item" onclick="showPage('profilePage')">
    <i class="fas fa-user"></i>
    <span class="nav-label">Profil</span>
  </div>
</div>

<!-- ================== FIREBASE CONFIG ================== -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDp6r3Y7qX4q9h5KZb8X4Q7M8X9Y0Z1A2B",
    authDomain: "siska-e.firebaseapp.com",
    projectId: "siska-e",
    storageBucket: "siska-e.appspot.com",
    messagingSenderId: "123456789012",
    appId: "1:123456789012:web:abcdef123456"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Global variables
  let currentUser = null;
  let userData = null;
  let dusunData = null;
  let map = null;
  let posFormMap = null;
  let posViewMap = null;
  let selectedPosCoord = null;
  let posMarkers = [];
  let myReportsPage = 1;
  let otherReportsPage = 1;
  let laporanPage = 1;
  let laporanFilter = {
    bulan: new Date().getMonth() + 1,
    tahun: new Date().getFullYear(),
    jenis: 'semua'
  };

  /* ================== AUTOFILL ALAMAT ================== */
function autofillAlamat(){
  const prov = $('reg_prov').selectedOptions[0]?.text || '';
  const kab = $('reg_kab').selectedOptions[0]?.text || '';
  const kec = $('reg_kec').selectedOptions[0]?.text || '';
  const des = $('reg_des').selectedOptions[0]?.text || '';
  const blok = $('reg_blok').value || '';
  const no = $('reg_no').value || '';
  const rt = $('reg_rt').value || '';
  const rw = $('reg_rw').value || '';
  
  // Format alamat otomatis
  let alamat = '';
  
  if (blok) alamat += 'Blok ' + blok;
  if (no) alamat += (alamat ? ' - ' : '') + 'No. ' + no;
  if (rt || rw) alamat += (alamat ? ', ' : '') + 'RT ' + (rt || '000') + ' / RW ' + (rw || '000');
  if (des) alamat += (alamat ? ', ' : '') + 'Desa ' + des;
  if (kec) alamat += (alamat ? ', ' : '') + 'Kec. ' + kec;
  if (kab) alamat += (alamat ? ', ' : '') + (kab.includes('Kota') ? kab : 'Kab. ' + kab);
  if (prov) alamat += (alamat ? ', ' : '') + 'Prov. ' + prov;
  
  $('reg_alamat').value = alamat;
}

/* ================== LOAD REGION DROPDOWNS ================== */
const API_REG = "https://www.emsifa.com/api-wilayah-indonesia/api/";
async function loadRegionDropdowns(){
  try{
    const res = await fetch(API_REG + 'provinces.json'); 
    const provs = await res.json();
    const provSel = $('reg_prov');
    provSel.innerHTML = '<option value="">Pilih Provinsi</option>';
    provs.forEach(p=>provSel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    
    // EVENT LISTENER UNTUK PROVINSI
    $('reg_prov').addEventListener('change', async function(){
      $('reg_kab').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>'; 
      $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>';
      if(!this.value) { autofillAlamat(); return; }
      const r = await fetch(API_REG + 'regencies/' + this.value + '.json'); 
      const data = await r.json();
      data.forEach(k => $('reg_kab').innerHTML += `<option value="${k.id}">${k.name}</option>`);
      autofillAlamat();
    });
    
    // EVENT LISTENER UNTUK KABUPATEN
    $('reg_kab').addEventListener('change', async function(){ 
      $('reg_kec').innerHTML = '<option value="">Pilih Kecamatan</option>'; 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; 
      if(!this.value) { autofillAlamat(); return; } 
      const r = await fetch(API_REG + 'districts/' + this.value + '.json'); 
      const data = await r.json(); 
      data.forEach(k => $('reg_kec').innerHTML += `<option value="${k.id}">${k.name}</option>`); 
      autofillAlamat(); 
    });
    
    // EVENT LISTENER UNTUK KECAMATAN
    $('reg_kec').addEventListener('change', async function(){ 
      $('reg_des').innerHTML = '<option value="">Pilih Desa</option>'; 
      if(!this.value) { autofillAlamat(); return; } 
      const r = await fetch(API_REG + 'villages/' + this.value + '.json'); 
      const data = await r.json(); 
      data.forEach(d => $('reg_des').innerHTML += `<option value="${d.id}">${d.name}</option>`); 
      autofillAlamat(); 
    });
    
    // EVENT LISTENER UNTUK DESA
    $('reg_des').addEventListener('change', autofillAlamat);
    
    // EVENT LISTENER UNTUK INPUT MANUAL (RT, RW, BLOK, NO)
    ['reg_blok','reg_no','reg_rt','reg_rw'].forEach(id=>{ 
      const el = $(id); 
      if(el) el.addEventListener('input', autofillAlamat); 
    });
    
  }catch(e){ console.warn('Gagal load region', e); }
}

  // Initialize app
  document.addEventListener('DOMContentLoaded', function() {
    initClock();
    loadRegionData();
    loadKejadianOptions();
    initFilters();
    
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadUserData();
      } else {
        showAuth();
      }
    });
  });

  // Initialize filter dropdowns
  function initFilters() {
    // Initialize bulan filter
    const bulanOptions = [
      {value: 1, text: 'Januari'},
      {value: 2, text: 'Februari'},
      {value: 3, text: 'Maret'},
      {value: 4, text: 'April'},
      {value: 5, text: 'Mei'},
      {value: 6, text: 'Juni'},
      {value: 7, text: 'Juli'},
      {value: 8, text: 'Agustus'},
      {value: 9, text: 'September'},
      {value: 10, text: 'Oktober'},
      {value: 11, text: 'November'},
      {value: 12, text: 'Desember'}
    ];
    
    const bulanSelects = [
      document.getElementById('filterBulanStatistik'),
      document.getElementById('filterBulanLaporan')
    ];
    
    bulanSelects.forEach(select => {
      if (select) {
        select.innerHTML = '<option value="semua">Semua Bulan</option>';
        bulanOptions.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option.value;
          opt.textContent = option.text;
          if (parseInt(option.value) === new Date().getMonth() + 1) {
            opt.selected = true;
          }
          select.appendChild(opt);
        });
        
        select.addEventListener('change', function() {
          if (select.id === 'filterBulanStatistik') {
            loadStatistikData();
          } else if (select.id === 'filterBulanLaporan') {
            laporanFilter.bulan = this.value === 'semua' ? 'semua' : parseInt(this.value);
            loadLaporanData();
          }
        });
      }
    });
    
    // Initialize tahun filter
    const tahunSekarang = new Date().getFullYear();
    const tahunOptions = [];
    for (let i = tahunSekarang; i >= tahunSekarang - 5; i--) {
      tahunOptions.push(i);
    }
    
    const tahunSelects = [
      document.getElementById('filterTahunStatistik'),
      document.getElementById('filterTahunLaporan')
    ];
    
    tahunSelects.forEach(select => {
      if (select) {
        select.innerHTML = '';
        tahunOptions.forEach(tahun => {
          const opt = document.createElement('option');
          opt.value = tahun;
          opt.textContent = tahun;
          if (tahun === tahunSekarang) {
            opt.selected = true;
          }
          select.appendChild(opt);
        });
        
        select.addEventListener('change', function() {
          if (select.id === 'filterTahunStatistik') {
            loadStatistikData();
          } else if (select.id === 'filterTahunLaporan') {
            laporanFilter.tahun = parseInt(this.value);
            loadLaporanData();
          }
        });
      }
    });
    
    // Initialize jenis laporan filter
    const jenisSelect = document.getElementById('filterJenisLaporan');
    if (jenisSelect) {
      jenisSelect.addEventListener('change', function() {
        laporanFilter.jenis = this.value;
        loadLaporanData();
      });
    }
  }

  // Clock
  function initClock() {
    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const dateStr = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('clock').innerHTML = `${timeStr} · ${dateStr}`;
    }
    updateClock();
    setInterval(updateClock, 1000);
  }

  // Region data
  async function loadRegionData() {
    try {
      const response = await fetch('https://www.emsifa.com/api-wilayah-indonesia/api/provinces.json');
      const provinces = await response.json();
      const provSelect = document.getElementById('reg_prov');
      provSelect.innerHTML = '<option value="">Pilih Provinsi</option>';
      provinces.forEach(prov => {
        const opt = document.createElement('option');
        opt.value = prov.id;
        opt.textContent = prov.name;
        provSelect.appendChild(opt);
      });
      
      provSelect.addEventListener('change', function() {
        if (this.value) loadKabupaten(this.value);
      });
    } catch (error) {
      console.error('Error loading provinces:', error);
    }
  }

  async function loadKabupaten(provId) {
    try {
      const response = await fetch(`https://www.emsifa.com/api-wilayah-indonesia/api/regencies/${provId}.json`);
      const kabupatens = await response.json();
      const kabSelect = document.getElementById('reg_kab');
      kabSelect.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
      kabupatens.forEach(kab => {
        const opt = document.createElement('option');
        opt.value = kab.id;
        opt.textContent = kab.name;
        kabSelect.appendChild(opt);
      });
      
      kabSelect.addEventListener('change', function() {
        if (this.value) loadKecamatan(this.value);
      });
    } catch (error) {
      console.error('Error loading kabupaten:', error);
    }
  }

  async function loadKecamatan(kabId) {
    try {
      const response = await fetch(`https://www.emsifa.com/api-wilayah-indonesia/api/districts/${kabId}.json`);
      const kecamatans = await response.json();
      const kecSelect = document.getElementById('reg_kec');
      kecSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
      kecamatans.forEach(kec => {
        const opt = document.createElement('option');
        opt.value = kec.id;
        opt.textContent = kec.name;
        kecSelect.appendChild(opt);
      });
      
      kecSelect.addEventListener('change', function() {
        if (this.value) loadDesa(this.value);
      });
    } catch (error) {
      console.error('Error loading kecamatan:', error);
    }
  }

  async function loadDesa(kecId) {
    try {
      const response = await fetch(`https://www.emsifa.com/api-wilayah-indonesia/api/villages/${kecId}.json`);
      const desas = await response.json();
      const desSelect = document.getElementById('reg_des');
      desSelect.innerHTML = '<option value="">Pilih Desa/Kelurahan</option>';
      desas.forEach(des => {
        const opt = document.createElement('option');
        opt.value = des.id;
        opt.textContent = des.name;
        desSelect.appendChild(opt);
      });
    } catch (error) {
      console.error('Error loading desa:', error);
    }
  }

  // Kejadian options
  function loadKejadianOptions() {
    const kejadianList = [
      { icon: 'fa-house-fire', label: 'Kebakaran', value: 'kebakaran' },
      { icon: 'fa-person-falling', label: 'Kecelakaan', value: 'kecelakaan' },
      { icon: 'fa-user-injured', label: 'Kekerasan', value: 'kekerasan' },
      { icon: 'fa-house-crack', label: 'Bencana', value: 'bencana' },
      { icon: 'fa-mask', label: 'Kriminal', value: 'kriminal' },
      { icon: 'fa-syringe', label: 'Medis', value: 'medis' },
      { icon: 'fa-triangle-exclamation', label: 'Lainnya', value: 'lainnya' }
    ];
    
    const gridHome = document.getElementById('kejadianGrid');
    const gridSOS = document.getElementById('kejadianGridSOS');
    
    kejadianList.forEach(kej => {
      const option = document.createElement('div');
      option.className = 'kejadian-option';
      option.setAttribute('data-value', kej.value);
      option.innerHTML = `<i class="fas ${kej.icon} fa-2x"></i><span>${kej.label}</span>`;
      option.onclick = function() { selectKejadian(kej.value); };
      
      if (gridHome) gridHome.appendChild(option.cloneNode(true));
      if (gridSOS) gridSOS.appendChild(option);
    });
  }

  function selectKejadian(value) {
    document.querySelectorAll('.kejadian-option').forEach(el => {
      el.style.borderColor = '#eee';
      el.style.background = '#fff';
    });
    
    document.querySelectorAll(`.kejadian-option[data-value="${value}"]`).forEach(el => {
      el.style.borderColor = 'var(--accent)';
      el.style.background = '#fef2f2';
    });
    
    window.selectedKejadian = value;
  }

  // Auth functions
  function showRegisterForm() {
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('registerCard').style.display = 'block';
  }

  function showLoginForm() {
    document.getElementById('registerCard').style.display = 'none';
    document.getElementById('loginCard').style.display = 'block';
  }

  function formatPhoneTyping(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.startsWith('0')) value = '62' + value.substring(1);
    input.value = value;
  }

  function padRT(input) {
    if (input.value && input.value.length < 3) {
      input.value = input.value.padStart(3, '0');
    }
  }

  function padRW(input) {
    if (input.value && input.value.length < 3) {
      input.value = input.value.padStart(3, '0');
    }
  }

  async function onRegister() {
    const btn = document.getElementById('btnRegister');
    const originalText = btn.textContent;
    btn.textContent = 'Mendaftar...';
    btn.disabled = true;
    
    try {
      const nama = document.getElementById('reg_nama').value.trim().toUpperCase();
      const hp = document.getElementById('reg_hp').value.trim();
      const password = document.getElementById('reg_password').value;
      const status = document.getElementById('reg_status').value;
      const prov = document.getElementById('reg_prov').value;
      const kab = document.getElementById('reg_kab').value;
      const kec = document.getElementById('reg_kec').value;
      const des = document.getElementById('reg_des').value;
      const blok = document.getElementById('reg_blok').value.trim().toUpperCase();
      const no = document.getElementById('reg_no').value.trim().toUpperCase();
      const rt = document.getElementById('reg_rt').value.trim();
      const rw = document.getElementById('reg_rw').value.trim();
      const alamat = document.getElementById('reg_alamat').value.trim().toUpperCase();
      
      if (!nama || !hp || !password || !status || !prov || !kab || !kec || !des || !rt || !rw || !alamat) {
        throw new Error('Semua field wajib diisi kecuali blok dan no rumah.');
      }
      
      if (password.length < 6) {
        throw new Error('Password minimal 6 karakter.');
      }
      
      // Create user with email (using phone as email)
      const userCredential = await auth.createUserWithEmailAndPassword(`${hp}@siska.com`, password);
      const user = userCredential.user;
      
      // Save user data to Firestore
      await db.collection('users').doc(user.uid).set({
        nama,
        hp,
        status,
        prov,
        kab,
        kec,
        des,
        blok,
        no,
        rt,
        rw,
        alamat,
        role: 'warga',
        dusun: null,
        verified: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      Swal.fire('Sukses', 'Pendaftaran berhasil!', 'success');
      showLoginForm();
    } catch (error) {
      console.error('Registration error:', error);
      Swal.fire('Error', error.message, 'error');
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }

  async function onLogin() {
    const hp = document.getElementById('login_hp').value.trim();
    const password = document.getElementById('login_pass').value;
    
    if (!hp || !password) {
      Swal.fire('Error', 'Nomor HP dan password harus diisi.', 'error');
      return;
    }
    
    try {
      await auth.signInWithEmailAndPassword(`${hp}@siska.com`, password);
    } catch (error) {
      console.error('Login error:', error);
      Swal.fire('Error', 'Login gagal. Periksa nomor HP dan password.', 'error');
    }
  }

  function onLogout() {
    auth.signOut();
  }

  // User data
  async function loadUserData() {
    try {
      const doc = await db.collection('users').doc(currentUser.uid).get();
      if (doc.exists) {
        userData = doc.data();
        showDashboard();
        
        // Load dusun data if user has one
        if (userData.dusun) {
          await loadDusunByCode(userData.dusun);
        }
        
        // Load reports
        renderReportsFromCache();
        
        // Load profile data
        loadProfileData();
        
        // Initialize map
        initMap();
      } else {
        Swal.fire('Error', 'Data user tidak ditemukan.', 'error');
        onLogout();
      }
    } catch (error) {
      console.error('Error loading user data:', error);
      Swal.fire('Error', 'Gagal memuat data user.', 'error');
    }
  }

  // Dusun functions
  async function loadDusunByCode(code) {
    try {
      const querySnapshot = await db.collection('dusun').where('kode', '==', code).get();
      if (!querySnapshot.empty) {
        querySnapshot.forEach(doc => {
          dusunData = { id: doc.id, ...doc.data() };
        });
        
        // Update UI with dusun info
        document.getElementById('dusunInfo').innerHTML = `
          <div><strong>${dusunData.nama}</strong></div>
          <div class="small">Kode: ${dusunData.kode}</div>
          <div class="small">Dibuat: ${new Date(dusunData.createdAt.toDate()).toLocaleDateString('id-ID')}</div>
        `;
        
        // Show appropriate cards based on role
        if (userData.role === 'kepala_dusun' && userData.dusun === code) {
          document.getElementById('createDusunCard').classList.remove('hidden');
          document.getElementById('myDusunCode').innerHTML = `Kode Dusun: <strong>${dusunData.kode}</strong>`;
          loadPendingList();
          loadPendingVerifications();
        } else {
          document.getElementById('joinDusunCard').classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Error loading dusun:', error);
    }
  }

  async function createDusun() {
    const nama = document.getElementById('dusun_nama').value.trim().toUpperCase();
    if (!nama) {
      Swal.fire('Error', 'Nama dusun harus diisi.', 'error');
      return;
    }
    
    try {
      // Generate random code
      const kode = generateRandomCode(6);
      
      // Create dusun document
      const dusunRef = await db.collection('dusun').add({
        nama,
        kode,
        kepala: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        kodeExpires: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 24 * 60 * 60 * 1000)) // 24 hours
      });
      
      // Update user's dusun
      await db.collection('users').doc(currentUser.uid).update({
        dusun: kode,
        role: 'kepala_dusun'
      });
      
      userData.dusun = kode;
      userData.role = 'kepala_dusun';
      
      Swal.fire('Sukses', `Dusun "${nama}" berhasil dibuat dengan kode: ${kode}`, 'success');
      loadDusunByCode(kode);
    } catch (error) {
      console.error('Error creating dusun:', error);
      Swal.fire('Error', 'Gagal membuat dusun.', 'error');
    }
  }

  async function joinDusun() {
    const kode = document.getElementById('join_kode').value.trim().toUpperCase();
    if (!kode) {
      Swal.fire('Error', 'Kode dusun harus diisi.', 'error');
      return;
    }
    
    try {
      const querySnapshot = await db.collection('dusun').where('kode', '==', kode).get();
      if (querySnapshot.empty) {
        Swal.fire('Error', 'Kode dusun tidak valid.', 'error');
        return;
      }
      
      // Check if code is expired
      let dusunDoc;
      querySnapshot.forEach(doc => {
        dusunDoc = { id: doc.id, ...doc.data() };
      });
      
      if (dusunDoc.kodeExpires && dusunDoc.kodeExpires.toDate() < new Date()) {
        Swal.fire('Error', 'Kode dusun telah kedaluwarsa.', 'error');
        return;
      }
      
      // Update user's dusun
      await db.collection('users').doc(currentUser.uid).update({
        dusun: kode
      });
      
      userData.dusun = kode;
      
      Swal.fire('Sukses', 'Berhasil bergabung dengan dusun.', 'success');
      loadDusunByCode(kode);
    } catch (error) {
      console.error('Error joining dusun:', error);
      Swal.fire('Error', 'Gagal bergabung dengan dusun.', 'error');
    }
  }

  // Pending list for kepala dusun
  async function loadPendingList() {
    if (!userData.dusun || userData.role !== 'kepala_dusun') return;
    
    try {
      const querySnapshot = await db.collection('users')
        .where('dusun', '==', userData.dusun)
        .where('verified', '==', false)
        .get();
      
      if (querySnapshot.empty) {
        document.getElementById('pendingList').innerHTML = '<div class="small">Tidak ada pendaftar pending.</div>';
        return;
      }
      
      let html = '';
      querySnapshot.forEach(doc => {
        const user = doc.data();
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <div>
              <div><strong>${user.nama}</strong></div>
              <div class="small">${user.status} · RT ${user.rt}/RW ${user.rw}</div>
            </div>
            <div>
              <button class="btn btn-success btn-sm" onclick="verifyUser('${doc.id}')">Verifikasi</button>
              <button class="btn btn-danger btn-sm" onclick="rejectUser('${doc.id}')">Tolak</button>
            </div>
          </div>
        `;
      });
      
      document.getElementById('pendingList').innerHTML = html;
      document.getElementById('pendingCard').classList.remove('hidden');
    } catch (error) {
      console.error('Error loading pending list:', error);
    }
  }

  async function verifyUser(uid) {
    try {
      await db.collection('users').doc(uid).update({
        verified: true
      });
      Swal.fire('Sukses', 'User berhasil diverifikasi.', 'success');
      loadPendingList();
    } catch (error) {
      console.error('Error verifying user:', error);
      Swal.fire('Error', 'Gagal memverifikasi user.', 'error');
    }
  }

  async function rejectUser(uid) {
    try {
      await db.collection('users').doc(uid).update({
        dusun: null
      });
      Swal.fire('Sukses', 'User berhasil ditolak.', 'success');
      loadPendingList();
    } catch (error) {
      console.error('Error rejecting user:', error);
      Swal.fire('Error', 'Gagal menolak user.', 'error');
    }
  }

  // Pending verifications for hierarchy
  async function loadPendingVerifications() {
    if (!userData.dusun || userData.role !== 'kepala_dusun') return;
    
    try {
      const querySnapshot = await db.collection('users')
        .where('dusun', '==', userData.dusun)
        .where('verified', '==', true)
        .get();
      
      let pendingVerifications = [];
      querySnapshot.forEach(doc => {
        const user = doc.data();
        if (user.status === 'kepala_keluarga' || user.status === 'ketua_rt_rw') {
          pendingVerifications.push({ id: doc.id, ...user });
        }
      });
      
      if (pendingVerifications.length === 0) {
        document.getElementById('pendingVerifications').innerHTML = '<div class="small">Tidak ada verifikasi hierarki pending.</div>';
        return;
      }
      
      let html = '';
      pendingVerifications.forEach(user => {
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
            <div>
              <div><strong>${user.nama}</strong></div>
              <div class="small">${user.status} · RT ${user.rt}/RW ${user.rw}</div>
            </div>
            <div>
              <button class="btn btn-success btn-sm" onclick="verifyHierarchy('${user.id}')">Verifikasi</button>
            </div>
          </div>
        `;
      });
      
      document.getElementById('pendingVerifications').innerHTML = html;
      document.getElementById('verificationCard').classList.remove('hidden');
    } catch (error) {
      console.error('Error loading pending verifications:', error);
    }
  }

  async function verifyHierarchy(uid) {
    try {
      // In a real app, you might have additional verification steps
      Swal.fire('Sukses', 'Hierarki berhasil diverifikasi.', 'success');
      loadPendingVerifications();
    } catch (error) {
      console.error('Error verifying hierarchy:', error);
      Swal.fire('Error', 'Gagal memverifikasi hierarki.', 'error');
    }
  }

  // Map functions
  function initMap() {
    // Main map
    map = L.map('map').setView([-7.250445, 112.768845], 13); // Default to Surabaya
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Load pos list
    loadPosList();
  }

  function initPosFormMap() {
    if (!posFormMap) {
      posFormMap = L.map('posFormMap').setView([-7.250445, 112.768845], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(posFormMap);
      
      // Add click event to set location
      posFormMap.on('click', function(e) {
        selectedPosCoord = e.latlng;
        document.getElementById('chosenPosCoord').innerHTML = 
          `Lokasi terpilih: ${selectedPosCoord.lat.toFixed(6)}, ${selectedPosCoord.lng.toFixed(6)}`;
      });
    }
  }

  function initPosViewMap(lat, lng) {
    if (posViewMap) {
      posViewMap.remove();
    }
    
    posViewMap = L.map('posViewMap').setView([lat, lng], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(posViewMap);
    
    L.marker([lat, lng]).addTo(posViewMap)
      .bindPopup('Lokasi Pos')
      .openPopup();
  }

  // Pos functions
  async function loadPosList() {
    if (!map) return;
    
    try {
      // Clear existing markers
      posMarkers.forEach(marker => map.removeLayer(marker));
      posMarkers = [];
      
      const querySnapshot = await db.collection('pos').where('dusun', '==', userData.dusun).get();
      
      if (querySnapshot.empty) {
        document.getElementById('posList').innerHTML = '<div class="muted">Belum ada pos di dusun ini.</div>';
        return;
      }
      
      let html = '<div class="row g-2">';
      querySnapshot.forEach(doc => {
        const pos = { id: doc.id, ...doc.data() };
        
        // Add marker to map
        if (pos.lat && pos.lng) {
          const marker = L.marker([pos.lat, pos.lng]).addTo(map)
            .bindPopup(`
              <div>
                <h6>${pos.nama}</h6>
                <div class="small">RT ${pos.rt}/RW ${pos.rw}</div>
                <div class="small">Status: ${pos.status === 'active' ? 'Aktif' : 'Pasif'}</div>
                <button class="btn btn-sm btn-primary mt-1" onclick="viewPos('${pos.id}')">Lihat Detail</button>
              </div>
            `);
          posMarkers.push(marker);
        }
        
        // Add to list
        html += `
          <div class="col-md-6">
            <div class="border rounded p-2">
              <div class="d-flex justify-content-between">
                <div>
                  <div><strong>${pos.nama}</strong></div>
                  <div class="small">RT ${pos.rt}/RW ${pos.rw}</div>
                  <div class="small">Status: 
                    <span class="${pos.status === 'active' ? 'status-aman' : 'status-waspada'}">
                      ${pos.status === 'active' ? 'Aktif' : 'Pasif'}
                    </span>
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-outline-primary" onclick="viewPos('${pos.id}')">Lihat</button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      document.getElementById('posList').innerHTML = html;
      
      // Show add pos button for kepala dusun
      if (userData.role === 'kepala_dusun') {
        document.getElementById('btnOpenPosForm').classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error loading pos list:', error);
    }
  }

  function openPosForm() {
    document.getElementById('posModal').classList.remove('hidden');
    document.getElementById('posModalTitle').textContent = 'Tambah Pos';
    document.getElementById('posFormArea').innerHTML = `
      <input id="pos_name" class="form-control mb-2" placeholder="Nama Pos (mis. Pos RT01)">
      <div class="row g-2">
        <div class="col"><input id="pos_rt" class="form-control" placeholder="RT (001)"></div>
        <div class="col"><input id="pos_rw" class="form-control" placeholder="RW (001)"></div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col">
          <select id="pos_status" class="form-control">
            <option value="active">Active</option>
            <option value="pasif">Pasif</option>
          </select>
        </div>
        <div class="col">
          <select id="pos_jenis" class="form-control">
            <option value="pos_dusun">Pos Dusun</option>
            <option value="pos_rt">Pos RT</option>
          </select>
        </div>
      </div>
      <div class="mt-2">
        <label class="file-label">Pilih Foto <input id="pos_photo" type="file" accept="image/*" style="display:none"></label>
        <div id="posPhotoPreview" class="mt-2"></div>
      </div>
      <div class="mt-2">
        <small class="muted">Tandai lokasi di map (tetap di halaman ini). Klik titik pada peta untuk memilih lokasi.</small>
        <div id="posFormMap" class="mt-2"></div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-success" onclick="setPosLocationFromMap()">Set Lokasi</button>
          <button class="btn btn-primary" onclick="savePosFromModal()">Simpan Pos</button>
          <button class="btn btn-outline-secondary" onclick="closePosForm()">Batal</button>
        </div>
        <div id="chosenPosCoord" class="muted small mt-2">Lokasi belum ditetapkan.</div>
      </div>
    `;
    
    // Initialize photo upload
    document.getElementById('pos_photo').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('posPhotoPreview').innerHTML = `
            <img src="${e.target.result}" class="pos-photo" alt="Preview">
          `;
        };
        reader.readAsDataURL(file);
      }
    });
    
    initPosFormMap();
  }

  function setPosLocationFromMap() {
    if (selectedPosCoord) {
      Swal.fire('Sukses', 'Lokasi berhasil diset.', 'success');
    } else {
      Swal.fire('Error', 'Silakan klik pada peta untuk memilih lokasi.', 'error');
    }
  }

  async function savePosFromModal() {
    const nama = document.getElementById('pos_name').value.trim().toUpperCase();
    const rt = document.getElementById('pos_rt').value.trim();
    const rw = document.getElementById('pos_rw').value.trim();
    const status = document.getElementById('pos_status').value;
    const jenis = document.getElementById('pos_jenis').value;
    const photoFile = document.getElementById('pos_photo').files[0];
    
    if (!nama || !rt || !rw) {
      Swal.fire('Error', 'Nama, RT, dan RW harus diisi.', 'error');
      return;
    }
    
    if (!selectedPosCoord) {
      Swal.fire('Error', 'Silakan tentukan lokasi pos di peta.', 'error');
      return;
    }
    
    try {
      let photoURL = null;
      
      // Upload photo if exists
      if (photoFile) {
        const storageRef = storage.ref().child(`pos/${Date.now()}_${photoFile.name}`);
        await storageRef.put(photoFile);
        photoURL = await storageRef.getDownloadURL();
      }
      
      // Save pos to Firestore
      await db.collection('pos').add({
        nama,
        rt,
        rw,
        status,
        jenis,
        dusun: userData.dusun,
        lat: selectedPosCoord.lat,
        lng: selectedPosCoord.lng,
        photo: photoURL,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser.uid
      });
      
      Swal.fire('Sukses', 'Pos berhasil ditambahkan.', 'success');
      closePosForm();
      loadPosList();
    } catch (error) {
      console.error('Error saving pos:', error);
      Swal.fire('Error', 'Gagal menambahkan pos.', 'error');
    }
  }

  function closePosForm() {
    document.getElementById('posModal').classList.add('hidden');
    selectedPosCoord = null;
  }

  async function viewPos(posId) {
    try {
      const doc = await db.collection('pos').doc(posId).get();
      if (doc.exists) {
        const pos = doc.data();
        
        let html = `
          <div>
            <h6>${pos.nama}</h6>
            <div class="small">RT ${pos.rt}/RW ${pos.rw}</div>
            <div class="small">Status: ${pos.status === 'active' ? 'Aktif' : 'Pasif'}</div>
            <div class="small">Jenis: ${pos.jenis === 'pos_dusun' ? 'Pos Dusun' : 'Pos RT'}</div>
            <div class="small">Koordinat: ${pos.lat ? `${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}` : 'Tidak tersedia'}</div>
        `;
        
        if (pos.photo) {
          html += `<img src="${pos.photo}" class="pos-photo mt-2" alt="Foto Pos">`;
        }
        
        html += `</div>`;
        
        document.getElementById('posViewContent').innerHTML = html;
        document.getElementById('posViewModal').classList.remove('hidden');
        
        if (pos.lat && pos.lng) {
          initPosViewMap(pos.lat, pos.lng);
        }
      }
    } catch (error) {
      console.error('Error viewing pos:', error);
    }
  }

  function closePosView() {
    document.getElementById('posViewModal').classList.add('hidden');
  }

  // SOS functions
  function openSOS() {
    if (!window.selectedKejadian) {
      Swal.fire('Error', 'Pilih jenis kejadian terlebih dahulu.', 'error');
      return;
    }
    
    const lokasiOpt = document.getElementById('lap_loc_opt').value;
    let lokasi = '';
    
    if (lokasiOpt === 'rumah') {
      lokasi = `${userData.alamat}, RT ${userData.rt}/RW ${userData.rw}, ${userData.blok ? 'Blok ' + userData.blok : ''} ${userData.no ? 'No ' + userData.no : ''}`.trim();
    } else {
      lokasi = document.getElementById('lap_lokasi').value.trim();
      if (!lokasi) {
        Swal.fire('Error', 'Deskripsi alamat harus diisi jika memilih "Di Tempat Lain".', 'error');
        return;
      }
    }
    
    sendSOSReport(window.selectedKejadian, lokasi);
  }

  function openSOSFromPage() {
    if (!window.selectedKejadian) {
      Swal.fire('Error', 'Pilih jenis kejadian terlebih dahulu.', 'error');
      return;
    }
    
    const lokasiOpt = document.getElementById('lap_loc_opt_sos').value;
    let lokasi = '';
    
    if (lokasiOpt === 'rumah') {
      lokasi = `${userData.alamat}, RT ${userData.rt}/RW ${userData.rw}, ${userData.blok ? 'Blok ' + userData.blok : ''} ${userData.no ? 'No ' + userData.no : ''}`.trim();
    } else {
      lokasi = document.getElementById('lap_lokasi_sos').value.trim();
      if (!lokasi) {
        Swal.fire('Error', 'Deskripsi alamat harus diisi jika memilih "Di Tempat Lain".', 'error');
        return;
      }
    }
    
    sendSOSReport(window.selectedKejadian, lokasi);
  }

  async function sendSOSReport(jenis, lokasi) {
    try {
      // Get user's current location
      let lat, lng;
      
      if (navigator.geolocation) {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        });
        
        lat = position.coords.latitude;
        lng = position.coords.longitude;
      } else {
        // Fallback to user's registered address coordinates (if available)
        // In a real app, you might geocode the address
        lat = -7.250445;
        lng = 112.768845;
      }
      
      // Save report to Firestore
      await db.collection('reports').add({
        jenis,
        lokasi,
        lat,
        lng,
        userId: currentUser.uid,
        userName: userData.nama,
        userHp: userData.hp,
        userRt: userData.rt,
        userRw: userData.rw,
        dusun: userData.dusun,
        status: 'dilaporkan',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      Swal.fire('Sukses', 'Laporan darurat berhasil dikirim!', 'success');
      
      // Reset form
      document.querySelectorAll('.kejadian-option').forEach(el => {
        el.style.borderColor = '#eee';
        el.style.background = '#fff';
      });
      window.selectedKejadian = null;
      
      // Reload reports
      renderReportsFromCache();
    } catch (error) {
      console.error('Error sending SOS report:', error);
      Swal.fire('Error', 'Gagal mengirim laporan darurat.', 'error');
    }
  }

  // Report functions
  async function renderReportsFromCache() {
    if (!userData.dusun) return;
    
    try {
      // Load my reports
      const myReportsQuery = await db.collection('reports')
        .where('dusun', '==', userData.dusun)
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .limit(10)
        .get();
      
      let myReportsHtml = '';
      if (myReportsQuery.empty) {
        myReportsHtml = '<div class="muted">Belum ada laporan.</div>';
      } else {
        myReportsQuery.forEach(doc => {
          const report = doc.data();
          myReportsHtml += renderReportItem(report, doc.id);
        });
      }
      
      document.getElementById('myReports').innerHTML = myReportsHtml;
      
      // Load other reports (if user is verified)
      if (userData.verified) {
        const otherReportsQuery = await db.collection('reports')
          .where('dusun', '==', userData.dusun)
          .where('userId', '!=', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .limit(10)
          .get();
        
        let otherReportsHtml = '';
        if (otherReportsQuery.empty) {
          otherReportsHtml = '<div class="muted">Belum ada laporan dari warga lain.</div>';
        } else {
          otherReportsQuery.forEach(doc => {
            const report = doc.data();
            otherReportsHtml += renderReportItem(report, doc.id);
          });
        }
        
        document.getElementById('otherReports').innerHTML = otherReportsHtml;
      } else {
        document.getElementById('otherReports').innerHTML = '<div class="muted">Verifikasi diperlukan untuk melihat laporan warga lain.</div>';
      }
    } catch (error) {
      console.error('Error loading reports:', error);
    }
  }

  function renderReportItem(report, id) {
    const date = report.createdAt ? report.createdAt.toDate().toLocaleDateString('id-ID') : 'Tanggal tidak tersedia';
    const time = report.createdAt ? report.createdAt.toDate().toLocaleTimeString('id-ID') : 'Waktu tidak tersedia';
    
    return `
      <div class="border rounded p-2 mb-2">
        <div class="d-flex justify-content-between">
          <div>
            <div><strong>${report.jenis}</strong></div>
            <div class="small">${report.lokasi}</div>
            <div class="small">${date} ${time}</div>
            <div class="small">Oleh: ${report.userName}</div>
          </div>
          <div>
            <span class="badge ${report.status === 'dilaporkan' ? 'bg-warning' : 'bg-success'}">${report.status}</span>
          </div>
        </div>
      </div>
    `;
  }

  // Pagination functions
  function changeMyReportsPage(direction) {
    myReportsPage += direction;
    if (myReportsPage < 1) myReportsPage = 1;
    document.getElementById('pageMyInfo').textContent = `Halaman ${myReportsPage}`;
    renderReportsFromCache();
  }

  function changeOtherReportsPage(direction) {
    otherReportsPage += direction;
    if (otherReportsPage < 1) otherReportsPage = 1;
    document.getElementById('pageOtherInfo').textContent = `Halaman ${otherReportsPage}`;
    renderReportsFromCache();
  }

  function changeLaporanPage(direction) {
    laporanPage += direction;
    if (laporanPage < 1) laporanPage = 1;
    document.getElementById('pageInfo').textContent = `Halaman ${laporanPage}`;
    loadLaporanData();
  }

  // Statistik functions
  async function loadStatistikData() {
    const bulan = document.getElementById('filterBulanStatistik').value;
    const tahun = document.getElementById('filterTahunStatistik').value;
    
    try {
      let query = db.collection('reports')
        .where('dusun', '==', userData.dusun);
      
      // Apply bulan filter if not "semua"
      if (bulan !== 'semua') {
        const startDate = new Date(tahun, bulan - 1, 1);
        const endDate = new Date(tahun, bulan, 1);
        
        query = query
          .where('createdAt', '>=', startDate)
          .where('createdAt', '<', endDate);
      }
      
      const querySnapshot = await query.get();
      
      // Count by jenis
      const counts = {};
      querySnapshot.forEach(doc => {
        const report = doc.data();
        counts[report.jenis] = (counts[report.jenis] || 0) + 1;
      });
      
      // Update chart
      updateStatistikChart(counts);
      
      // Update summary
      const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
      document.getElementById('statistikSummary').innerHTML = `
        <div class="alert alert-info">
          Total laporan: <strong>${total}</strong> dalam periode yang dipilih.
        </div>
      `;
    } catch (error) {
      console.error('Error loading statistik data:', error);
    }
  }

  function updateStatistikChart(counts) {
    const ctx = document.getElementById('chartStatistik').getContext('2d');
    
    // Destroy existing chart if any
    if (window.statistikChart) {
      window.statistikChart.destroy();
    }
    
    const labels = Object.keys(counts).map(key => {
      const jenisMap = {
        'kebakaran': 'Kebakaran',
        'kecelakaan': 'Kecelakaan',
        'kekerasan': 'Kekerasan',
        'bencana': 'Bencana',
        'kriminal': 'Kriminal',
        'medis': 'Medis',
        'lainnya': 'Lainnya'
      };
      return jenisMap[key] || key;
    });
    
    const data = Object.values(counts);
    
    window.statistikChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Jumlah Laporan',
          data: data,
          backgroundColor: [
            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
            '#8b5cf6', '#06b6d4', '#64748b'
          ],
          borderColor: [
            '#dc2626', '#d97706', '#059669', '#2563eb',
            '#7c3aed', '#0891b2', '#475569'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Statistik Laporan per Jenis Kejadian'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Laporan functions
  async function loadLaporanData() {
    try {
      let query = db.collection('reports')
        .where('dusun', '==', userData.dusun)
        .orderBy('createdAt', 'desc');
      
      // Apply filters
      if (laporanFilter.bulan !== 'semua') {
        const startDate = new Date(laporanFilter.tahun, laporanFilter.bulan - 1, 1);
        const endDate = new Date(laporanFilter.tahun, laporanFilter.bulan, 1);
        
        query = query
          .where('createdAt', '>=', startDate)
          .where('createdAt', '<', endDate);
      }
      
      // Apply jenis filter
      if (laporanFilter.jenis === 'saya') {
        query = query.where('userId', '==', currentUser.uid);
      } else if (laporanFilter.jenis === 'warga') {
        query = query.where('userId', '!=', currentUser.uid);
      }
      
      const querySnapshot = await query.get();
      
      let html = '';
      if (querySnapshot.empty) {
        html = '<div class="muted">Tidak ada laporan untuk filter yang dipilih.</div>';
      } else {
        querySnapshot.forEach(doc => {
          const report = doc.data();
          html += renderReportItem(report, doc.id);
        });
      }
      
      document.getElementById('laporanList').innerHTML = html;
    } catch (error) {
      console.error('Error loading laporan data:', error);
    }
  }

  // Profile functions
  function loadProfileData() {
    if (!userData) return;
    
    const profileContent = document.getElementById('profileContentPage');
    profileContent.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label"><strong>Nama</strong></label>
            <div>${userData.nama}</div>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Nomor HP</strong></label>
            <div>${userData.hp}</div>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Role</strong></label>
            <div>${userData.role}</div>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Status</strong></label>
            <div>${userData.status}</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label"><strong>Alamat</strong></label>
            <div>${userData.alamat}</div>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>RT/RW</strong></label>
            <div>RT ${userData.rt} / RW ${userData.rw}</div>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Blok/No</strong></label>
            <div>${userData.blok || '-'} / ${userData.no || '-'}</div>
          </div>
          <div class="mb-3">
            <label class="form-label"><strong>Dusun</strong></label>
            <div>${userData.dusun || 'Belum bergabung'}</div>
          </div>
        </div>
      </div>
    `;
  }

  // Modal functions for profile actions
  function showChangeRoleModal() {
    document.getElementById('changeRoleModal').classList.remove('hidden');
    document.getElementById('newRole').value = userData.status;
  }

  function hideChangeRoleModal() {
    document.getElementById('changeRoleModal').classList.add('hidden');
  }

  function showChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('hidden');
  }

  function hideChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.add('hidden');
  }

  function showDeleteAccountModal() {
    document.getElementById('deleteAccountModal').classList.remove('hidden');
  }

  function hideDeleteAccountModal() {
    document.getElementById('deleteAccountModal').classList.add('hidden');
  }

  async function updateRole() {
    const newRole = document.getElementById('newRole').value;
    
    try {
      await db.collection('users').doc(currentUser.uid).update({
        status: newRole
      });
      
      userData.status = newRole;
      Swal.fire('Sukses', 'Role berhasil diubah.', 'success');
      hideChangeRoleModal();
      loadProfileData();
    } catch (error) {
      console.error('Error updating role:', error);
      Swal.fire('Error', 'Gagal mengubah role.', 'error');
    }
  }

  async function updatePassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!newPassword || !confirmPassword) {
      Swal.fire('Error', 'Password dan konfirmasi password harus diisi.', 'error');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      Swal.fire('Error', 'Password dan konfirmasi password tidak cocok.', 'error');
      return;
    }
    
    if (newPassword.length < 6) {
      Swal.fire('Error', 'Password minimal 6 karakter.', 'error');
      return;
    }
    
    try {
      await currentUser.updatePassword(newPassword);
      Swal.fire('Sukses', 'Password berhasil diubah.', 'success');
      hideChangePasswordModal();
    } catch (error) {
      console.error('Error updating password:', error);
      Swal.fire('Error', 'Gagal mengubah password.', 'error');
    }
  }

  async function deleteAccount() {
    try {
      // Delete user data from Firestore
      await db.collection('users').doc(currentUser.uid).delete();
      
      // Delete user from Firebase Auth
      await currentUser.delete();
      
      Swal.fire('Sukses', 'Akun berhasil dihapus.', 'success');
      showAuth();
    } catch (error) {
      console.error('Error deleting account:', error);
      Swal.fire('Error', 'Gagal menghapus akun.', 'error');
    }
  }

  // UI functions
  function showAuth() {
    document.getElementById('authCard').classList.remove('hidden');
    document.getElementById('dashboardCard').classList.add('hidden');
    document.getElementById('bottomNav').classList.add('hidden');
  }

  function showDashboard() {
    document.getElementById('authCard').classList.add('hidden');
    document.getElementById('dashboardCard').classList.remove('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    
    // Update user info
    document.getElementById('display_name').textContent = userData.nama;
    document.getElementById('display_role').textContent = userData.role;
    document.getElementById('display_status').textContent = userData.status;
    
    // Show appropriate pages based on user role
    if (userData.role === 'kepala_dusun') {
      document.getElementById('createDusunCard').classList.remove('hidden');
    } else {
      document.getElementById('joinDusunCard').classList.remove('hidden');
    }
    
    // Initialize location option change handlers
    document.getElementById('lap_loc_opt').addEventListener('change', function() {
      document.getElementById('lap_lokasi').classList.toggle('hidden', this.value === 'rumah');
    });
    
    document.getElementById('lap_loc_opt_sos').addEventListener('change', function() {
      document.getElementById('lap_lokasi_sos').classList.toggle('hidden', this.value === 'rumah');
    });
  }

  function showPage(pageId) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(page => {
      page.classList.add('hidden');
    });
    
    // Show selected page
    document.getElementById(pageId).classList.remove('hidden');
    
    // Update bottom nav active state
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // Set active based on page
    const navMap = {
      'homePage': 0,
      'statistikPage': 1,
      'sosPage': 2,
      'laporanPage': 3,
      'profilePage': 4
    };
    
    if (navMap[pageId] !== undefined) {
      document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');
    }
    
    // Load data for specific pages
    if (pageId === 'statistikPage') {
      loadStatistikData();
    } else if (pageId === 'laporanPage') {
      loadLaporanData();
    }
  }

  // Utility functions
  function generateRandomCode(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Add these missing functions
  function regenerateKodeDusun() {
    // Implementation for regenerating dusun code
    console.log('Regenerate kode dusun');
  }

  function expireKodeNow() {
    // Implementation for expiring dusun code
    console.log('Expire kode dusun');
  }
</script>
</body>
</html>
